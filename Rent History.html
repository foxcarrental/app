<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n-key="rentHistoryTitle">سجل الإيجار</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <style>
    /* CSS from style.css goes here */
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #4cc9f0;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border: #dee2e6;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      color: var(--dark);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      margin-bottom: 30px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo i {
      font-size: 28px;
      color: var(--primary);
    }

    .logo h1 {
      font-weight: 700;
      font-size: 28px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .panel {
      display: grid;
      grid-template-columns: 1fr 1.5fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    @media (max-width: 768px) {
      .panel {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 30px;
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--light-gray);
    }

    .card-title i {
      font-size: 24px;
      color: var(--primary);
    }

    .card-title h2 {
      font-size: 22px;
      font-weight: 600;
      color: var(--dark);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--gray);
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 18px;
    }

    input, select, textarea { /* Added select and textarea to styling */
      width: 100%;
      padding: 14px 20px 14px 48px;
      border: 2px solid var(--light-gray);
      border-radius: 12px;
      font-size: 16px;
      transition: var(--transition);
      background: #fafbfc;
      appearance: none; /* Remove default select arrow */
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    textarea {
        padding: 14px 20px; /* Adjust padding for textarea */
        min-height: 80px;
        resize: vertical;
    }

    select {
        padding-right: 20px; /* Adjust padding for custom arrow */
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%20viewBox%3D%220%200%20292.4%20292.4%22%3E%3Cpath%20fill%3D%22%236c757d%22%20d%3D%22M287%20197.6L146.2%2056.8%205.4%20197.6c-6.8%206.8-6.8%2017.9%200%2024.7s17.9%206.8%2024.7%200L146.2%20106.2l116.1%20116.1c6.8%206.8%2017.9%206.8%2024.7%200s6.8-17.9%200-24.7z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 15px top 50%;
        background-size: 12px auto;
    }

    html[dir="rtl"] select {
        padding-left: 20px;
        padding-right: 48px;
        background-position: left 15px top 50%;
    }
    html[dir="rtl"] .input-with-icon i {
        left: unset;
        right: 15px;
    }
    html[dir="rtl"] input,
    html[dir="rtl"] select {
        padding: 14px 48px 14px 20px;
    }


    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .btn-group {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    button {
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-submit {
      background: var(--primary);
      color: white;
      flex: 1;
    }

    .btn-submit:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-reset {
      background: var(--light-gray);
      color: var(--gray);
    }
    /* New button styles for consistency */
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-2px);
    }
    .btn-info { /* Style for Rent button */
      background: #17a2b8;
      color: white;
    }
    .btn-info:hover {
        background: #138496;
        transform: translateY(-2px);
    }

    .btn-reset:hover {
      background: #e2e6ea;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
    }

    thead {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
    }

    th {
      padding: 18px 20px;
      text-align: left;
      font-weight: 600;
    }
    html[dir="rtl"] th {
      text-align: right;
    }

    th:first-child {
      border-top-left-radius: 16px;
    }
    html[dir="rtl"] th:first-child {
      border-top-left-radius: 0;
      border-top-right-radius: 16px;
    }

    th:last-child {
      border-top-right-radius: 16px;
    }
    html[dir="rtl"] th:last-child {
      border-top-right-radius: 0;
      border-top-left-radius: 16px;
    }

    td {
      padding: 16px 20px;
      border-bottom: 1px solid var(--light-gray);
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr {
      transition: var(--transition);
    }

    tr:hover {
      background-color: rgba(67, 97, 238, 0.03);
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    .btn-edit {
      background: #e9f7fe;
      color: var(--primary);
      padding: 8px 15px;
      border-radius: 8px;
    }

    .btn-edit:hover {
      background: #d4eeff;
    }

    .btn-delete {
      background: #fef2f2;
      color: #ef4444;
      padding: 8px 15px;
      border-radius: 8px;
    }

    .btn-delete:hover {
      background: #fee2e2;
    }

    .status-message {
      padding: 15px;
      border-radius: 12px;
      margin-top: 20px;
      display: none;
      font-weight: 500;
      transition: var(--transition);
    }

    .success {
      background: #f0fdf4;
      color: #16a34a;
      border: 1px solid #bbf7d0;
      display: block;
    }

    .error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
      display: block;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 60px;
      color: var(--light-gray);
      margin-bottom: 20px;
    }

    .empty-state p {
      font-size: 18px;
    }

    /* Styles for login form */
    #login-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
    }

    #login-card {
        padding: 40px;
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        background: white;
        width: 100%;
        max-width: 400px;
        text-align: center;
    }

    #login-card h2 {
        margin-bottom: 30px;
        color: var(--primary);
    }

    #login-card .form-group {
        text-align: left;
    }
    html[dir="rtl"] #login-card .form-group {
        text-align: right;
    }


    #login-card button {
        width: 100%;
        margin-top: 20px;
    }

    /* New styles for end date colors */
    .end-date-today {
      color: #28a745; /* Green for today's date */
      font-weight: 600;
    }

    /* Changed this from grey to red */
    .end-date-past {
      color: #dc3545; /* Red for past date */
      font-weight: 600; /* Added font-weight for consistency */
    }

    /* Changed this from red to default/neutral color */
    .end-date-future {
      color: var(--dark); /* Default text color for future date */
      font-weight: 400; /* Normal font weight */
    }

    /* Vehicle Summary styles */
    .vehicle-summary {
        display: flex;
        justify-content: space-around;
        align-items: center;
        background-color: #f0f4f8;
        padding: 15px 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }

    .summary-item {
        text-align: center;
        flex: 1;
        padding: 10px;
    }

    .summary-item i {
        font-size: 28px;
        margin-bottom: 8px;
    }

    .summary-item .count {
        font-size: 24px;
        font-weight: 700;
        display: block;
        margin-bottom: 5px;
    }

    .summary-item .label {
        font-size: 14px;
        color: var(--gray);
    }

    .available-icon {
        color: #28a745; /* Green */
    }

    .rented-icon {
        color: #ffc107; /* Orange/Yellow */
    }

    .maintenance-icon {
        color: #6c757d; /* Gray */
    }

    /* New style for total cars icon */
    .total-cars-icon {
        color: var(--primary); /* Use primary color for total cars */
    }
    /* Simple flexbox utilities for layout */
    .d-flex {
        display: flex;
    }
    .justify-content-between {
        justify-content: space-between;
    }
    .align-items-center {
        align-items: center;
    }
    .mb-4 {
        margin-bottom: 1.5rem; /* ~24px */
    }
    .me-2 {
        margin-right: 0.5rem; /* ~8px */
    }
    .mt-4 {
        margin-top: 1.5rem;
    }

    /* Modal Styles (kept for consistency in case user wants to re-add, but not used now) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px; /* Add some padding for smaller screens */
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative;
        width: 90%; /* Responsive width */
        max-width: 600px; /* Max width for larger screens */
        animation-name: animatetop;
        animation-duration: 0.4s;
    }
    html[dir="rtl"] .modal-content {
        text-align: right;
    }

    @keyframes animatetop {
        from {top: -300px; opacity: 0}
        to {top: 0; opacity: 1}
    }

    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 20px;
        cursor: pointer;
    }
    html[dir="rtl"] .close-button {
        right: unset;
        left: 20px;
        float: left;
    }

    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    /* Adjust padding for input-with-icon in modal form to prevent overflow */
    .modal-content .input-with-icon input,
    .modal-content .input-with-icon select {
        padding-left: 48px; /* Ensure icon has space */
        padding-right: 20px; /* Ensure space for select arrow */
    }
    html[dir="rtl"] .modal-content .input-with-icon input,
    html[dir="rtl"] .modal-content .input-with-icon select {
        padding-left: 20px;
        padding-right: 48px;
    }
    /* Ensure action buttons in modal are grouped nicely */
    .modal-content .btn-group {
        display: flex;
        justify-content: flex-end; /* Align buttons to the right */
        gap: 10px;
        margin-top: 25px;
    }
    html[dir="rtl"] .modal-content .btn-group {
        justify-content: flex-start; /* Align buttons to the left for RTL */
    }

    .modal-content .btn-group button {
        flex: unset; /* Remove flex: 1 property from submit button in modal */
        width: auto; /* Adjust width as needed for grouped buttons */
    }

    /* Tab styles */
    .tab-container {
        display: flex;
        margin-bottom: 20px;
        background-color: white;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        padding: 10px;
    }

    .tab-button {
        flex: 1;
        padding: 12px 20px;
        border: none;
        background-color: transparent;
        color: var(--gray);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .tab-button.active {
        background: linear-gradient(to right, var(--primary), var(--secondary));
        color: white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .tab-button:hover:not(.active) {
        background-color: var(--light-gray);
        color: var(--dark);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Customer search results dropdown */
    #customerSearchResults {
        border: 1px solid var(--border);
        max-height: 150px;
        overflow-y: auto;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-top: 5px;
        position: absolute; /* Position relative to its parent container */
        width: 100%;
        z-index: 1001; /* Ensure it's above other elements */
    }

    .search-result-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--light-gray);
    }
    .search-result-item:last-child {
        border-bottom: none;
    }
    .search-result-item:hover {
        background-color: var(--light-gray);
    }
    .search-result-item strong {
        color: var(--primary);
    }

    /* Styles for filter section */
    .filter-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 12px;
        border: 1px solid var(--light-gray);
    }
    .filter-section .form-group {
        margin-bottom: 0; /* Override default form-group margin */
    }
    .language-switcher {
        display: flex;
        gap: 10px;
        margin-right: 15px; /* Adjust as needed */
    }
    html[dir="rtl"] .language-switcher {
        margin-left: 15px;
        margin-right: 0;
    }
    .language-button {
        padding: 8px 15px;
        border-radius: 8px;
        border: 1px solid var(--primary);
        background-color: transparent;
        color: var(--primary);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    .language-button.active {
        background-color: var(--primary);
        color: white;
    }
    .language-button:hover:not(.active) {
        background-color: var(--primary);
        color: white;
        opacity: 0.8;
    }

    /* New form specific styles */
    .new-rental-form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* 3 columns, responsive */
        gap: 20px;
    }
    .new-rental-form-grid .form-group {
        margin-bottom: 0; /* Remove default margin as gap handles spacing */
    }

    /* Read-only input style */
    .readonly-input {
        background-color: #e9ecef;
        cursor: not-allowed;
    }
  </style>
</head>
<body dir="rtl">
  <!-- The login container is removed as per your request -->

  <div class="container" id="admin-panel" style="display: block;"> <!-- Admin panel is now displayed by default -->
    <header>
      <div class="logo">
        <i class="fas fa-car"></i>
        <h1 data-i18n-key="foxCarRentalTitle">لوحة تحكم Fox Car Rental</h1>
      </div>
      <div class="user-info">
        <div class="language-switcher">
            <button class="language-button" id="lang-ar" data-lang="ar">العربية</button>
            <button class="language-button" id="lang-en" data-lang="en">English</button>
        </div>
        <!-- User email and logout button removed as there's no login -->
      </div>
    </header>

    <!-- Tab Navigation -->
    <div class="tab-container">
        <a href="admin.html" class="tab-button">
            <i class="fas fa-car"></i> <span data-i18n-key="vehicleInventoryTab">مخزون المركبات</span>
        </a>
        <a href="admin.html" class="tab-button">
            <i class="fas fa-users"></i> <span data-i18n-key="customerListTab">قائمة العملاء</span>
        </a>
        <a href="Rent History.html" class="tab-button active">
            <i class="fas fa-history"></i> <span data-i18n-key="rentHistoryTab">سجل الإيجار</span>
        </a>
        <a href="Reports.html" class="tab-button">
            <i class="fas fa-chart-line"></i> <span data-i18n-key="reportsTab">التقارير</span>
        </a>
    </div>

    <!-- NEW Tab Content for Rent History -->
    <div id="rentHistoryTab" class="tab-content active">
        <div class="card mt-4">
            <div class="card-title">
                <i class="fas fa-history"></i>
                <h2 data-i18n-key="rentHistoryTitle">سجل الإيجار</h2>
            </div>
            <!-- Filter Section -->
            <div class="filter-section">
                <div class="form-group">
                    <label for="paymentStatusFilter" data-i18n-key="paymentStatusFilter">حالة الدفع:</label>
                    <div class="input-with-icon">
                        <i class="fas fa-credit-card"></i>
                        <select id="paymentStatusFilter">
                            <option value="All" data-i18n-key="paymentStatusAll">الكل</option>
                            <option value="Paid">مدفوع</option>
                            <option value="Partially Paid">مدفوع جزئياً</option>
                            <option value="Pending">معلق</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Rental Entry Form -->
        <div class="card mt-4" id="addNewRentalSection">
            <div class="card-title">
                <i class="fas fa-plus-circle"></i>
                <h2 data-i18n-key="addNewRentalTitle">إضافة سجل إيجار جديد</h2>
            </div>
            <div id="add-rental-status-message" class="status-message"></div>
            <form id="addNewRentalForm">
                <div class="new-rental-form-grid">
                    <div class="form-group">
                        <label for="newRentalCar" data-i18n-key="tableRentVehicle">المركبة:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-car"></i>
                            <select id="newRentalCar" required>
                                <option value="" data-i18n-key="selectVehicleOption">اختر مركبة</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalCustomer" data-i18n-key="tableRentCustomer">العميل:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user"></i>
                            <select id="newRentalCustomer" required>
                                <option value="" data-i18n-key="selectCustomerOption">اختر عميل</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalFromDate" data-i18n-key="tableRentFromDate">تاريخ البدء:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-calendar-alt"></i>
                            <input type="date" id="newRentalFromDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalEndDate" data-i18n-key="tableRentEndDate">تاريخ الانتهاء:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-calendar-alt"></i>
                            <input type="date" id="newRentalEndDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalInitialOdometer" data-i18n-key="initialOdometerLabel">عداد المسافة الأولي (كم):</label>
                        <div class="input-with-icon">
                            <i class="fas fa-tachometer-alt"></i>
                            <input type="number" id="newRentalInitialOdometer" min="0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalFinalOdometer" data-i18n-key="finalOdometerLabel">عداد المسافة النهائي (كم):</label>
                        <div class="input-with-icon">
                            <i class="fas fa-tachometer-alt"></i>
                            <input type="number" id="newRentalFinalOdometer" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalPricePerDay" data-i18n-key="tablePricePerDay">السعر / اليوم:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-dollar-sign"></i>
                            <input type="number" id="newRentalPricePerDay" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalPaidAmount" data-i18n-key="tablePaidAmount">المبلغ المدفوع:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-money-bill-wave"></i>
                            <input type="number" id="newRentalPaidAmount" step="0.01" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalPaymentStatus" data-i18n-key="tablePaymentStatus">حالة الدفع:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-credit-card"></i>
                            <select id="newRentalPaymentStatus" required>
                                <option value="Pending" data-i18n-key="paymentStatusPending">معلق</option>
                                <option value="Paid" data-i18n-key="paymentStatusPaid">مدفوع</option>
                                <option value="Partially Paid" data-i18n-key="paymentStatusPartiallyPaid">مدفوع جزئياً</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalStatus" data-i18n-key="statusLabel">الحالة:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-info-circle"></i>
                            <select id="newRentalStatus" required>
                                <option value="Ongoing" data-i18n-key="statusOngoing">جارية</option>
                                <option value="Completed" data-i18n-key="statusCompleted">مكتملة</option>
                                <option value="Cancelled" data-i18n-key="statusCancelled">ملغاة</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalTrafficFines" data-i18n-key="tableTrafficFines">المخالفات المرورية:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-money-check-alt"></i>
                            <input type="number" id="newRentalTrafficFines" step="0.01" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalCarRepair" data-i18n-key="tableCarRepair">تصليح السيارة:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-wrench"></i>
                            <input type="number" id="newRentalCarRepair" step="0.01" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRentalNotes" data-i18n-key="notesLabel">ملاحظات:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-sticky-note"></i>
                            <textarea id="newRentalNotes" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-save"></i> <span data-i18n-key="saveButton">حفظ</span>
                    </button>
                    <button type="button" class="btn-reset" id="clearNewRentalForm">
                        <i class="fas fa-times"></i> <span data-i18n-key="clearButton">مسح</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Edit Rental Record Section (formerly a modal) -->
        <div class="card mt-4" id="editRentalSection" style="display: none;">
            <div class="card-title">
                <i class="fas fa-edit"></i>
                <h2 data-i18n-key="editRentalRecordTitle">تعديل سجل الإيجار</h2>
            </div>
            <div id="edit-rental-status-message" class="status-message"></div>
            <form id="editRentalForm">
                <input type="hidden" id="editRentalId">
                <input type="hidden" id="editRentalCarId">

                <div class="new-rental-form-grid">
                    <div class="form-group">
                        <label data-i18n-key="tableRentVehicle">المركبة:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-car"></i>
                            <input type="text" id="editRentalVehicleDisplay" class="readonly-input" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label data-i18n-key="tableRentCustomer">العميل:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="editRentalCustomerDisplay" class="readonly-input" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label data-i18n-key="tableRentFromDate">تاريخ البدء:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-calendar-alt"></i>
                            <input type="date" id="editRentalFromDate" class="readonly-input" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label data-i18n-key="tableRentEndDate">تاريخ الانتهاء:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-calendar-alt"></i>
                            <input type="date" id="editRentalEndDate" class="readonly-input" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label data-i18n-key="initialOdometerLabel">عداد المسافة الأولي (كم):</label>
                        <div class="input-with-icon">
                            <i class="fas fa-tachometer-alt"></i>
                            <input type="number" id="editRentalInitialOdometer" class="readonly-input" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editRentalActualReturnDate" data-i18n-key="actualReturnDateLabel">تاريخ الإرجاع الفعلي:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-calendar-check"></i>
                            <input type="date" id="editRentalActualReturnDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editRentalFinalOdometer" data-i18n-key="finalOdometerLabel">عداد المسافة النهائي (كم):</label>
                        <div class="input-with-icon">
                            <i class="fas fa-tachometer-alt"></i>
                            <input type="number" id="editRentalFinalOdometer" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editRentalPricePerDay" data-i18n-key="tablePricePerDay">السعر / اليوم:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-dollar-sign"></i>
                            <input type="number" id="editRentalPricePerDay" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editRentalPaidAmount" data-i18n-key="tablePaidAmount">المبلغ المدفوع:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-money-bill-wave"></i>
                            <input type="number" id="editRentalPaidAmount" step="0.01" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editRentalPaymentStatus" data-i18n-key="tablePaymentStatus">حالة الدفع:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-credit-card"></i>
                            <select id="editRentalPaymentStatus" required>
                                <option value="Pending" data-i18n-key="paymentStatusPending">معلق</option>
                                <option value="Paid" data-i18n-key="paymentStatusPaid">مدفوع</option>
                                <option value="Partially Paid" data-i18n-key="paymentStatusPartiallyPaid">مدفوع جزئياً</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editRentalStatus" data-i18n-key="statusLabel">الحالة:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-info-circle"></i>
                            <select id="editRentalStatus" required>
                                <option value="Ongoing" data-i18n-key="statusOngoing">جارية</option>
                                <option value="Completed" data-i18n-key="statusCompleted">مكتملة</option>
                                <option value="Cancelled" data-i18n-key="statusCancelled">ملغاة</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editRentalTrafficFines" data-i18n-key="tableTrafficFines">المخالفات المرورية:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-money-check-alt"></i>
                            <input type="number" id="editRentalTrafficFines" step="0.01" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editRentalCarRepair" data-i18n-key="tableCarRepair">تصليح السيارة:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-wrench"></i>
                            <input type="number" id="editRentalCarRepair" step="0.01" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editRentalNotes" data-i18n-key="notesLabel">ملاحظات:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-sticky-note"></i>
                            <textarea id="editRentalNotes" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Calculated fields display -->
                <div class="new-rental-form-grid" style="margin-top: 20px; border-top: 1px solid var(--light-gray); padding-top: 20px;">
                    <div class="form-group">
                        <label data-i18n-key="calculatedRentedDaysLabel">أيام الإيجار المحسوبة:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-calendar-day"></i>
                            <input type="text" id="editRentalCalculatedRentedDays" class="readonly-input" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-i18n-key="calculatedTotalPriceLabel">إجمالي السعر المحسوب:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-dollar-sign"></i>
                            <input type="text" id="editRentalCalculatedTotalPrice" class="readonly-input" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-i18n-key="calculatedBalanceLabel">الرصيد المستحق المحسوب:</label>
                        <div class="input-with-icon">
                            <i class="fas fa-hand-holding-usd"></i>
                            <input type="text" id="editRentalCalculatedBalance" class="readonly-input" readonly>
                        </div>
                    </div>
                </div>


                <div class="btn-group">
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-save"></i> <span data-i18n-key="saveChangesButton">حفظ التغييرات</span>
                    </button>
                    <button type="button" class="btn-reset" id="cancelEditRentalForm">
                        <i class="fas fa-times"></i> <span data-i18n-key="cancelButton">إلغاء</span>
                    </button>
                </div>
            </form>
        </div>


        <div class="table-container mt-4">
            <table>
                <thead>
                    <tr>
                        <th data-i18n-key="tableRentVehicle">المركبة</th>
                        <th data-i18n-key="tableRentCustomer">العميل</th>
                        <th data-i18n-key="tableRentFromDate">تاريخ البدء</th>
                        <th data-i18n-key="tableRentEndDate">تاريخ الانتهاء</th>
                        <th data-i18n-key="tableRentedDays">أيام الإيجار</th>
                        <th data-i18n-key="tablePricePerDay">السعر / اليوم</th>
                        <th data-i18n-key="tableTotalPrice">إجمالي السعر</th>
                        <th data-i18n-key="tablePaidAmount">المبلغ المدفوع</th>
                        <th data-i18n-key="tableBalance">الرصيد</th>
                        <th data-i18n-key="tableActualReturnDate">تاريخ الإرجاع الفعلي</th>
                        <th data-i18n-key="tablePaymentStatus">حالة الدفع</th>
                        <th data-i18n-key="tableTrafficFines">المخالفات المرورية</th>
                        <th data-i18n-key="tableCarRepair">تصليح السيارة</th> <!-- NEW COLUMN: Car Repair -->
                        <th data-i18n-key="tableActions">الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="rentHistoryTableBody">
                    <!-- Rent history rows will be loaded here by JavaScript -->
                </tbody>
            </table>
        </div>
        <div id="rent-history-empty-state" class="empty-state" style="display: none;">
            <i class="fas fa-clipboard-list"></i>
            <p data-i18n-key="noRentalHistoryEmpty">لم يتم العثور على سجل إيجار.</p>
        </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://yzwfldypkwqndxjchgit.supabase.co';
    // Corrected SUPABASE_KEY to its full value
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6d2ZsZHlwa3dxbmR4amNoZ2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzMjA0OTUsImV4cCI6MjA2NDg5NjQ5NX0.i3HOii7L9mJ-cBZ2us3TRmS0-GI9bylHuLe9INAu4zY';

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // Rent History tab elements
    const rentHistoryTableBody = document.getElementById('rentHistoryTableBody');
    const rentHistoryEmptyState = document.getElementById('rent-history-empty-state');

    // Filter elements for Rent History
    const paymentStatusFilterSelect = document.getElementById('paymentStatusFilter');

    // Language switcher elements
    const langArBtn = document.getElementById('lang-ar');
    const langEnBtn = document.getElementById('lang-en');

    // New Rental Form elements
    const addNewRentalSection = document.getElementById('addNewRentalSection'); // New: Reference to the section
    const addNewRentalForm = document.getElementById('addNewRentalForm');
    const addRentalStatusMessage = document.getElementById('add-rental-status-message');
    const newRentalCarSelect = document.getElementById('newRentalCar');
    const newRentalCustomerSelect = document.getElementById('newRentalCustomer');
    const newRentalFromDateInput = document.getElementById('newRentalFromDate');
    const newRentalEndDateInput = document.getElementById('newRentalEndDate');
    const newRentalInitialOdometerInput = document.getElementById('newRentalInitialOdometer');
    const newRentalFinalOdometerInput = document.getElementById('newRentalFinalOdometer'); // Added
    const newRentalPricePerDayInput = document.getElementById('newRentalPricePerDay');
    const newRentalPaidAmountInput = document.getElementById('newRentalPaidAmount');
    const newRentalPaymentStatusSelect = document.getElementById('newRentalPaymentStatus');
    const newRentalStatusSelect = document.getElementById('newRentalStatus');
    const newRentalTrafficFinesInput = document.getElementById('newRentalTrafficFines'); // Added
    const newRentalCarRepairInput = document.getElementById('newRentalCarRepair'); // Added
    const newRentalNotesTextarea = document.getElementById('newRentalNotes');
    const clearNewRentalFormButton = document.getElementById('clearNewRentalForm');

    // Edit Rental Section elements (formerly Modal)
    const editRentalSection = document.getElementById('editRentalSection'); // New: Reference to the section
    const editRentalForm = document.getElementById('editRentalForm');
    const editRentalStatusMessage = document.getElementById('edit-rental-status-message');
    const editRentalIdInput = document.getElementById('editRentalId');
    const editRentalCarIdInput = document.getElementById('editRentalCarId'); // Hidden input to store car_id for update
    const editRentalVehicleDisplay = document.getElementById('editRentalVehicleDisplay');
    const editRentalCustomerDisplay = document.getElementById('editRentalCustomerDisplay');
    const editRentalFromDateInput = document.getElementById('editRentalFromDate');
    const editRentalEndDateInput = document.getElementById('editRentalEndDate');
    const editRentalInitialOdometerInput = document.getElementById('editRentalInitialOdometer');
    const editRentalActualReturnDateInput = document.getElementById('editRentalActualReturnDate');
    const editRentalFinalOdometerInput = document.getElementById('editRentalFinalOdometer');
    const editRentalPricePerDayInput = document.getElementById('editRentalPricePerDay');
    const editRentalPaidAmountInput = document.getElementById('editRentalPaidAmount');
    const editRentalPaymentStatusSelect = document.getElementById('editRentalPaymentStatus');
    const editRentalStatusSelect = document.getElementById('editRentalStatus');
    const editRentalTrafficFinesInput = document.getElementById('editRentalTrafficFines');
    const editRentalCarRepairInput = document.getElementById('editRentalCarRepair');
    const editRentalNotesTextarea = document.getElementById('editRentalNotes');
    const editRentalCalculatedRentedDays = document.getElementById('editRentalCalculatedRentedDays');
    const editRentalCalculatedTotalPrice = document.getElementById('editRentalCalculatedTotalPrice');
    const editRentalCalculatedBalance = document.getElementById('editRentalCalculatedBalance');
    const cancelEditRentalFormButton = document.getElementById('cancelEditRentalForm');


    // Translation object
    const translations = {
        adminPanelTitle: { ar: 'لوحة تحكم المسؤول الحديثة', en: 'Modern Admin Panel' },
        adminLoginTitle: { ar: 'تسجيل دخول المسؤول', en: 'Admin Login' },
        emailLabel: { ar: 'البريد الإلكتروني', en: 'Email' },
        emailPlaceholder: { ar: 'أدخل بريدك الإلكتروني', en: 'Enter your email' },
        passwordLabel: { ar: 'كلمة المرور', en: 'Password' },
        passwordPlaceholder: { ar: 'أدخل كلمة المرور', en: 'Enter your password' },
        loginButton: { ar: 'تسجيل الدخول', en: 'Login' },
        foxCarRentalTitle: { ar: 'لوحة تحكم Fox Car Rental', en: 'Fox Car Rental Admin Panel' },
        logoutButton: { ar: 'تسجيل الخروج', en: 'Logout' },
        addNewCustomerButton: { ar: 'إضافة عميل جديد', en: 'Add New Customer' },
        vehicleInventoryTab: { ar: 'مخزون المركبات', en: 'Vehicle Inventory' },
        customerListTab: { ar: 'قائمة العملاء', en: 'Customer List' },
        rentHistoryTab: { ar: 'سجل الإيجار', en: 'Rent History' },
        reportsTab: { ar: 'التقارير', en: 'Reports' }, // NEW: Reports tab translation
        addUpdateVehicleTitle: { ar: 'إضافة / تحديث مركبة', en: 'Add / Update Vehicle' },
        makeLabel: { ar: 'صنع المركبة', en: 'Vehicle Make' },
        selectMake: { ar: 'اختر الصنع', en: 'Select Make' },
        modelLabel: { ar: 'موديل المركبة', en: 'Vehicle Model' },
        selectModel: { ar: 'اختر الموديل', en: 'Select Model' },
        plateNumberLabel: { ar: 'رقم اللوحة', en: 'License Plate' },
        plateNumberPlaceholder: { ar: 'أدخل رقم لوحة المركبة', en: 'Enter license plate number' },
        yearLabel: { ar: 'السنة', en: 'Year' },
        yearPlaceholder: { ar: 'أدخل سنة الصنع', en: 'Enter manufacturing year' },
        colorLabel: { ar: 'اللون', en: 'Color' },
        colorPlaceholder: { ar: 'أدخل لون المركبة', en: 'Enter vehicle color' },
        priceLabel: { ar: 'السعر', en: 'Price' },
        pricePlaceholder: { ar: 'أدخل السعر', en: 'Enter price' },
        statusLabel: { ar: 'الحالة', en: 'Status' },
        selectStatus: { ar: 'اختر الحالة', en: 'Select Status' },
        availableStatus: { ar: 'متاحة', en: 'Available' },
        rentedStatus: { ar: 'مؤجرة', en: 'Rented' },
        maintenanceStatus: { ar: 'تحت الصيانة', en: 'Under Maintenance' },
        fromDateLabel: { ar: 'تاريخ البدء', en: 'From Date' },
        endDateLabel: { ar: 'تاريخ الانتهاء', en: 'End Date' },
        featuresLabel: { ar: 'الميزات', en: 'Features' },
        featuresPlaceholder: { ar: 'أدخل ميزات المركبة (مفصولة بفاصلة)', en: 'Enter vehicle features (comma-separated)' },
        fuelLabel: { ar: 'مستوى الوقود (%)', en: 'Fuel Level (%)' },
        fuelPlaceholder: { ar: 'أدخل مستوى الوقود (0-100)', en: 'Enter fuel level (0-100)' },
        odometerLabel: { ar: 'عداد المسافة (كم)', en: 'Odometer (KM)' },
        odometerPlaceholder: { ar: 'أدخل إجمالي الكيلومترات المقطوعة', en: 'Enter total kilometers driven' },
        picUrlLabel: { ar: 'رابط الصورة', en: 'Picture URL' },
        picUrlPlaceholder: { ar: 'أدخل رابط صورة المركبة', en: 'Enter vehicle picture URL' },
        submitButton: { ar: 'إرسال', en: 'Submit' },
        resetButton: { ar: 'إعادة تعيين', en: 'Reset' },
        vehicleInventoryTitle: { ar: 'مخزون المركبات', en: 'Vehicle Inventory' },
        totalCars: { ar: 'إجمالي السيارات', en: 'Total Cars' },
        availableCars: { ar: 'متاحة', en: 'Available' },
        rentedCars: { ar: 'مؤجرة', en: 'Rented' },
        underMaintenanceCars: { ar: 'تحت الصيانة', en: 'Under Maintenance' },
        tableMake: { ar: 'الصنع', en: 'Make' },
        tableModel: { ar: 'الموديل', en: 'Model' },
        tableLicensePlate: { ar: 'رقم اللوحة', en: 'License Plate' },
        tableYear: { ar: 'السنة', en: 'Year' },
        tableColor: { ar: 'اللون', en: 'Color' },
        tablePrice: { ar: 'السعر', en: 'Price' },
        tableStatus: { ar: 'الحالة', en: 'Status' },
        tableFromDate: { ar: 'تاريخ البدء', en: 'From Date' },
        tableEndDate: { ar: 'تاريخ الانتهاء', en: 'End Date' },
        tableFeatures: { ar: 'الميزات', en: 'Features' },
        tableFuelLevel: { ar: 'مستوى الوقود', en: 'Fuel Level' },
        tableOdometer: { ar: 'عداد المسافة (كم)', en: 'Odometer (KM)' },
        tablePicture: { ar: 'الصورة', en: 'Picture' },
        tableActions: { ar: 'الإجراءات', en: 'Actions' },
        rentButton: { ar: 'تأجير', en: 'Rent' },
        editButton: { ar: 'تعديل', en: 'Edit' },
        deleteButton: { ar: 'حذف', en: 'Delete' },
        noVehiclesFound: { ar: 'لم يتم العثور على مركبات. أضف مركبتك الأولى!', en: 'No vehicles found. Add your first vehicle!' },
        accessDenied: { ar: 'تم رفض الوصول أو لم يتم العثور على مركبات مطابقة لأذوناتك.', en: 'Access denied or no vehicles found matching your permissions.' },
        customerListTitle: { ar: 'قائمة العملاء', en: 'Customer List' },
        customerName: { ar: 'اسم العميل', en: 'Customer Name' },
        customerEmail: { ar: 'البريد الإلكتروني', en: 'Email' },
        customerPhone: { ar: 'رقم الهاتف', en: 'Phone' },
        customerLicenseNo: { ar: 'رقم الرخصة', en: 'License No.' },
        customerExpiry: { ar: 'تاريخ الانتهاء', en: 'Expiry' },
        customerDOB: { ar: 'تاريخ الميلاد', en: 'DOB' },
        noCustomersFoundEmpty: { ar: 'لم يتم العثور على عملاء. أضف عميلك الأول!', en: 'No customers found. Add your first customer!' },
        rentHistoryTitle: { ar: 'سجل الإيجار', en: 'Rent History' },
        vehicleFilter: { ar: 'المركبة:', en: 'Vehicle:' },
        customerFilter: { ar: 'العميل:', en: 'Customer:' },
        paymentStatusFilter: { ar: 'حالة الدفع:', en: 'Payment Status:' },
        paymentStatusAll: { ar: 'الكل', en: 'All' },
        paymentStatusPaid: { ar: 'مدفوع', en: 'Paid' },
        paymentStatusPartiallyPaid: { ar: 'مدفوع جزئياً', en: 'Partially Paid' },
        paymentStatusPending: { ar: 'معلق', en: 'Pending' },
        tableRentVehicle: { ar: 'المركبة', en: 'Vehicle' },
        tableRentCustomer: { ar: 'العميل', en: 'Customer' },
        tableRentFromDate: { ar: 'تاريخ البدء', en: 'From Date' },
        tableRentEndDate: { ar: 'تاريخ الانتهاء', en: 'End Date' },
        tableRentedDays: { ar: 'أيام الإيجار', en: 'Rented Days' },
        tablePricePerDay: { ar: 'السعر / اليوم', en: 'Price / Day' },
        tableTotalPrice: { ar: 'إجمالي السعر', en: 'Total Price' },
        tablePaidAmount: { ar: 'المبلغ المدفوع', en: 'Paid Amount' },
        tableBalance: { ar: 'الرصيد', en: 'Balance' },
        tableActualReturnDate: { ar: 'تاريخ الإرجاع الفعلي', en: 'Actual Return Date' },
        tablePaymentStatus: { ar: 'حالة الدفع', en: 'Payment Status' },
        tableTrafficFines: { ar: 'المخالفات المرورية', en: 'Traffic Fines' },
        tableCarRepair: { ar: 'تصليح السيارة', en: 'Car Repair' },
        noRentalHistoryEmpty: { ar: 'لم يتم العثور على سجل إيجار.', en: 'No rental history found.' },
        addCustomerModalTitle: { ar: 'إضافة عميل جديد', en: 'Add New Customer' },
        firstNameLabel: { ar: 'الاسم الأول', en: 'First Name' },
        firstNamePlaceholder: { ar: 'أدخل الاسم الأول', en: 'Enter first name' },
        lastNameLabel: { ar: 'اسم العائلة', en: 'Last Name' },
        lastNamePlaceholder: { ar: 'أدخل اسم العائلة', en: 'Enter last name' },
        emailLabelCustomer: { ar: 'البريد الإلكتروني', en: 'Email' },
        emailPlaceholderCustomer: { ar: 'أدخل البريد الإلكتروني', en: 'Enter email' },
        phoneLabel: { ar: 'رقم الهاتف', en: 'Phone Number' },
        phonePlaceholder: { ar: 'أدخل رقم الهاتف', en: 'Enter phone number' },
        addressLabel: { ar: 'العنوان', en: 'Address' },
        addressPlaceholder: { ar: 'أدخل العنوان', en: 'Enter address' },
        cityLabel: { ar: 'المدينة', en: 'City' },
        cityPlaceholder: { ar: 'أدخل المدينة', en: 'Enter city' },
        countryLabel: { ar: 'البلد', en: 'Country' },
        countryPlaceholder: { ar: 'أدخل البلد', en: 'Enter country' },
        licenseNumberLabel: { ar: 'رقم رخصة القيادة', en: 'Driver License Number' },
        licenseNumberPlaceholder: { ar: 'أدخل رقم رخصة القيادة', en: 'Enter driver license number' },
        licenseExpiryLabel: { ar: 'تاريخ انتهاء الرخصة', en: 'License Expiry Date' },
        dobLabel: { ar: 'تاريخ الميلاد', en: 'Date of Birth' },
        addCustomerButton: { ar: 'إضافة عميل', en: 'Add Customer' },
        cancelButton: { ar: 'إلغاء', en: 'Cancel' },
        rentVehicleTitle: { ar: 'تأجير مركبة', en: 'Rent Vehicle' },
        vehicleInfoLabel: { ar: 'المركبة:', en: 'Vehicle:' },
        selectCustomerLabel: { ar: 'اختر العميل (بحث بالبريد الإلكتروني/الهوية):', en: 'Select Customer (Search by Email/ID):' },
        searchCustomerPlaceholder: { ar: 'بحث عن عميل...', en: 'Search customer...' },
        selectedCustomerInfoText: { ar: 'العميل المحدد:', en: 'Selected Customer:' },
        rentedDaysLabel: { ar: 'أيام الإيجار:', en: 'Rented Days:' },
        rentalPricePerDayLabel: { ar: 'سعر الإيجار اليومي:', en: 'Rental Price per Day:' },
        totalPriceLabel: { ar: 'إجمالي السعر:', en: 'Total Price:' },
        paidAmountLabel: { ar: 'المبلغ المدفوع:', en: 'Paid Amount:' },
        paidAmountPlaceholder: { ar: 'أدخل المبلغ المدفوع', en: 'Enter paid amount' },
        balanceDueLabel: { ar: 'الرصيد المستحق:', en: 'Balance Due:' },
        confirmRentalButton: { ar: 'تأكيد الإيجار', en: 'Confirm Rental' },
        editRentalRecordTitle: { ar: 'تعديل سجل الإيجار', en: 'Edit Rental Record' },
        actualReturnDateLabel: { ar: 'تاريخ الإرجاع الفعلي', en: 'Actual Return Date' },
        actualOdometerLabel: { ar: 'عداد المسافة الفعلي (كم)', en: 'Actual Odometer (KM)' },
        actualOdometerPlaceholder: { ar: 'أدخل عداد المسافة الفعلي', en: 'Enter actual odometer' },
        trafficFinesLabel: { ar: 'المخالفات المرورية', en: 'Traffic Fines' },
        trafficFinesPlaceholder: { ar: 'أدخل قيمة المخالفات المرورية', en: 'Enter traffic fines value' },
        carRepairLabel: { ar: 'تصليح السيارة', en: 'Car Repair' },
        carRepairPlaceholder: { ar: 'أدخل تكلفة تصليح السيارة', en: 'Enter car repair cost' },
        calculatedRentedDaysLabel: { ar: 'أيام الإيجار المحسوبة:', en: 'Calculated Rented Days:' },
        calculatedTotalPriceLabel: { ar: 'إجمالي السعر المحسوب:', en: 'Calculated Total Price:' },
        calculatedBalanceLabel: { ar: 'الرصيد المستحق المحسوب:', en: 'Calculated Balance Due:' },
        saveChangesButton: { ar: 'حفظ التغييرات', en: 'Save Changes' },
        statusMessageCarReset: { ar: 'تم إعادة تعيين نموذج السيارة', en: 'Car form has been reset' },
        statusMessageErrorFetchingMakes: { ar: 'خطأ في جلب الشركات المصنعة:', en: 'Error fetching makes:' },
        statusMessageErrorFetchingModels: { ar: 'خطأ في جلب الموديلات:', en: 'Error fetching models:' },
        statusMessageErrorFetchingVehicles: { ar: 'خطأ في جلب المركبات:', en: 'Error fetching vehicles:' },
        statusMessageAccessDenied: { ar: 'تم رفض الوصول أو لم يتم العثور على مركبات مطابقة لأذوناتك.', en: 'Access denied or no vehicles found matching your permissions.' },
        statusMessageNoVehiclesFound: { ar: 'لم يتم العثور على مركبات. أضف مركبتك الأولى!', en: 'No vehicles found. Add your first vehicle!' },
        statusMessageVehicleLoadedForEdit: { ar: 'تم تحميل المركبة للتعديل', en: 'Vehicle loaded for editing' },
        confirmDeleteVehicle: { ar: 'هل أنت متأكد أنك تريد حذف هذه المركبة؟', en: 'Are you sure you want to delete this vehicle?' },
        statusMessageErrorDeletingVehicle: { ar: 'خطأ في حذف المركبة:', en: 'Error deleting vehicle:' },
        statusMessageVehicleDeleted: { ar: 'تم حذف المركبة بنجاح!', en: 'Vehicle deleted successfully!' },
        statusMessageErrorGeneric: { ar: 'خطأ:', en: 'Error:' },
        statusMessageVehicleUpdated: { ar: 'تم تحديث المركبة بنجاح!', en: 'Vehicle updated successfully!' },
        statusMessageVehicleAdded: { ar: 'تمت إضافة المركبة بنجاح!', en: 'Vehicle added successfully!' },
        statusMessageLoginError: { ar: 'خطأ في تسجيل الدخول:', en: 'Login Error:' },
        statusMessageLoginSuccess: { ar: 'تم تسجيل الدخول بنجاح!', en: 'Login Successful!' },
        statusMessageUnauthorizedUser: { ar: 'مستخدم غير مصرح به. الرجاء تسجيل الدخول باستخدام حساب المسؤول الصحيح.', en: 'Unauthorized user. Please log in with the correct admin account.' },
        statusMessageLogoutError: { ar: 'خطأ في تسجيل الخروج:', en: 'Logout Error:' },
        statusMessageLoggedOut: { ar: 'تم تسجيل الخروج بنجاح!', en: 'Logged out successfully!' },
        statusMessageCustomerAddError: { ar: 'خطأ في إضافة العميل:', en: 'Error adding customer:' },
        statusMessageCustomerAdded: { ar: 'تمت إضافة العميل بنجاح!', en: 'Customer added successfully!' },
        statusMessageErrorLoadingCustomers: { ar: 'خطأ في تحميل العملاء.', en: 'Error loading customers.' },
        statusMessageProcessingRental: { ar: 'جاري معالجة الإيجار...', en: 'Processing rental...' },
        statusMessageSelectCustomer: { ar: 'الرجاء اختيار عميل.', en: 'Please select a customer.' },
        statusMessageEndDateBeforeFromDate: { ar: 'تاريخ الانتهاء لا يمكن أن يكون قبل تاريخ البدء.', en: 'End date cannot be before from date.' },
        statusMessageRentalDuration: { ar: 'يجب أن تكون مدة الإيجار يومًا واحدًا على الأقل.', en: 'Rental duration must be at least one day.' },
        statusMessageErrorRecordingRental: { ar: 'خطأ في تسجيل الإيجار:', en: 'Error recording rental:' },
        statusMessageRentalSuccess: { ar: 'تم تأجير المركبة بنجاح!', en: 'Vehicle rented successfully!' },
        statusMessageCarUpdateFailed: { ar: 'تم تسجيل الإيجار، ولكن فشل تحديث حالة السيارة: ', en: 'Rental recorded, but failed to update car status: ' },
        statusMessageErrorFetchingRentHistory: { ar: 'خطأ في تحميل سجل الإيجار.', en: 'Error loading rental history.' },
        statusMessageSavingChanges: { ar: 'جاري حفظ التغييرات...', en: 'Saving changes...' },
        statusMessageErrorUpdatingRental: { ar: 'خطأ في تحديث سجل الإيجار:', en: 'Error updating rental record:' },
        statusMessageRentalUpdated: { ar: 'تم تحديث سجل الإيجار بنجاح!', en: 'Rental record updated successfully!' },
        statusMessageRentalCarUpdateFailed: { ar: 'تم تحديث الإيجار، ولكن فشل تحديث حالة السيارة:', en: 'Rental updated, but failed to update car status:' },
        selectMakeModel: { ar: 'الرجاء اختيار كل من الصنع والموديل.', en: 'Please select both Make and Model.'},
        noImage: { ar: 'لا توجد صورة', en: 'No Image' },
        n_a: { ar: 'N/A', en: 'N/A' },
        reportsTitle: { ar: 'التقارير', en: 'Reports' },
        report1: { ar: 'تقرير 1: الإيجارات المستمرة', en: 'Report 1: Ongoing Rentals' },
        report2: { ar: 'تقرير 2', en: 'Report 2' },
        noReportsFound: { ar: 'لا توجد تقارير متاحة.', en: 'No reports available.' },
        report1Title: { ar: 'تقرير 1: الإيجارات المستمرة', en: 'Report 1: Ongoing Rentals' },
        tableReport1Vehicle: { ar: 'المركبة', en: 'Vehicle' },
        tableReport1Customer: { ar: 'العميل', en: 'Customer' },
        tableReport1FromDate: { ar: 'تاريخ البدء', en: 'From Date' },
        tableReport1RentedDaysDynamic: { ar: 'أيام الإيجار (حتى اليوم)', en: 'Rented Days (To Date)' },
        tableReport1PricePerDay: { ar: 'السعر / اليوم', en: 'Price / Day' },
        tableReport1PaidAmount: { ar: 'المبلغ المدفوع', en: 'Paid Amount' },
        tableReport1OutstandingBalance: { ar: 'الرصيد المستحق (حتى اليوم)', en: 'Outstanding Balance (To Date)' }, // Changed key and translation
        noReport1Data: { ar: 'لا توجد بيانات لتقرير 1.', en: 'No data available for Report 1.' },
        // NEW TRANSLATIONS FOR DISCLAIMER TEXT
        disclaimerTitle: { ar: 'ملاحظات هامة:', en: 'Important Notes:' },
        disclaimer1: { ar: 'المسافة المسموح بها للتأجير اليومي 250 كيلومتر والشهري 5000 كيلومتر وكل كيلومتر زيادة يحسب بـ 50 فلس. 1 ساعة تأخير تحسب بـ 20 درهم وأكثر من 5 ساعات تحسب يوم كامل.', en: ' Allowable distance of 250 kilometers daily and monthly 5000 kilometers. Every extra kilometer is calculated at 50 fils per kilo. 1 hour delay is calculated at 20 AED and more than 5 hours calculates a full day.' },
        disclaimer2: { ar: 'لا يحق للمستأجر المطالبة بأي أغراض بعد تسليم السيارة.', en: ' The hirer shall not claim any thing (valuables) after the delivery of the car.' },
        disclaimer3: { ar: 'وضع لاصق على السيارة مسؤولية السائق والمسـتأجر وملكية السيارة الأصلية لدى المستأجر.', en: ' Put glass tinting (black papers) hires\'s own responsibility & original vehicle license with hirer.' },
        disclaimer4: { ar: 'على أساس أسبوعي وشهري، يطلب من العملاء إحضار السيارة مرة واحدة على الأقل كل 7 أيام في المكتب لفحص الزيت والمياه، وإلا سيكون العميل مسؤولاً عن أي ضرر يلحق بالمحرك.', en: ' On a weekly and monthly basis, customers are required to bring the car at least once after every 7 days at the Office for Oil and Water inspection, otherwise the customer will be liable for any damage to the engine.' },
        // NEW TRANSLATIONS FOR MAIN CONDITIONS
        mainConditionsTitle: { ar: 'الشروط الرئيسية:', en: 'MAIN CONDITIONS:' },
        mainCondition1: { ar: 'استلمت السيارة و فحصتها شخصياً و هي بحالة جيدة و سليمة تماماً و ألتزم بإرجاع السيارة بنفس الحالة. المكتب غير مسؤول عن أي تلف أو ضرر يلحق بالسيارة بعد تسليمها للعميل.', en: ' I received the vehicle after complete check and found the vehicle in good condition. I will be fully responsible if any damage happens to the vehicle. The office will not receive the vehicle if the vehicle is not in good condition. It was handed over to the customer. In accordance to the agreed agreement conditions the rent will continue till the car receive in good condition.' },
        mainCondition2: { ar: 'أنا كفيل و ضامن لكل الالتزامات المترتبة على هذا العقد و يحق لي في كل الأغراض ما سبق في ذمة المستأجر من مبلغ و كيلومترات و ما يلحق به من أضرار و هذه كفالة مني و ضمانة.', en: ' I as a sponsor & guarantor agree to all conditions and declare that I will pay all the balance amount due from the hirer. The rent office have all the rights to receive their dues from me by any way and any means.' },
        mainCondition3: { ar: 'يدفع المستأجر قيمة الاصلاح كاملة داخل الوكالة في حالة أي حادث للمركبة إذا كان عمره أقل من 20 عام و 20% من قيمة سعر الإصلاح إذا كان عمره أكثر من 20 عام. و يحسب حسب شروط شركة التأمين و مكان التأمين في الوكالة.', en: ' The hirer should pay all repair charges of the agency if he/she is less than 20 years of age, and 20% from the total invoice amount if his/she driving licenses has not completed one year.' },
        mainCondition4: { ar: 'لا يحق للمستأجر قيمة الوقت الفاتح عن الحادثة لغاية خروج السيارة من الكراج أو الوكالة و الأضرار و الغرامات و أي شيء آخر.', en: ' Hirer should pay full rent for the period relating to the accident till the delivery from the garage, agency or police & all other departments either he/she involved direct or damaged by others indirect in the accident according to the civil affairs rules no. 2828-292.' },
        mainCondition5: { ar: 'في حالة وقوع حادث، يجب على المستأجر دفع 1700 درهم إماراتي كرسوم إدارية بالإضافة إلى أي تكاليف إصلاح أو غرامات مرورية. و يحق للمستأجر المطالبة بأي تأخير في تسليم المركبة.', en: ' In case of accident the hirer should pay Dhs. 1700 as office expense charges addition to the insurance or repair charges and should submit all required documents related to the accident from insurance claim. The hirer will also be responsible for compensating the delay compensation during the repairing period of the vehicle.' },
        mainCondition6: { ar: 'إذا كان السائق وقت الحادث أقل من 25 سنة و كانت رخصة القيادة صادرة أقل من سنة، يكون المستأجر و الكفيل مسؤولان عن الحادث و أي أضرار أخرى تحدث للمركبة. و في حال تلف السيارة، يتحمل المستأجر قيمة بوليصة التأمين مع أي مبلغ تقوم به شركة التأمين.', en: ' In insurance or his driving license was issued within the period of less than one year in that case the hirer and guarantor will be jointly responsible for the accident and the arising damages if any.  The hirer shall in case of total loss of the car, pay the cost of insurance policy and any amount that the insurance company shall discount according to its conditions plus the full daily rate of the day spent at court if any.' },
        mainCondition7: { ar: 'في حال سحب السيارة من قبل المكتب، يتم دفع غرامة تأخير يومية عن كل يوم تأخير في تسليم السيارة.', en: ' In case of total loss of the car, pay the cost of insurance policy and any amount that the insurance company shall discount according to its conditions plus the full daily rate of the day spent at court if any.' }, // This was duplicated, fixed.
        mainCondition8: { ar: 'كما أقر المستأجر على أن تسليم جواز سفره للمكتب تم وفقاً لشروط المكتب و تعهد بتقديم مطالبة بالجواز و إعادة السيارة بعد 7 أيام من تاريخ تسليم السيارة.', en: ' Hirer also agreed that passport delivery to the office was according to the office conditions and pledged to provide passport claim and return the car after 7 days from the date of car delivery.' },
        // NEW TRANSLATIONS FOR RENTAL AGREEMENT TERMS AND CONDITIONS (PAGE 2)
        rentalTermsTitle: { ar: 'عقد إستئجار - البنود والشروط', en: 'Rental Agreement - Terms and Conditions' },
        rentalTerm1: { ar: 'على المستأجر إعادة السيارة مع كافة الإطارات وثائق السيارة الإضافات والمعدات الى مقر الشركة في الشارقة أو أي مكان آخر يحدده المؤجر.', en: 'The tenant must return the car with all tires, car documents, additions, and equipment to the company\'s headquarters in Sharjah or any other location specified by the lessor.' },
        rentalTerm2: { ar: 'استلم المستأجر السيارة بحالة ووضع جيدين، وهو مسؤول عن تكاليف الوقود المستهلك خلال فترة الاستئجار.', en: 'The tenant received the car in good condition and is responsible for fuel costs consumed during the rental period.' },
        rentalTerm3: { ar: 'لا يسمح بقيادة السيارة إلا لمن يحمل رخصة قيادة صادرة من الإمارات العربية المتحدة أو من دول مجلس التعاون.', en: 'The car is only allowed to be driven by individuals holding a driving license issued by the UAE or GCC countries.' },
        rentalTerm4: { ar: 'لا يسمح بقيادة السيارة:', en: 'The car is not allowed to be driven:' },
                rentalTerm4a: { ar: 'في نقل بضائع يكون نقلها انتهاك لأنظمة الجمارك أو في أي عمل آخر غير قانوني.', en: ' For transporting goods whose transport violates customs regulations or for any other illegal activity.' },
        rentalTerm4b: { ar: 'في حمل المسافرين أو بضائع مقابل أجرة مذكورة بصراحة أو مفهومة ضمنياً.', en: ' For carrying passengers or goods for a fee, whether explicitly stated or implicitly understood.' },
        rentalTerm4c: { ar: 'في دفع أو سحب أي سيارة أو مقطورة دون موافقة المؤجر.', en: ' For pushing or pulling any car or trailer without the lessor\'s consent.' },
        rentalTerm4d: { ar: 'في مسابقات رياضة السيارات (بما فيها سباق السيارات، سرعة الانطلاق، سباقات اختبارات القوة واختبارات السرعة).', en: ' In motorsport competitions (including car racing, acceleration, power tests, and speed tests).' },
        rentalTerm4e: { ar: 'من قبل أي شخص غير مناسب لقيادة السيارات بسبب تناول الخمر والمخدرات.', en: ' By any person unsuitable for driving due to alcohol or drug consumption.' },
        rentalTerm4f: { ar: 'من قبل أي شخص باستثناء المستأجر ليقود السيارة وبموافقة المؤجر على ذلك كتابياً.', en: ' By any person other than the tenant to drive the car with the lessor\'s written consent.' },
        rentalTerm4g: { ar: 'من قبل أي عامل تصليح أو ميكانيكي سيارات في حالة حصول حادث أو تعطل أي شخص آخر غير مسموح له بموجب هذا العقد.', en: ' By any repair worker or car mechanic in case of an accident or breakdown, or any other person not permitted under this contract.' },
        rentalTerm5: { ar: 'إن المستأجر مسؤول شخصياً عن دفع ما يلي للمؤجر عند الطلب:', en: 'The tenant is personally responsible for paying the following to the lessor upon request:' },
        rentalTerm5a: { ar: 'مبلغ 1500 درهم (ألف وخمسمائة درهم) في حال تصادم السيارة أو إصابتها هي أو الماكينة بأضرار.', en: 'a. An amount of 1500 AED (one thousand five hundred dirhams) in case of car collision or damage to it or the engine.' },
        rentalTerm5b: { ar: 'كافة غرامات المحكمة ورسومها.', en: 'b. All court fines and fees.' },
        rentalTerm5c: { ar: 'الرسوم المفروضة لإعادة سيارة الشركة إلى مكاتبنا.', en: 'c. Fees imposed for returning the company\'s car to our offices.' },
        rentalTerm6: { ar: 'يجب دفع المبلغ المستحق على السيارة المستأجرة عند تسليمها أو استبدالها بسيارة أخرى وذلك في:', en: 'The amount due on the rented car must be paid upon delivery or replacement with another car, and that is in:' },
        rentalTerm6a: { ar: 'ساعات العمل الرسمية للمكتب وهي من 8:30 صباحاً إلى 1 ظهراً.', en: 'Official working hours of the office, which are from 8:30 AM to 1:00 PM.' },
        rentalTerm7: { ar: 'في حالة حصول أي حادث فإن المستأجر مسؤول عن:', en: 'In case of any accident, the tenant is responsible for:' },
        rentalTerm7a: { ar: 'إبلاغ الشركة وشركة التأمين ودائرة المرور بالحادث دون تحريك السيارة.', en: 'a. Notifying the company, the insurance company, and the traffic department of the accident without moving the car.' },
        rentalTerm7b: { ar: 'الحصول على تقرير خطي من شرطة المرور.', en: 'b. Obtaining a written report from the traffic police.' },
        rentalTerm7c: { ar: 'اتخاذ الإجراءات لضمان سلامة السيارة ومحتوياتها.', en: 'c. Taking measures to ensure the safety of the car and its contents.' },
        rentalTerm8: { ar: 'في حالة فقدان أي أملاك أو حصول أضرار لها (وتشمل التكييف العائدة لها، أرففها أو المواد المنقولة من قبل المستأجر في داخل السيارة أو عليها) وفي حالة العودة إلى المؤجر، فإن المستأجر سوف يعتبر مسؤولاً عن ذلك وعليه تحمل تكاليف تعويض الشركة عن أية إضافات مفقودة.', en: 'In case of loss of any property or damage to it (including its air conditioning, its shelves, or materials transported by the tenant inside or on the car), and in case of return to the lessor, the tenant will be considered responsible for that and must bear the costs of compensating the company for any missing additions.' },
        rentalTerm9: { ar: 'يجب إحضار السيارات كل 350 كم بالضبط لإجراء الصيانة اللازمة من قبل الشركة أو في حالة حدوث أي عطل ميكانيكي أو كهربائي فيها، وإلا فإن المستأجر يعتبر مسؤولاً، وسوف يتحمل تكاليف أي أضرار ناتجة عن ذلك.', en: 'Cars must be brought every 350 km exactly for necessary maintenance by the company or in case of any mechanical or electrical malfunction, otherwise the tenant will be considered responsible and will bear the costs of any resulting damages.' },
        rentalTerm10: { ar: 'في حالة مخالفة شروط وبنود هذا العقد، فإن للمؤجر الحق في استرداد السيارة إنذار، وسيكون المستأجر مسؤولاً وعليه تعويض المؤجر عن كافة التكاليف الناتجة عن استرداد السيارة وليس للمستأجر حق أو مطالبة بتعويض عن أي شيء يوجد في السيارة.', en: 'In case of violation of the terms and conditions of this contract, the lessor has the right to repossess the car without warning, and the tenant will be responsible and must compensate the lessor for all costs resulting from the repossession of the car, and the tenant has no right or claim for compensation for anything in the car.' },
        rentalTerm11: { ar: 'أية إضافات أو تعديل للبنود والشروط سوف تعتبر لاغية وباطلة ما لم توافق عليها الشركة خطياً.', en: 'Any additions or amendments to the terms and conditions will be considered null and void unless approved in writing by the company.' },
        rentalTerm12: { ar: 'للمؤجر الحق في إقامة دعوى أو طلب تعويض في حالة حدوث أي تلاعب بعداد السيارة.', en: 'The lessor has the right to file a lawsuit or claim compensation in case of any tampering with the car\'s odometer.' },
        rentalTerm13: { ar: 'يعتبر الكفيل طرف ثالث في هذا العقد ويكون ملزماً ومسؤولاً عن تنفيذ جميع بنود هذا العقد.', en: 'The guarantor is considered a third party in this contract and is obligated and responsible for implementing all terms of this contract.' },
        rentalTerm14: { ar: 'في حالة مطالبة المستأجر بأي مبالغ عن طريق المحكمة يلزم المستأجر بدفع 10% للمحامي والرسوم ومصاريف المحكمة وغيرها.', en: 'In case the tenant claims any amounts through the court, the tenant is obligated to pay 10% to the lawyer, fees, court expenses, and others.' },
        rentalTerm15: { ar: 'المكتب وشركة التأمين غير مسؤولين عن السيارة إذا وقع عليها حادث خارج حدود دولة الإمارات العربية المتحدة وتقع المسؤولية على المستأجر.', en: 'The office and the insurance company are not responsible for the car if an accident occurs outside the borders of the United Arab Emirates, and the responsibility falls on the tenant.' },
        rentalTerm16: { ar: 'يلتزم المستأجر بهذه الشروط والبنود فيما يتعلق بأي تهديد لفترة الاستئجار.', en: 'The tenant is obligated by these terms and conditions regarding any threat to the rental period.' },
        rentalTerm17: { ar: 'في حالة حدوث على سيارة تظل يومية السيارة سارية المفعول حسب اليومية المتفق عليها سابقاً ومدونة في الاتفاق.', en: 'In the event of damage to the car, the daily rate of the car remains valid according to the daily rate previously agreed upon and recorded in the agreement.' },
        rentalTerm18: { ar: 'المكتب وشركة التأمين غير مسؤولين عن الآتي: السرعة، السكر، القيادة عكس السير، عدم وجود رخصة أو إذن.', en: 'The office and the insurance company are not responsible for the following: speeding, drunkenness, driving against traffic, not having a license or permit.' },
        rentalTerm19: { ar: 'إذا أعاد المستأجر السيارة إلى المكتب وهي بها أوساخ أو ماء على أي جزء من أجزاء السيارة يلزم بدفع 250 درهم لغسيل السيارة.', en: 'If the tenant returns the car to the office with dirt or water on any part of the car, he is obligated to pay 250 dirhams for car washing.' },
        rentalTerm20: { ar: 'نحن المستأجر والكفيل قد وضعنا جواز سفرنا طرف الشركة لحين سداد المبلغ وليس لنا الحق بالمطالبة به إلا بعد السداد.', en: 'We, the tenant and the guarantor, have placed our passports with the company until the amount is paid, and we do not have the right to claim them except after payment.' },
        rentalTerm21: { ar: 'في حالة رجوع شيك المستأجر أو الكفيل أو مطالبة مبلغ مستحق لصالحنا تفصل بمعرفة الشرطة.', en: 'In case of the tenant\'s or guarantor\'s check bouncing or claiming a due amount in our favor, it will be settled by the police.' },
        rentalTerm22: { ar: 'في حالة عدم عودة السيارة في الموعد المحدد من حق الشركة أو المؤسسة أن تعلق في الجرائد والصحف الرسمية ويتحمل المستأجر مصاريف النشر وبدون أن تحمل المؤسسة أو الشركة أي مسؤولية تجاه النشر بالاسم الكامل والقبيلة والجنسية ورقم الجواز ومصدره ورقم السيارة ونوعها، ومن حق المؤسسة وضع صورة المستأجر أو الكفيل في الجرائد الرسمية بالدولة.', en: 'In case the car is not returned on the specified date, the company or institution has the right to publish in official newspapers and journals, and the tenant bears the publication expenses without the institution or company bearing any responsibility towards the publication with the full name, tribe, nationality, passport number and its source, car number and type, and the institution has the right to place a picture of the tenant or guarantor in the official newspapers of the state.' },
        rentalTerm23: { ar: 'يكون المستأجر ملزماً بدفع أي مبلغ عن التصليح للمؤسسة أو الشركة.', en: 'The tenant is obligated to pay any amount for repairs to the institution or company.' },
        rentalTerm24: { ar: 'في حالة اللجوء إلى المحكمة يتحمل المستأجر أو الكفيل الرسوم و 10% أتعاب محاماة 0% يومياً كفوائد تأخير.', en: 'In case of resorting to court, the tenant or guarantor bears the fees and 10% lawyer fees, 0% daily as delay interest.' },
        rentalTerm25: { ar: 'المستأجر والكفيل مسؤولان عن دفع قيمة السيارة وإيجارها في حالة مصادرتها من الجهات المختصة في الدولة.', en: 'The tenant and the guarantor are responsible for paying the value of the car and its rent in case it is confiscated by the competent authorities in the state.' },
        rentalTerm26: { ar: 'يكون المستأجر ملزماً بدفع مبلغ وقدره 250 درهم في حالة على المستأجر.', en: 'The tenant is obligated to pay an amount of 250 dirhams in case of damage to the tenant.' },
        rentalTerm27: { ar: 'أي مخالفات مرورية يتحملها المستأجر أثناء وجود السيارة معه ويحق للمكتب بالمطالبة بعد انتهاء مدة إيجار السيارة.', en: 'Any traffic violations are borne by the tenant while the car is with him, and the office has the right to claim after the end of the car rental period.' },
        rentalTerm28: { ar: 'يمنع خروج السيارة من دولة الإمارات العربية المتحدة إطلاقاً.', en: 'The car is strictly prohibited from leaving the United Arab Emirates.' },
        // Print-specific labels
        noLabel: { ar: 'الرقم', en: 'No.' },
        dateLabel: { ar: 'التاريخ', en: 'Date' },
        carRentalAgreementPrint: { ar: 'عقد تأجير سيارة', en: 'CAR RENTAL AGREEMENT' },
        vehicleDetailsPrint: { ar: 'تفاصيل المركبة', en: 'VEHICLE DETAILS' },
        hirerDetailsPrint: { ar: 'تفاصيل المستأجر', en: 'HIRER DETAILS' },
        vehRegNoPrint: { ar: 'رقم المركبة', en: 'VEH. REG. NO.' },
        hirerNamePrint: { ar: 'اسم المستأجر', en: 'HIRER NAME' },
        vehicleTypePrint: { ar: 'نوع المركبة', en: 'VEHICLE TYPE' },
        yearMadePrint: { ar: 'سنة الصنع', en: 'YEAR MADE' },
        colourPrint: { ar: 'اللون', en: 'COLOUR' },
        contactNoPrint: { ar: 'رقم الهاتف', en: 'CONTACT NO.' },
        foxCarsRentalPrint: { ar: 'فوكس لتأجير السيارات', en: 'FOX CARS RENTAL' },
        addressPrint: { ar: 'العنوان', en: 'ADDRESS' },
        phoneLabelPrint: { ar: 'هاتف', en: 'PHONE' }, // Assuming a general contact for FOX CARS RENTAL
        licenceNoPrint: { ar: 'رقم الرخصة', en: 'LICENCE NO.' },
        licExpiryDatePrint: { ar: 'تاريخ انتهاء الرخصة', en: 'LIC. EXPIRY DATE' },
        licIssuedByPrint: { ar: 'مكان الصدور', en: 'LIC. ISSUED BY' },
        rentalChargePrint: { ar: 'تفاصيل الإيجار', en: 'RENTAL CHARGE DETAILS' },
        summerDatePrint: { ar: 'التاريخ', en: 'DATE' }, // Assuming this refers to the date column in the summary
        timePrint: { ar: 'الوقت', en: 'TIME' },
        kiloMeterPrint: { ar: 'كيلومتر', en: 'KILOMETER' },
        conditionVehPrint: { ar: 'حالة السيارة', en: 'VEH. CONDITION' },
        vehOutPrint: { ar: 'الخروج', en: 'VEH. OUT' },
        vehInPrint: { ar: 'الدخول', en: 'VEH. IN' },
        rentPeriodPrint: { ar: 'مدة الإيجار', en: 'RENT PERIOD' },
        daysPrint: { ar: 'أيام', en: 'days' },
        hirerSignature: { ar: 'توقيع المستأجر', en: 'Hirer Signature' },
        sponsorSignature: { ar: 'توقيع الكفيل', en: 'Sponsor Signature' },
        officeInchargeSignature: { ar: 'توقيع مندوب المكتب', en: 'Office Incharge' },
        // NEW TRANSLATIONS FOR ADD NEW RENTAL FORM
        addNewRentalButton: { ar: 'إضافة إيجار جديد', en: 'Add New Rental' },
        addNewRentalTitle: { ar: 'إضافة سجل إيجار جديد', en: 'Add New Rental Record' },
        selectVehicleOption: { ar: 'اختر مركبة', en: 'Select Vehicle' },
        selectCustomerOption: { ar: 'اختر عميل', en: 'Select Customer' },
        initialOdometerLabel: { ar: 'عداد المسافة الأولي (كم):', en: 'Initial Odometer (KM):' },
        finalOdometerLabel: { ar: 'عداد المسافة النهائي (كم):', en: 'Final Odometer (KM):' }, // Added
        notesLabel: { ar: 'ملاحظات:', en: 'Notes:' },
        saveButton: { ar: 'حفظ', en: 'Save' },
        clearButton: { ar: 'مسح', en: 'Clear' }, // Added
        statusOngoing: { ar: 'جارية', en: 'Ongoing' },
        statusCompleted: { ar: 'مكتملة', en: 'Completed' },
        statusCancelled: { ar: 'ملغاة', en: 'Cancelled' },
        statusMessageRentalAddedSuccess: { ar: 'تمت إضافة سجل الإيجار بنجاح!', en: 'Rental record added successfully!' },
        statusMessageRentalAddError: { ar: 'خطأ في إضافة سجل الإيجار:', en: 'Error adding rental record:' },
        statusMessageInvalidDates: { ar: 'تاريخ الانتهاء يجب أن يكون بعد تاريخ البدء.', en: 'End date must be after from date.' },
        // NEW TRANSLATIONS FOR EDIT RENTAL FORM
        editRentalRecordButton: { ar: 'تعديل', en: 'Edit' },
        actualReturnDateLabel: { ar: 'تاريخ الإرجاع الفعلي', en: 'Actual Return Date' },
        actualOdometerLabel: { ar: 'عداد المسافة الفعلي (كم)', en: 'Actual Odometer (KM)' }, // Re-used from previous, but now used in edit form
        actualOdometerPlaceholder: { ar: 'أدخل عداد المسافة الفعلي', en: 'Enter actual odometer' }, // Re-used
        trafficFinesLabel: { ar: 'المخالفات المرورية', en: 'Traffic Fines' }, // Re-used
        trafficFinesPlaceholder: { ar: 'أدخل قيمة المخالفات المرورية', en: 'Enter traffic fines value' }, // Re-used
        carRepairLabel: { ar: 'تصليح السيارة', en: 'Car Repair' }, // Re-used
        carRepairPlaceholder: { ar: 'أدخل تكلفة تصليح السيارة', en: 'Enter car repair cost' }, // Re-used
        calculatedRentedDaysLabel: { ar: 'أيام الإيجار المحسوبة:', en: 'Calculated Rented Days:' },
        calculatedTotalPriceLabel: { ar: 'إجمالي السعر المحسوب:', en: 'Calculated Total Price:' },
        calculatedBalanceLabel: { ar: 'الرصيد المستحق المحسوب:', en: 'Calculated Balance Due:' },
        saveChangesButton: { ar: 'حفظ التغييرات', en: 'Save Changes' },
        statusMessageErrorUpdatingRental: { ar: 'خطأ في تحديث سجل الإيجار:', en: 'Error updating rental record:' },
        statusMessageRentalUpdated: { ar: 'تم تحديث سجل الإيجار بنجاح!', en: 'Rental record updated successfully!' },
        statusMessageRentalCarUpdateFailed: { ar: 'تم تحديث الإيجار، ولكن فشل تحديث حالة السيارة:', en: 'Rental updated, but failed to update car status:' },
        printButton: { ar: 'طباعة', en: 'Print' }, // Added for print button in table
        nationalityPrint: { ar: 'الجنسية', en: 'NATIONALITY' }, // Added translation for Nationality
        idNumPrint: { ar: 'رقم الهوية', en: 'ID NUMBER' }, // Added translation for ID Number
    };

    // Set initial language to English, then check localStorage
    let currentLang = localStorage.getItem('lang') || 'en';

    // Helper function to get translated text safely
    function getTranslation(key, fallback = '') {
        return (translations[key] && translations[key][currentLang]) ? translations[key][currentLang] : fallback;
    }

    // Function to apply translations
    function applyTranslations() {
        document.querySelectorAll('[data-i18n-key]').forEach(element => {
            const key = element.getAttribute('data-i18n-key');
            if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                element.placeholder = getTranslation(key, element.placeholder);
            } else if (element.tagName === 'OPTION') {
                // For options, update textContent only if it has a data-i18n-key
                element.textContent = getTranslation(key, element.textContent);
            }
            else {
                element.textContent = getTranslation(key, element.textContent);
            }
        });

        // Handle select options for status
        const statusSelect = document.getElementById('status');
        if (statusSelect) {
            statusSelect.querySelector('option[value=""]').textContent = getTranslation('selectStatus', 'Select Status');
            statusSelect.querySelector('option[value="Available"]').textContent = getTranslation('availableStatus', 'Available');
            statusSelect.querySelector('option[value="Rented"]').textContent = getTranslation('rentedStatus', 'Rented');
            statusSelect.querySelector('option[value="Under Maintenance"]').textContent = getTranslation('maintenanceStatus', 'Under Maintenance');
        }
        // Handle select options for payment status filter
        const paymentStatusFilterSelect = document.getElementById('paymentStatusFilter');
        if (paymentStatusFilterSelect) {
            paymentStatusFilterSelect.querySelector('option[value="All"]').textContent = getTranslation('paymentStatusAll', 'All');
            paymentStatusFilterSelect.querySelector('option[value="Paid"]').textContent = getTranslation('paymentStatusPaid', 'Paid');
            paymentStatusFilterSelect.querySelector('option[value="Partially Paid"]').textContent = getTranslation('paymentStatusPartiallyPaid', 'Partially Paid');
            paymentStatusFilterSelect.querySelector('option[value="Pending"]').textContent = getTranslation('paymentStatusPending', 'Pending');
        }

        // Handle new rental form select options
        const newRentalPaymentStatusSelect = document.getElementById('newRentalPaymentStatus');
        if (newRentalPaymentStatusSelect) {
            newRentalPaymentStatusSelect.querySelector('option[value="Pending"]').textContent = getTranslation('paymentStatusPending', 'Pending');
            newRentalPaymentStatusSelect.querySelector('option[value="Paid"]').textContent = getTranslation('paymentStatusPaid', 'Paid');
            newRentalPaymentStatusSelect.querySelector('option[value="Partially Paid"]').textContent = getTranslation('paymentStatusPartiallyPaid', 'Partially Paid');
        }
        const newRentalStatusSelect = document.getElementById('newRentalStatus');
        if (newRentalStatusSelect) {
            newRentalStatusSelect.querySelector('option[value="Ongoing"]').textContent = getTranslation('statusOngoing', 'Ongoing');
            newRentalStatusSelect.querySelector('option[value="Completed"]').textContent = getTranslation('statusCompleted', 'Completed');
            newRentalStatusSelect.querySelector('option[value="Cancelled"]').textContent = getTranslation('statusCancelled', 'Cancelled');
        }

        // Handle edit rental form select options
        const editRentalPaymentStatusSelect = document.getElementById('editRentalPaymentStatus');
        if (editRentalPaymentStatusSelect) {
            editRentalPaymentStatusSelect.querySelector('option[value="Pending"]').textContent = getTranslation('paymentStatusPending', 'Pending');
            editRentalPaymentStatusSelect.querySelector('option[value="Paid"]').textContent = getTranslation('paymentStatusPaid', 'Paid');
            editRentalPaymentStatusSelect.querySelector('option[value="Partially Paid"]').textContent = getTranslation('paymentStatusPartiallyPaid', 'Partially Paid');
        }
        const editRentalStatusSelect = document.getElementById('editRentalStatus');
        if (editRentalStatusSelect) {
            editRentalStatusSelect.querySelector('option[value="Ongoing"]').textContent = getTranslation('statusOngoing', 'Ongoing');
            editRentalStatusSelect.querySelector('option[value="Completed"]').textContent = getTranslation('statusCompleted', 'Completed');
            editRentalStatusSelect.querySelector('option[value="Cancelled"]').textContent = getTranslation('statusCancelled', 'Cancelled');
        }


        // Update document direction and language attribute
        document.documentElement.lang = currentLang;
        document.body.dir = (currentLang === 'ar') ? 'rtl' : 'ltr';

        // Update active language button
        document.querySelectorAll('.language-button').forEach(button => {
            if (button.dataset.lang === currentLang) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });

        // Also update the direction of modals/dialogs (though modal is removed, keeping for future proofing)
        const modals = document.querySelectorAll('.modal-content');
        modals.forEach(modal => {
            modal.style.direction = (currentLang === 'ar') ? 'rtl' : 'ltr';
        });
    }

    // Function to show status messages
    function showStatus(messageKey, isSuccess, targetElement) {
        if (!targetElement) return;

        let message = getTranslation(messageKey, messageKey); // Use helper for status messages

        targetElement.textContent = message;
        targetElement.className = isSuccess ? 'status-message success' : 'status-message error';
        targetElement.style.display = 'block';

        setTimeout(() => {
            targetElement.style.opacity = '0';
            setTimeout(() => {
                targetElement.className = 'status-message';
                targetElement.style.opacity = '1';
                targetElement.style.display = 'none';
            }, 300);
        }, 3000);
    }

    // --- Rent History Logic ---
    async function fetchRentHistory() {
        if (!rentHistoryTableBody || !rentHistoryEmptyState) return;

        // Get filter values
        const paymentStatus = paymentStatusFilterSelect.value;


        let query = supabaseClient
            .from('rent_history')
            .select(`
                *,
                cars (id, plate_number, year, color, odometer_km, veh_make (make), veh_model (model)),
                customers (id, first_name, last_name, email, phone_number, address, driver_license_number, driver_license_expiry_date, date_of_birth)
            `)
            .order('created_at', { ascending: false });

        // Apply filters
        if (paymentStatus !== 'All') {
            query = query.eq('payment_status', paymentStatus);
        }

        const { data: rentHistory, error } = await query;

        rentHistoryTableBody.innerHTML = '';
        rentHistoryEmptyState.style.display = 'none';

        if (error) {
            console.error('Error fetching rent history:', error.message, error); // Log the full error object
            rentHistoryTableBody.innerHTML = `<tr><td colspan="14">${getTranslation('statusMessageErrorFetchingRentHistory')}</td></tr>`;
            rentHistoryEmptyState.style.display = 'block';
            return;
        }

        if (rentHistory && rentHistory.length > 0) {
            rentHistory.forEach(rental => {
                console.log('Processing rental:', rental); // Log the full rental object
                console.log('Rental cars data:', rental.cars); // Log the cars data specifically

                const row = rentHistoryTableBody.insertRow(); // Define row here
                // Determine vehicle name: If cars data is available, use make/model/plate. Otherwise, try to use car_id, or fallback to N/A.
                let vehicleName;
                if (rental.cars) {
                    // Check if nested make/model exist
                    const make = rental.cars.veh_make ? rental.cars.veh_make.make : 'Unknown Make';
                    const model = rental.cars.veh_model ? rental.cars.veh_model.model : 'Unknown Model';
                    const plate = rental.cars.plate_number || getTranslation('n_a');
                    
                    if (rental.cars.veh_make && rental.cars.veh_model) {
                         vehicleName = `${make} ${model} (${plate})`;
                    } else {
                        // If make or model is missing, indicate it
                        vehicleName = `Car ID: ${rental.car_id} (Make: ${make}, Model: ${model}, Plate: ${plate})`;
                    }
                } else if (rental.car_id) {
                    vehicleName = `Car ID: ${rental.car_id} (${getTranslation('n_a')})`; // Show car ID if full details unavailable
                } else {
                    vehicleName = getTranslation('n_a');
                }

                const customerName = rental.customers ?
                                     `${rental.customers.first_name || ''} ${rental.customers.last_name || ''} (${rental.customers.phone_number || getTranslation('n_a')})` :
                                     getTranslation('n_a');

                row.insertCell().textContent = vehicleName;
                row.insertCell().textContent = customerName;
                row.insertCell().textContent = rental.from_date ? new Date(rental.from_date).toLocaleDateString() : getTranslation('n_a');
                row.insertCell().textContent = rental.end_date ? new Date(rental.end_date).toLocaleDateString() : getTranslation('n_a');
                row.insertCell().textContent = rental.rented_days !== null ? rental.rented_days : getTranslation('n_a');
                row.insertCell().textContent = rental.rental_price_per_day !== null ? `AED${rental.rental_price_per_day.toFixed(2)}` : getTranslation('n_a');
                row.insertCell().textContent = rental.total_price !== null ? `AED${rental.total_price.toFixed(2)}` : getTranslation('n_a');
                row.insertCell().textContent = rental.paid_amount !== null ? `AED${rental.paid_amount.toFixed(2)}` : getTranslation('n_a');
                row.insertCell().textContent = rental.balance !== null ? `AED${rental.balance.toFixed(2)}` : getTranslation('n_a');
                row.insertCell().textContent = rental.actual_return_date ? new Date(rental.actual_return_date).toLocaleDateString() : getTranslation('n_a');
                row.insertCell().textContent = rental.payment_status || getTranslation('n_a');
                row.insertCell().textContent = rental.traffic_fines !== null ? `AED${rental.traffic_fines.toFixed(2)}` : getTranslation('n_a');
                row.insertCell().textContent = rental.car_repair !== null ? `AED${rental.car_repair.toFixed(2)}` : getTranslation('n_a'); // NEW: Car Repair cell

                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-edit" onclick="showEditRentalForm('${rental.id}')">
                        <i class="fas fa-edit"></i> <span data-i18n-key="editRentalRecordButton">${getTranslation('editRentalRecordButton')}</span>
                    </button>
                    <button class="btn-info" onclick="printRentalAgreement('${rental.id}')">
                        <i class="fas fa-print"></i> <span data-i18n-key="printButton">${getTranslation('printButton')}</span>
                    </button>
                `;
            });
        } else {
            rentHistoryTableBody.innerHTML = '<tr><td colspan="14"></td></tr>'; // Adjusted colspan for new column
            rentHistoryEmptyState.style.display = 'block';
        }
    }

    // Helper function to format date for input fields
    function formatDateForInput(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Function to print rental agreement
    async function printRentalAgreement(rentalId) {
        // Fetch full rental details
        const { data: rental, error } = await supabaseClient
            .from('rent_history')
            .select(`
                *,
                cars (plate_number, year, color, odometer_km, veh_make (make), veh_model (model)),
                customers (first_name, last_name, email, phone_number, address, city, driver_license_number, driver_license_expiry_date, date_of_birth, id_number, nationality, license_issued_by)
            `)
            .eq('id', rentalId)
            .single();

        if (error) {
            console.error('Error fetching rental details for print:', error.message, error); // Log the full error object
            return;
        }

        if (!rental) {
            console.error('Rental record not found for printing.');
            return;
        }

        // Prepare data for the agreement
        const vehicle = rental.cars || {};
        const customer = rental.customers || {};
        const make = vehicle.veh_make ? vehicle.veh_make.make : getTranslation('n_a');
        const model = vehicle.veh_model ? vehicle.veh_model.model : getTranslation('n_a');

        const createdAtDate = rental.created_at ? new Date(rental.created_at).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        }) : '';

        const printContent = `
            <!DOCTYPE html>
            <html lang="${currentLang}" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${getTranslation('carRentalAgreementPrint')}</title>
                <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                <style>
                    body {
                        font-family: 'Poppins', sans-serif;
                        margin: 0;
                        padding: 20px;
                        color: #333;
                        font-size: 12px;
                    }
                    .agreement-container {
                        width: 210mm; /* A4 width */
                        min-height: 297mm; /* A4 height */
                        margin: 0 auto;
                        border: 1px solid #ccc;
                        padding: 20px;
                        box-sizing: border-box;
                        background: white;
                    }
                    .print-header-image {
                        width: 100%;
                        height: auto;
                        display: block;
                        margin-bottom: 20px; /* Space below the image */
                    }
                    .header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #eee;
                        padding-bottom: 10px;
                    }
                    .header-left, .header-right {
                        flex: 1;
                        text-align: left; /* Aligned to left */
                    }
                    html[dir="rtl"] .header-left, html[dir="rtl"] .header-right {
                        text-align: right; /* Aligned to right for RTL */
                    }
                    .header-center {
                        flex: 2;
                        text-align: center;
                    }
                    .header h1 {
                        font-size: 18px;
                        margin: 0;
                        color: #4361ee;
                    }
                    .header .logo-text {
                        font-size: 24px;
                        font-weight: bold;
                        color: #e74c3c; /* Reddish color from image */
                        display: inline-block;
                        margin-right: 10px;
                    }
                    .header .logo-subtext {
                        font-size: 16px;
                        color: #555;
                    }
                    .details-section {
                        display: flex; /* Use flexbox for side-by-side tables */
                        justify-content: space-between;
                        gap: 20px; /* Space between tables */
                        margin-bottom: 20px;
                    }
                    .details-section > div {
                        flex: 1; /* Each table takes equal width */
                    }
                    .agreement-table {
                        width: 100%;
                        border-collapse: collapse;
                    }
                    .agreement-table th, .agreement-table td {
                        border: 1px solid #ccc;
                        padding: 8px;
                        text-align: left;
                        vertical-align: top;
                    }
                    html[dir="rtl"] .agreement-table th, html[dir="rtl"] .agreement-table td {
                        text-align: right;
                    }
                    .agreement-table th {
                        background-color: #f2f2f2;
                        font-weight: bold;
                        width: 40%; /* Adjust column width for labels */
                    }
                    .agreement-table td {
                        width: 60%; /* Adjust column width for values */
                    }
                    .agreement-table.full-width {
                        width: 100%; /* Ensure the rental charge table spans full width */
                    }
                    .section-title {
                        font-weight: bold;
                        background-color: #e0e0e0;
                        text-align: center;
                    }
                    .disclaimer-section, .main-conditions-section, .rental-terms-section {
                        margin-top: 30px;
                        border-top: 1px solid #eee;
                        padding-top: 20px;
                    }
                    .disclaimer-section h3, .main-conditions-section h3, .rental-terms-section h3 {
                        font-size: 14px;
                        margin-bottom: 10px;
                        color: #4361ee;
                    }
                    .disclaimer-section ol, .main-conditions-section ol, .rental-terms-section ol {
                        list-style-type: none; /* Remove default numbering */
                        padding-left: 0;
                    }
                    .disclaimer-section ol li, .main-conditions-section ol li, .rental-terms-section ol li {
                        margin-bottom: 8px;
                        line-height: 1.4;
                        position: relative;
                        padding-left: 20px; /* Space for custom numbering */
                    }
                    html[dir="rtl"] .disclaimer-section ol li, html[dir="rtl"] .main-conditions-section ol li, html[dir="rtl"] .rental-terms-section ol li {
                        padding-right: 20px;
                        padding-left: 0;
                    }
                    html[dir="rtl"] .disclaimer-section ol li::before, html[dir="rtl"] .main-conditions-section ol li::before, html[dir="rtl"] .rental-terms-section ol li::before {
                        left: unset;
                        right: 0;
                    }
                    .signature-section {
                        display: flex;
                        justify-content: space-around;
                        margin-top: 40px;
                        padding-top: 20px;
                        border-top: 1px dashed #ccc;
                        font-size: 14px;
                        text-align: center;
                    }
                    .signature-block {
                        flex: 1;
                        padding: 0 10px;
                    }
                    .signature-line {
                        border-bottom: 1px solid #000;
                        margin-top: 40px; /* Space for signature */
                        margin-bottom: 5px;
                    }
                    .logo-img {
                        max-width: 150px; /* Adjust as needed */
                        height: auto;
                        display: block;
                        margin: 0 auto 10px auto; /* Center the image */
                    }


                    @media print {
                        body {
                            padding: 0;
                            margin: 0;
                        }
                        .agreement-container {
                            border: none;
                            box-shadow: none;
                        }
                        /* Reduced spacing for print */
                        .disclaimer-section,
                        .main-conditions-section,
                        .rental-terms-section {
                            margin-top: 0 !important; /* Force no margin */
                            padding-top: 0 !important; /* Force no padding */
                            border-top: none !important; /* Remove border for cleaner flow */
                            }
                        .disclaimer-section h3,
                        .main-conditions-section h3,
                        .rental-terms-section h3 {
                            margin-bottom: 3px !important; /* Reduce heading margin */
                        }
                        .rental-terms-section h3 {
                            margin-bottom: 0px !important; /* Specifically target this title to remove gap */
                        }
                        .disclaimer-section ol li,
                        .main-conditions-section ol li,
                        .rental-terms-section ol li {
                            margin-bottom: 2px !important; /* Reduce list item margin */
                        }
                        /* Try to keep lists from breaking */
                        .disclaimer-section ol,
                        .main-conditions-section ol,
                        .rental-terms-section ol {
                        }
                        /* Ensure the last item of main conditions doesn't get separated from the next section title */
                        .main-conditions-section {
                        }
                    }
                </style>
            </head>
            <body>
                <div class="agreement-container">
                    <img src="https://i.imgur.com/Tveneh5.png" alt="Print Header" class="print-header-image">

                    <div style="display: flex; justify-content: space-between; align-items: baseline; text-align: center; margin-bottom: 20px;">
                        <div style="flex: 1; text-align: left;"></div>
                        <h1 style="flex: 2; font-size: 16px; color: #4361ee; margin: 0;">
                            ${getTranslation('carRentalAgreementPrint')}
                        </h1>
                        <div style="flex: 1; text-align: right; font-size: 12px;">${createdAtDate}</div>
                    </div>

                    <div class="details-section">
                        <div>
                            <table class="agreement-table">
                                <thead>
                                    <tr>
                                        <th colspan="2" class="section-title">${getTranslation('vehicleDetailsPrint')}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <th>${getTranslation('vehRegNoPrint')}:</th>
                                        <td>${vehicle.plate_number || getTranslation('n_a')}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('vehicleTypePrint')}:</th>
                                        <td>${make} ${model}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('yearMadePrint')}:</th>
                                        <td>${vehicle.year || getTranslation('n_a')}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('colourPrint')}:</th>
                                        <td>${vehicle.color || getTranslation('n_a')}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('foxCarsRentalPrint')}:</th>
                                        <td>AJMAN RASHIDIYA 2</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('phoneLabelPrint')}:</th>
                                        <td>${getTranslation('n_a')}</td> <!-- Assuming a general contact for FOX CARS RENTAL -->
                                    </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <table class="agreement-table">
                            <thead>
                                <tr>
                                    <th colspan="2" class="section-title">${getTranslation('hirerDetailsPrint')}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <th>${getTranslation('hirerNamePrint')}:</th>
                                        <td>${customer.first_name || ''} ${customer.last_name || getTranslation('n_a')}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('nationalityPrint')}:</th>
                                        <td>${customer.nationality || getTranslation('n_a')}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('idNumPrint')}:</th>
                                        <td>${customer.id_number || getTranslation('n_a')}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('contactNoPrint')}:</th>
                                        <td>${customer.phone_number || getTranslation('n_a')}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('addressPrint')}:</th>
                                        <td>${customer.address || getTranslation('n_a')}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('cityLabel')}:</th>
                                        <td>${customer.city || getTranslation('n_a')}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('licenceNoPrint')}:</th>
                                        <td>${customer.driver_license_number || getTranslation('n_a')}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('licExpiryDatePrint')}:</th>
                                        <td>${customer.driver_license_expiry_date || getTranslation('n_a')}</td>
                                    </tr>
                                    <tr>
                                        <th>${getTranslation('licIssuedByPrint')}:</th>
                                        <td>${customer.license_issued_by || getTranslation('n_a')}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <table class="agreement-table full-width">
                        <thead>
                            <tr>
                                <th colspan="4" class="section-title">${getTranslation('rentalChargePrint')}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>${getTranslation('summerDatePrint')}</th>
                                <th>${getTranslation('timePrint')}</th>
                                <th>${getTranslation('kiloMeterPrint')}</th>
                                <th>${getTranslation('conditionVehPrint')}</th>
                            </tr>
                            <tr>
                                <td>${rental.from_date ? new Date(rental.from_date).toLocaleDateString() : getTranslation('n_a')}</td>
                                <td>${getTranslation('n_a')}</td> <!-- Time not available in data -->
                                <td>${vehicle.odometer_km || getTranslation('n_a')}</td>
                                <td>${getTranslation('n_a')}</td> <!-- Condition not available in data -->
                            </tr>
                            <tr>
                                <th>${getTranslation('vehOutPrint')}</th>
                                <td colspan="3">${rental.from_date ? new Date(rental.from_date).toLocaleDateString() : getTranslation('n_a')}</td>
                            </tr>
                            <tr>
                                <th>${getTranslation('vehInPrint')}</th>
                                <td colspan="3">${rental.actual_return_date ? new Date(rental.actual_return_date).toLocaleDateString() : getTranslation('n_a')}</td>
                            </tr>
                            <tr>
                                <th>${getTranslation('rentalPricePerDayLabel')}:</th>
                                <td>AED ${rental.rental_price_per_day !== null ? rental.rental_price_per_day.toFixed(2) : '0.00'}</td>
                                <th>${getTranslation('rentPeriodPrint')}:</th>
                                <td>${rental.rented_days !== null ? rental.rented_days : getTranslation('n_a')} ${getTranslation('daysPrint')}</td>
                            </tr>
                            <tr>
                                <th>${getTranslation('totalPriceLabel')}:</th>
                                <td colspan="3">AED ${rental.total_price !== null ? rental.total_price.toFixed(2) : '0.00'}</td>
                            </tr>
                            <tr>
                                <th>${getTranslation('paidAmountLabel')}:</th>
                                <td colspan="3">AED ${rental.paid_amount !== null ? rental.paid_amount.toFixed(2) : '0.00'}</td>
                            </tr>
                            <tr>
                                <th>${getTranslation('balanceDueLabel')}:</th>
                                <td colspan="3">AED ${rental.balance !== null ? rental.balance.toFixed(2) : '0.00'}</td>
                            </tr>
                            <tr>
                                <th>${getTranslation('trafficFinesLabel')}:</th>
                                <td colspan="3">AED ${rental.traffic_fines !== null ? rental.traffic_fines.toFixed(2) : '0.00'}</td>
                            </tr>
                            <tr>
                                <th>${getTranslation('carRepairLabel')}:</th>
                                <td colspan="3">AED ${rental.car_repair !== null ? rental.car_repair.toFixed(2) : '0.00'}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="disclaimer-section">
                        <h3>${getTranslation('disclaimerTitle')}</h3>
                        <ol>
                            <li data-list-number="1"><span style="color: red;">${getTranslation('disclaimer1')}</span></li>
                            <li data-list-number="2"><span style="color: red;">${getTranslation('disclaimer2')}</span></li>
                            <li data-list-number="3"><span style="color: red;">${getTranslation('disclaimer3')}</span></li>
                            <li data-list-number="4"><span style="color: red;">${getTranslation('disclaimer4')}</span></li>
                        </ol>
                    </div>

                    <div class="main-conditions-section">
                        <h3>${getTranslation('mainConditionsTitle')}</h3>
                        <ol>
                            <li data-list-number="1">${getTranslation('mainCondition1')}</li>
                            <li data-list-number="2">${getTranslation('mainCondition2')}</li>
                            <li data-list-number="3">${getTranslation('mainCondition3')}</li>
                            <li data-list-number="4"><span style="color: red;">${getTranslation('mainCondition4')}</span></li>
                            <li data-list-number="5">${getTranslation('mainCondition5')}</li>
                            <li data-list-number="6">${getTranslation('mainCondition6')}</li>
                            <li data-list-number="7">${getTranslation('mainCondition7')}</li>
                            <li data-list-number="8">${getTranslation('mainCondition8')}</li>
                        </ol>
                    </div>

                    <div class="rental-terms-section">
                        <h3>${getTranslation('rentalTermsTitle')}</h3>
                        <ol>
                            <li data-list-number="1">${getTranslation('rentalTerm1')}</li>
                            <li data-list-number="2">${getTranslation('rentalTerm2')}</li>
                            <li data-list-number="3">${getTranslation('rentalTerm3')}</li>
                            <li data-list-number="4">${getTranslation('rentalTerm4')}
                                <ol style="list-style-type: lower-alpha; padding-left: 20px;">
                                    <li >${getTranslation('rentalTerm4a')}</li>
                                    <li >${getTranslation('rentalTerm4b')}</li>
                                    <li >${getTranslation('rentalTerm4c')}</li>
                                    <li >${getTranslation('rentalTerm4d')}</li>
                                    <li >${getTranslation('rentalTerm4e')}</li>
                                    <li >${getTranslation('rentalTerm4f')}</li>
                                    <li >${getTranslation('rentalTerm4g')}</li>
                                </ol>
                            </li>
                            <li data-list-number="5">${getTranslation('rentalTerm5')}
                                <ol style="list-style-type: lower-alpha; padding-left: 20px;">
                                    <li >${getTranslation('rentalTerm5a')}</li>
                                    <li >${getTranslation('rentalTerm5b')}</li>
                                    <li >${getTranslation('rentalTerm5c')}</li>
                                </ol>
                            </li>
                            <li data-list-number="6">${getTranslation('rentalTerm6')}
                                <ol style="list-style-type: lower-alpha; padding-left: 20px;">
                                    <li >${getTranslation('rentalTerm6a')}</li>
                                </ol>
                            </li>
                            <li data-list-number="7">${getTranslation('rentalTerm7')}
                                <ol style="list-style-type: lower-alpha; padding-left: 20px;">
                                    <li >${getTranslation('rentalTerm7a')}</li>
                                    <li >${getTranslation('rentalTerm7b')}</li>
                                    <li >${getTranslation('rentalTerm7c')}</li>
                                </ol>
                            </li>
                            <li data-list-number="8">${getTranslation('rentalTerm8')}</li>
                            <li data-list-number="9">${getTranslation('rentalTerm9')}</li>
                            <li data-list-number="10"><span style="color: red;">${getTranslation('rentalTerm10')}</span></li>
                            <li data-list-number="11">${getTranslation('rentalTerm11')}</li>
                            <li data-list-number="12">${getTranslation('rentalTerm12')}</li>
                            <li data-list-number="13">${getTranslation('rentalTerm13')}</li>
                            <li data-list-number="14">${getTranslation('rentalTerm14')}</li>
                            <li data-list-number="15">${getTranslation('rentalTerm15')}</li>
                            <li data-list-number="16">${getTranslation('rentalTerm16')}</li>
                            <li data-list-number="17">${getTranslation('rentalTerm17')}</li>
                            <li data-list-number="18">${getTranslation('rentalTerm18')}</li>
                            <li data-list-number="19">${getTranslation('rentalTerm19')}</li>
                            <li data-list-number="20">${getTranslation('rentalTerm20')}</li>
                            <li data-list-number="21">${getTranslation('rentalTerm21')}</li>
                            <li data-list-number="22">${getTranslation('rentalTerm22')}</li>
                            <li data-list-number="23">${getTranslation('rentalTerm23')}</li>
                            <li data-list-number="24">${getTranslation('rentalTerm24')}</li>
                            <li data-list-number="25">${getTranslation('rentalTerm25')}</li>
                            <li data-list-number="26">${getTranslation('rentalTerm26')}</li>
                            <li data-list-number="27">${getTranslation('rentalTerm27')}</li>
                            <li data-list-number="28">${getTranslation('rentalTerm28')}</li>
                        </ol>
                    </div>

                    <div class="signature-section">
                        <div class="signature-block">
                            <div class="signature-line"></div>
                            <p data-i18n-key="hirerSignature">${getTranslation('hirerSignature')}</p>
                        </div>
                        <div class="signature-block">
                            <div class="signature-line"></div>
                            <p data-i18n-key="sponsorSignature">${getTranslation('sponsorSignature')}</p>
                        </div>
                        <div class="signature-block">
                            <div class="signature-line"></div>
                            <p data-i18n-key="officeInchargeSignature">${getTranslation('officeInchargeSignature')}</p>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    }

    // Function to show the edit rental form (replaces openEditRentalModal)
    async function showEditRentalForm(rentalId) {
        // Hide the add new rental form
        addNewRentalSection.style.display = 'none';
        // Show the edit rental section
        editRentalSection.style.display = 'block';
        editRentalStatusMessage.style.display = 'none'; // Hide any previous status messages

        const { data: rental, error } = await supabaseClient
            .from('rent_history')
            .select(`
                *,
                cars (id, plate_number, year, color, odometer_km, veh_make (make), veh_model (model)),
                customers (id, first_name, last_name, email, phone_number)
            `)
            .eq('id', rentalId)
            .single();

        if (error) {
            console.error('Error fetching rental for edit:', error.message);
            showStatus('statusMessageErrorFetchingRentHistory', false, editRentalStatusMessage);
            return;
        }

        if (!rental) {
            console.error('Rental record not found for editing.');
            showStatus('statusMessageErrorGeneric', false, editRentalStatusMessage);
            return;
        }

        // Populate form fields
        editRentalIdInput.value = rental.id;
        editRentalCarIdInput.value = rental.car_id; // Store car_id for later update

        const vehicleName = rental.cars ?
                            `${rental.cars.veh_make ? rental.cars.veh_make.make : 'Unknown Make'} ${rental.cars.veh_model ? rental.cars.veh_model.model : 'Unknown Model'} (${rental.cars.plate_number})` :
                            getTranslation('n_a');
        const customerName = rental.customers ?
                             `${rental.customers.first_name || ''} ${rental.customers.last_name || ''} (${rental.customers.phone_number || getTranslation('n_a')})` :
                             getTranslation('n_a');

        editRentalVehicleDisplay.value = vehicleName;
        editRentalCustomerDisplay.value = customerName;
        editRentalFromDateInput.value = formatDateForInput(rental.from_date);
        editRentalEndDateInput.value = formatDateForInput(rental.end_date);
        editRentalInitialOdometerInput.value = rental.initial_odometer_km;

        editRentalActualReturnDateInput.value = formatDateForInput(rental.actual_return_date);
        editRentalFinalOdometerInput.value = rental.final_odometer_km || '';
        editRentalPricePerDayInput.value = rental.rental_price_per_day;
        editRentalPaidAmountInput.value = rental.paid_amount;
        editRentalPaymentStatusSelect.value = rental.payment_status;
        editRentalStatusSelect.value = rental.status;
        editRentalTrafficFinesInput.value = rental.traffic_fines;
        editRentalCarRepairInput.value = rental.car_repair;
        editRentalNotesTextarea.value = rental.notes || '';

        // Calculate and display initial summary values
        calculateEditRentalSummary();
    }

    // Function to hide the edit rental form (replaces closeEditRentalModal)
    function hideEditRentalForm() {
        editRentalSection.style.display = 'none';
        addNewRentalSection.style.display = 'block'; // Show the add new rental form again
        editRentalForm.reset(); // Clear the form
        editRentalStatusMessage.style.display = 'none'; // Hide status messages
    }

    // Function to calculate and update summary fields in edit form
    function calculateEditRentalSummary() {
        const fromDate = new Date(editRentalFromDateInput.value);
        const endDate = new Date(editRentalEndDateInput.value);
        const actualReturnDate = editRentalActualReturnDateInput.value ? new Date(editRentalActualReturnDateInput.value) : null;
        
        const rentalPricePerDay = parseFloat(editRentalPricePerDayInput.value) || 0;
        const paidAmount = parseFloat(editRentalPaidAmountInput.value) || 0;
        const trafficFines = parseFloat(editRentalTrafficFinesInput.value) || 0;
        const carRepair = parseFloat(editRentalCarRepairInput.value) || 0;

        let rentedDays = 0;
        if (actualReturnDate && actualReturnDate >= fromDate) {
            const timeDiff = actualReturnDate.getTime() - fromDate.getTime();
            rentedDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
        } else if (endDate >= fromDate) { // If no actual return date, use scheduled end date
            const timeDiff = endDate.getTime() - fromDate.getTime();
            rentedDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
        }

        const totalPrice = (rentedDays * rentalPricePerDay) + trafficFines + carRepair;
        const balance = totalPrice - paidAmount;

        editRentalCalculatedRentedDays.value = rentedDays;
        editRentalCalculatedTotalPrice.value = `AED${totalPrice.toFixed(2)}`;
        editRentalCalculatedBalance.value = `AED${balance.toFixed(2)}`;
    }

    // Event listeners for recalculation in edit form
    editRentalActualReturnDateInput.addEventListener('change', calculateEditRentalSummary);
    editRentalPricePerDayInput.addEventListener('input', calculateEditRentalSummary);
    editRentalPaidAmountInput.addEventListener('input', calculateEditRentalSummary);
    editRentalTrafficFinesInput.addEventListener('input', calculateEditRentalSummary);
    editRentalCarRepairInput.addEventListener('input', calculateEditRentalSummary);


    // Event listener for edit rental form submission
    editRentalForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        showStatus('statusMessageSavingChanges', true, editRentalStatusMessage);

        const rentalId = editRentalIdInput.value;
        const carId = editRentalCarIdInput.value; // Get the car_id
        const newActualReturnDate = editRentalActualReturnDateInput.value || null;
        const newFinalOdometer = editRentalFinalOdometerInput.value ? parseFloat(editRentalFinalOdometerInput.value) : null;
        const newRentalPricePerDay = parseFloat(editRentalPricePerDayInput.value);
        const newPaidAmount = parseFloat(editRentalPaidAmountInput.value);
        const newPaymentStatus = editRentalPaymentStatusSelect.value;
        const newStatus = editRentalStatusSelect.value;
        const newTrafficFines = parseFloat(editRentalTrafficFinesInput.value);
        const newCarRepair = parseFloat(editRentalCarRepairInput.value);
        const newNotes = editRentalNotesTextarea.value;

        // Recalculate based on current form values
        const fromDateObj = new Date(editRentalFromDateInput.value);
        const actualReturnDateObj = newActualReturnDate ? new Date(newActualReturnDate) : null;

        let calculatedRentedDays = 0;
        if (actualReturnDateObj && actualReturnDateObj >= fromDateObj) {
            const timeDiff = actualReturnDateObj.getTime() - fromDateObj.getTime();
            calculatedRentedDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
        } else {
            // If actual return date is not set or invalid, use the original end date for calculation
            const endDateObj = new Date(editRentalEndDateInput.value);
            if (endDateObj >= fromDateObj) {
                const timeDiff = endDateObj.getTime() - fromDateObj.getTime();
                calculatedRentedDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
            }
        }

        const calculatedTotalPrice = (calculatedRentedDays * newRentalPricePerDay) + newTrafficFines + newCarRepair;
        const calculatedBalance = calculatedTotalPrice - newPaidAmount;

        const updatedRentalData = {
            actual_return_date: newActualReturnDate,
            final_odometer_km: newFinalOdometer,
            rental_price_per_day: newRentalPricePerDay,
            paid_amount: newPaidAmount,
            balance: calculatedBalance, // Use calculated balance
            payment_status: newPaymentStatus,
            notes: newNotes,
            status: newStatus,
            traffic_fines: newTrafficFines,
            car_repair: newCarRepair,
            rented_days: calculatedRentedDays, // Update rented_days based on actual return date
            total_price: calculatedTotalPrice, // Update total_price based on actuals
        };

        const { data, error } = await supabaseClient
            .from('rent_history')
            .update(updatedRentalData)
            .eq('id', rentalId);

        if (error) {
            console.error('Error updating rental record:', error.message, error);
            showStatus('statusMessageErrorUpdatingRental', false, editRentalStatusMessage);
        } else {
            // If rental status is 'Completed', update car status to 'Available'
            if (newStatus === 'Completed' && carId) {
                const { error: carUpdateError } = await supabaseClient
                    .from('cars')
                    .update({ status: 'Available' })
                    .eq('id', carId);

                if (carUpdateError) {
                    console.error('Error updating car status:', carUpdateError.message);
                    showStatus('statusMessageRentalCarUpdateFailed', false, editRentalStatusMessage);
                }
            }
            showStatus('statusMessageRentalUpdated', true, editRentalStatusMessage);
            hideEditRentalForm(); // Hide the edit form and show the add form
            fetchRentHistory(); // Refresh the table
        }
    });

    // Event listener for closing the edit rental form
    cancelEditRentalFormButton.addEventListener('click', hideEditRentalForm);


    // Function to initialize the new rental form (populate dropdowns, set default dates)
    async function initNewRentalForm() {
        // Populate vehicle dropdown
        const { data: cars, error: carsError } = await supabaseClient
            .from('cars')
            .select('id, plate_number, veh_make(make), veh_model(model)');
        
        if (carsError) {
            console.error('Error fetching cars:', carsError.message);
            showStatus('statusMessageErrorFetchingVehicles', false, addRentalStatusMessage);
            return;
        }

        newRentalCarSelect.innerHTML = `<option value="" data-i18n-key="selectVehicleOption">${getTranslation('selectVehicleOption')}</option>`;
        cars.forEach(car => {
            const make = car.veh_make ? car.veh_make.make : 'Unknown Make';
            const model = car.veh_model ? car.veh_model.model : 'Unknown Model';
            newRentalCarSelect.innerHTML += `<option value="${car.id}">${make} ${model} (${car.plate_number})</option>`;
        });
        applyTranslations(); // Re-apply translations after populating options

        // Populate customer dropdown
        const { data: customers, error: customersError } = await supabaseClient
            .from('customers')
            .select('id, first_name, last_name, phone_number');

        if (customersError) {
            console.error('Error fetching customers:', customersError.message);
            showStatus('statusMessageErrorLoadingCustomers', false, addRentalStatusMessage);
            return;
        }

        newRentalCustomerSelect.innerHTML = `<option value="" data-i18n-key="selectCustomerOption">${getTranslation('selectCustomerOption')}</option>`;
        customers.forEach(customer => {
            newRentalCustomerSelect.innerHTML += `<option value="${customer.id}">${customer.first_name} ${customer.last_name} (${customer.phone_number})</option>`;
        });
        applyTranslations(); // Re-apply translations after populating options

        // Set today's date as default for from_date and end_date
        const today = new Date().toISOString().split('T')[0];
        newRentalFromDateInput.value = today;
        newRentalEndDateInput.value = today;
    }

    // Event listener for new rental form submission
    addNewRentalForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        showStatus('statusMessageProcessingRental', true, addRentalStatusMessage); // Indicate processing

        const car_id = newRentalCarSelect.value;
        const customer_id = newRentalCustomerSelect.value;
        const from_date = newRentalFromDateInput.value;
        const end_date = newRentalEndDateInput.value;
        const initial_odometer_km = parseFloat(newRentalInitialOdometerInput.value);
        const final_odometer_km = newRentalFinalOdometerInput.value ? parseFloat(newRentalFinalOdometerInput.value) : null; // Optional
        const rental_price_per_day = parseFloat(newRentalPricePerDayInput.value);
        const paid_amount = parseFloat(newRentalPaidAmountInput.value);
        const payment_status = newRentalPaymentStatusSelect.value;
        const status = newRentalStatusSelect.value;
        const traffic_fines = newRentalTrafficFinesInput.value ? parseFloat(newRentalTrafficFinesInput.value) : 0.00; // Optional, default 0
        const car_repair = newRentalCarRepairInput.value ? parseFloat(newRentalCarRepairInput.value) : 0.00; // Optional, default 0
        const notes = newRentalNotesTextarea.value;

        // Basic validation
        if (!car_id || !customer_id || !from_date || !end_date || isNaN(initial_odometer_km) || isNaN(rental_price_per_day)) {
            showStatus('statusMessageErrorGeneric', false, addRentalStatusMessage); // Generic error for missing required fields
            return;
        }

        const fromDateObj = new Date(from_date);
        const endDateObj = new Date(end_date);

        if (endDateObj < fromDateObj) {
            showStatus('statusMessageInvalidDates', false, addRentalStatusMessage);
            return;
        }

        const timeDiff = endDateObj.getTime() - fromDateObj.getTime();
        const rented_days = Math.ceil(timeDiff / (1000 * 3600 * 24)); // Calculate days, round up

        const total_price = rented_days * rental_price_per_day;
        const balance = total_price - paid_amount;

        const newRentalData = {
            car_id: parseInt(car_id), // Ensure car_id is integer
            customer_id: customer_id,
            from_date: from_date,
            end_date: end_date,
            rented_days: rented_days,
            initial_odometer_km: initial_odometer_km,
            final_odometer_km: final_odometer_km,
            rental_price_per_day: rental_price_per_day,
            total_price: total_price,
            paid_amount: paid_amount,
            balance: balance,
            payment_status: payment_status,
            status: status,
            traffic_fines: traffic_fines,
            car_repair: car_repair,
            notes: notes,
            // actual_return_date is null by default for new rentals, unless explicitly set
        };

        const { data, error } = await supabaseClient
            .from('rent_history')
            .insert([newRentalData]);

        if (error) {
            console.error('Error adding new rental:', error.message, error);
            showStatus('statusMessageRentalAddError', false, addRentalStatusMessage);
        } else {
            showStatus('statusMessageRentalAddedSuccess', true, addRentalStatusMessage);
            addNewRentalForm.reset(); // Clear the form after successful submission
            initNewRentalForm(); // Re-initialize dropdowns and dates
            fetchRentHistory(); // Refresh the table
        }
    });

    // Event listener for clearing the new rental form
    clearNewRentalFormButton.addEventListener('click', () => {
        addNewRentalForm.reset();
        initNewRentalForm(); // Re-initialize dropdowns and dates
        addRentalStatusMessage.style.display = 'none'; // Hide any status messages
    });


    // Event Listeners for language buttons
    langArBtn.addEventListener('click', () => {
        currentLang = 'ar';
        localStorage.setItem('lang', 'ar');
        applyTranslations();
        fetchRentHistory(); // Re-fetch to update content with new language
        initNewRentalForm(); // Re-initialize form dropdowns with new language
    });

    langEnBtn.addEventListener('click', () => {
        currentLang = 'en';
        localStorage.setItem('lang', 'en');
        applyTranslations();
        fetchRentHistory(); // Re-fetch to update content with new language
        initNewRentalForm(); // Re-initialize form dropdowns with new language
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        // Check authentication status first
        supabaseClient.auth.getSession().then(({ data: { session }, error }) => {
            if (error || !session) {
                // If no session or error, redirect to admin.html
                window.location.href = 'admin.html';
            } else {
                // If authenticated, proceed with page initialization
                applyTranslations();
                fetchRentHistory();
                initNewRentalForm(); // Initialize the new rental form on page load
            }
        });
    });

    // Dummy function to ensure script ends cleanly
    function _dummyFunctionToEndScript() {
        // This function exists solely to ensure the script block is properly closed.
    }
  </script>
</html>
