
<!DOCTYPE html>
<html lang="en">
<head>
<script>
    // Supabase configuration - these are globally defined in the Canvas environment
    // and would typically be loaded securely or provided by the platform.
    const SUPABASE_URL = 'https://yzwfldypkwqndxjchgit.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6d2ZsZHlwa3dxbmR4amNoZ2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzMjA0OTUsImV4cCI6MjA2NDg5NjQ5NX0.i3HOii7L9mJ-cBZ2us3TRmS0-GI9b9ylHuLe9INAu4zY'; // Ensure this is your public 'anon' key
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Payment - Fox Car Rental</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Stripe.js CDN - Required for Stripe payment integration -->
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* A light gray background from rent-history.html */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #5680E9;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Define custom colors from the rent-history.html */
        .bg-custom-blue-dark { background-color: #5680E9; }
        .bg-custom-blue-light { background-color: #84CEEB; }
        .bg-custom-cyan { background-color: #5AB9EA; }
        .bg-custom-light-purple { background-color: #C1C8E4; }
        .bg-custom-purple { background-color: #8860D0; }

        .text-custom-blue-dark { color: #5680E9; }
        .text-custom-blue-light { color: #84CEEB; }
        .text-custom-cyan { color: #5AB9EA; }
        .text-custom-light-purple { color: #C1C8E4; }
        .text-custom-purple { color: #8860D0; }

        .border-custom-blue-dark { border-color: #5680E9; }
        .border-custom-blue-light { border-color: #84CEEB; }
        .border-custom-cyan { border-color: #5AB9EA; }
        .border-custom-light-purple { border-color: #C1C8E4; }
        .border-custom-purple { border-color: #8860D0; }

        /* Keyframes for the gradient animation from rent-history.html */
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Animated gradient background applied to the main content area via a pseudo-element */
        #main-page-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1; /* Places the gradient behind the content */
            background: linear-gradient(135deg, #5680E9, #84CEEB, #5AB9EA, #C1C8E4, #8860D0);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
        }
    </style>
</head>
<body>

    <div id="main-page-content" class="container mx-auto p-4 sm:p-6 lg:p-8 relative z-10 overflow-hidden min-h-screen">
        <div class="max-w-4xl mx-auto">
            <!-- Page Header -->
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Add Customer Payment</h1>
                <a href="rent-history.html" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Rent History
                </a>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="text-center p-10">
                <div class="loader inline-block"></div>
                <p class="mt-4 text-gray-600">Loading Agreement Details...</p>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mb-6 hidden" role="alert">
                <strong class="font-bold">Error!</strong>
                <span id="error-text-payment" class="block sm:inline">Could not load agreement details.</span>
            </div>
            
            <!-- Main Content (hidden until loaded) -->
            <div id="payment-content" class="hidden">
                <!-- Agreement Summary -->
                <div class="bg-white shadow-lg rounded-xl p-6 mb-6">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h2 class="text-2xl font-semibold text-gray-800">Agreement Summary</h2>
                        <button id="print-invoice-btn" class="bg-custom-purple text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200 flex items-center">
                            <i class="fas fa-print mr-2"></i>Print Invoice
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">Agreement No.</p>
                            <p id="summary-agreement-no" class="font-semibold text-lg text-gray-900"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Customer Name</p>
                            <p id="summary-customer-name" class="font-semibold text-lg text-gray-900"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Total Price</p>
                            <p id="summary-total-price" class="font-semibold text-gray-900"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Total Paid</p>
                            <p id="summary-total-paid" class="font-semibold text-green-600"></p>
                        </div>
                        <div class="md:col-span-2">
                            <p class="text-gray-500">Balance Due</p>
                            <p id="summary-balance-due" class="font-bold text-2xl text-red-600"></p>
                        </div>
                    </div>
                </div>

                <!-- Payment Form and History -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Add Payment Form -->
                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Record a New Payment</h2>
                        <form id="add-payment-form" class="space-y-4">
                            <div>
                                <label for="amount-to-pay" class="block text-sm font-medium text-gray-700">Amount to Pay (AED)</label>
                                <input type="number" id="amount-to-pay" name="amount-to-pay" step="0.01" min="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light" required>
                                <p id="amount-error" class="text-red-500 text-sm mt-1 hidden"></p>
                            </div>
                            <div>
                                <label for="payment-date" class="block text-sm font-medium text-gray-700">Payment Date</label>
                                <input type="date" id="payment-date" name="payment-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light" required>
                            </div>
                            <div>
                                <label for="payment-method" class="block text-sm font-medium text-gray-700">Payment Method</label>
                                <select id="payment-method" name="payment-method" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light" required>
                                    <option value="Cash">Cash</option>
                                    <option value="Visa">Visa</option>
                                    <option value="Mastercard">Mastercard</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="payment-notes" class="block text-sm font-medium text-gray-700">Notes (Optional)</label>
                                <textarea id="payment-notes" name="payment-notes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light"></textarea>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button type="submit" id="submit-payment-btn" class="w-full bg-custom-blue-dark text-white px-6 py-3 rounded-lg shadow-md hover:bg-custom-blue-light transition-all duration-200 flex items-center justify-center">
                                    <span id="submit-btn-text">Submit Cash/Bank Payment</span>
                                    <div id="submit-loader" class="loader !w-5 !h-5 !border-2 ml-2 hidden"></div>
                                </button>
                                <!-- New Stripe Payment Button -->
                                <button type="button" id="stripe-payment-btn" class="w-full bg-green-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-600 transition-all duration-200 flex items-center justify-center">
                                    <i class="fab fa-stripe mr-2"></i> Pay with Card (Stripe)
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Payment History -->
                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Payment History</h2>
                        <div id="payment-history-container" class="space-y-3 max-h-96 overflow-y-auto">
                           <!-- Payment history items will be dynamically loaded here -->
                           <p id="no-payments-message" class="text-center text-gray-500 p-4">No payments recorded yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for notifications -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center">
            <h3 id="notification-title" class="text-xl font-bold mb-4">Notification</h3>
            <p id="notification-message" class="text-gray-700 mb-6"></p>
            <button id="notification-close-button" class="bg-custom-blue-dark text-white px-6 py-2 rounded-lg hover:bg-custom-blue-light focus:outline-none focus:ring-2 focus:ring-custom-blue-light focus:ring-opacity-50">OK</button>
        </div>
    </div>


    <script type="module">
        // Supabase Configuration
        const SUPABASE_URL = 'https://yzwfldypkwqndxjchgit.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6d2ZsZHlwa3dxbmR4amNoZ2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzMjA0OTUsImV4cCI6MjA2NDg5NjQ5NX0.i3HOii7L9mJ-cBZ2us3TRmS0-GI9bylHuLe9INAu4zY';

        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Initialize Stripe with your publishable key (Replace with your actual public key)
        const stripe = Stripe('pk_test_51Rx7JeE6ijlcNsjs8Dov9xgwUsBFs59yD23axri9vH7KtcuskoUfLfnlfbWSau3BFGLspYz25CrndXDHOcExlvXv00bnx87gi0');

        // DOM Elements
        const ui = {
            loadingIndicator: document.getElementById('loading-indicator'),
            errorMessage: document.getElementById('error-message'),
            errorText: document.getElementById('error-text-payment'),
            paymentContent: document.getElementById('payment-content'),
            summaryAgreementNo: document.getElementById('summary-agreement-no'),
            summaryCustomerName: document.getElementById('summary-customer-name'),
            summaryTotalPrice: document.getElementById('summary-total-price'),
            summaryTotalPaid: document.getElementById('summary-total-paid'),
            summaryBalanceDue: document.getElementById('summary-balance-due'),
            addPaymentForm: document.getElementById('add-payment-form'),
            amountToPayInput: document.getElementById('amount-to-pay'),
            amountError: document.getElementById('amount-error'),
            paymentDateInput: document.getElementById('payment-date'),
            paymentHistoryContainer: document.getElementById('payment-history-container'),
            noPaymentsMessage: document.getElementById('no-payments-message'),
            submitPaymentBtn: document.getElementById('submit-payment-btn'),
            submitBtnText: document.getElementById('submit-btn-text'),
            submitLoader: document.getElementById('submit-loader'),
            notificationModal: document.getElementById('notification-modal'),
            notificationTitle: document.getElementById('notification-title'),
            notificationMessage: document.getElementById('notification-message'),
            notificationCloseButton: document.getElementById('notification-close-button'),
            printInvoiceBtn: document.getElementById('print-invoice-btn'),
            stripePaymentBtn: document.getElementById('stripe-payment-btn'), // New Stripe button
        };

        let currentRentalRecord = null;
        let rentHistoryId = null;
        let paymentHistory = [];
        let trafficFinesForCar = []; // Store fetched fines

        // --- Modal Logic ---
        function showCustomMessageBox(title, message) {
            ui.notificationTitle.textContent = title;
            ui.notificationMessage.textContent = message;
            ui.notificationModal.classList.remove('hidden');
        }

        ui.notificationCloseButton.addEventListener('click', () => {
             ui.notificationModal.classList.add('hidden');
        });

        // --- Helper Functions ---
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString.includes('T') ? dateString : dateString + 'T00:00:00Z');
            if (isNaN(date.getTime())) return 'N/A';
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // --- Data Fetching and Rendering ---
        async function loadPaymentPage() {
            const params = new URLSearchParams(window.location.search);
            rentHistoryId = params.get('id');

            if (!rentHistoryId) {
                showError("No rental agreement ID provided. Please go back and select an agreement.");
                return;
            }

            try {
                // Fetch rental record with car_id, from_date, end_date, AND car_repair
                const { data: rentalData, error: rentalError } = await supabaseClient
                    .from('rent_history')
                    .select('*, customers(first_name, last_name, email), cars(id, plate_number), car_repair') // Added customer email here
                    .eq('id', rentHistoryId)
                    .single();
                if (rentalError) throw rentalError;
                currentRentalRecord = rentalData;

                // Extract car_id and plate_number
                const rentedCarPlateNumber = currentRentalRecord.cars ? currentRentalRecord.cars.plate_number : 'N/A';

                // Fetch payments
                const { data: paymentsData, error: paymentsError } = await supabaseClient
                    .from('payments')
                    .select('*')
                    .eq('rent_history_id', rentHistoryId)
                    .order('payment_date', { ascending: false });
                if (paymentsError) throw paymentsError;
                paymentHistory = paymentsData;

                // Fetch traffic fines for the car
                if (rentedCarPlateNumber !== 'N/A') {
                    const { data: finesData, error: finesError } = await supabaseClient
                        .from('traffic_fines')
                        .select('*')
                        .eq('plate_number', rentedCarPlateNumber);
                    if (finesError) console.error("Error fetching traffic fines:", finesError); // Log but don't block
                    trafficFinesForCar = finesData || [];
                }

                renderPageContent(currentRentalRecord, paymentHistory);

            } catch (error) {
                console.error("Error loading page data:", error);
                showError(`Failed to load data: ${error.message}`);
            }
        }

        function renderPageContent(rental, payments) {
            // Hide loader, show content
            ui.loadingIndicator.classList.add('hidden');
            ui.paymentContent.classList.remove('hidden');

            // Render summary
            const customer = rental.customers || {};
            ui.summaryAgreementNo.textContent = rental.agreement_number || 'N/A';
            ui.summaryCustomerName.textContent = `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'N/A';
            
            updateSummaryValues(rental);

            // Render payment history
            renderPaymentHistory(payments);
        }
        
        function updateSummaryValues(rental) {
            const balance = parseFloat(rental.balance || 0);
            ui.summaryTotalPrice.textContent = `AED ${parseFloat(rental.total_price || 0).toFixed(2)}`;
            ui.summaryTotalPaid.textContent = `AED ${parseFloat(rental.paid_amount || 0).toFixed(2)}`;
            ui.summaryBalanceDue.textContent = `AED ${balance.toFixed(2)}`;

            // Update amount input max value
            ui.amountToPayInput.max = balance.toFixed(2);
            ui.amountToPayInput.value = balance > 0 ? balance.toFixed(2) : '';

            // If balance is zero or less, disable the form
            if (balance <= 0) {
                ui.addPaymentForm.querySelectorAll('input, select, button, textarea').forEach(el => el.disabled = true);
                ui.submitBtnText.textContent = "Fully Paid";
                // Optionally disable Stripe button as well if payment is not needed
                ui.stripePaymentBtn.disabled = true; 
                ui.stripePaymentBtn.classList.add('opacity-50', 'cursor-not-allowed');

                ui.summaryBalanceDue.classList.remove('text-red-600');
                ui.summaryBalanceDue.classList.add('text-green-600');
            } else {
                // Re-enable buttons if balance becomes positive (e.g., after an invoice adjustment)
                ui.addPaymentForm.querySelectorAll('input, select, button, textarea').forEach(el => el.disabled = false);
                ui.submitBtnText.textContent = "Submit Cash/Bank Payment";
                ui.stripePaymentBtn.disabled = false;
                ui.stripePaymentBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                ui.summaryBalanceDue.classList.remove('text-green-600');
                ui.summaryBalanceDue.classList.add('text-red-600');
            }
        }


        function renderPaymentHistory(payments) {
            ui.paymentHistoryContainer.innerHTML = ''; // Clear
            if (!payments || payments.length === 0) {
                ui.noPaymentsMessage.classList.remove('hidden');
                ui.paymentHistoryContainer.appendChild(ui.noPaymentsMessage);
                return;
            }
            // Hide "No payments" message if payments exist
            ui.noPaymentsMessage.classList.add('hidden'); 
            
            payments.forEach(payment => {
                const paymentCard = document.createElement('div');
                paymentCard.className = 'border rounded-lg p-3 flex justify-between items-center';
                paymentCard.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${formatDate(payment.payment_date)}</p>
                        <p class="text-xs text-gray-500">${payment.payment_method} ${payment.notes ? `- ${payment.notes}` : ''}</p>
                    </div>
                    <p class="font-bold text-lg text-green-600">AED ${parseFloat(payment.amount).toFixed(2)}</p>
                `;
                ui.paymentHistoryContainer.appendChild(paymentCard);
            });
        }

        function showError(message) {
            ui.loadingIndicator.classList.add('hidden');
            ui.errorText.textContent = message;
            ui.errorMessage.classList.remove('hidden');
        }

        // --- Form Submission Logic (Cash/Bank Transfer) ---
        ui.addPaymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amountToPay = parseFloat(ui.amountToPayInput.value);
            const balanceDue = parseFloat(currentRentalRecord.balance);

            // Validation
            ui.amountError.classList.add('hidden');
            if (isNaN(amountToPay) || amountToPay <= 0) {
                ui.amountError.textContent = "Please enter a valid positive amount.";
                ui.amountError.classList.remove('hidden');
                return;
            }
            if (amountToPay > balanceDue) {
                ui.amountError.textContent = `Payment cannot exceed the balance of AED ${balanceDue.toFixed(2)}.`;
                ui.amountError.classList.remove('hidden');
                return;
            }

            setSubmitButtonState(true); // Disable button and show loader

            try {
                // 1. Insert new payment record
                const newPayment = {
                    rent_history_id: rentHistoryId,
                    amount: amountToPay,
                    payment_date: ui.paymentDateInput.value,
                    payment_method: document.getElementById('payment-method').value,
                    notes: document.getElementById('payment-notes').value,
                    status: 'succeeded' // Assuming cash/bank payments are immediately succeeded
                };
                const { error: paymentInsertError } = await supabaseClient
                    .from('payments')
                    .insert([newPayment]);
                
                if (paymentInsertError) throw paymentInsertError;

                // 2. Update the rent_history record
                const newPaidAmount = parseFloat(currentRentalRecord.paid_amount || 0) + amountToPay;
                const newBalance = parseFloat(currentRentalRecord.total_price || 0) - newPaidAmount;
                const newPaymentStatus = newBalance <= 0 ? 'Paid' : 'Partially Paid';
                
                const { data: updatedRecord, error: updateError } = await supabaseClient
                    .from('rent_history')
                    .update({ 
                        paid_amount: newPaidAmount,
                        balance: newBalance,
                        payment_status: newPaymentStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', rentHistoryId)
                    .select('*, customers(first_name, last_name, email), cars(id, plate_number), car_repair') // Re-select email
                    .single();
                
                if (updateError) throw updateError;
                
                // 3. Success: Reset form and refresh data
                currentRentalRecord = updatedRecord; // Update the global record
                ui.addPaymentForm.reset();
                setTodayDate(); // Reset date to today
                
                // Refresh payment history list
                const { data: paymentsData, error: paymentsError } = await supabaseClient
                    .from('payments')
                    .select('*')
                    .eq('rent_history_id', rentHistoryId)
                    .order('payment_date', { ascending: false });
                
                if (paymentsError) throw paymentsError;
                
                paymentHistory = paymentsData;
                renderPaymentHistory(paymentHistory);
                updateSummaryValues(currentRentalRecord);

                showCustomMessageBox("Success", "Cash/Bank payment recorded successfully!");

            } catch (error) {
                console.error("Error submitting cash/bank payment:", error);
                showCustomMessageBox("Error", `Failed to record payment: ${error.message}`);
            } finally {
                setSubmitButtonState(false); // Re-enable button
            }
        });

        function setSubmitButtonState(isLoading) {
            if (isLoading) {
                ui.submitPaymentBtn.disabled = true;
                ui.submitBtnText.classList.add('hidden');
                ui.submitLoader.classList.remove('hidden');
            } else {
                ui.submitPaymentBtn.disabled = false;
                ui.submitBtnText.classList.remove('hidden');
                ui.submitLoader.classList.add('hidden');
            }
        }

        // --- Stripe Payment Button Logic ---
        ui.stripePaymentBtn.addEventListener('click', async () => {
            const amountToPay = parseFloat(ui.amountToPayInput.value);
            const balanceDue = parseFloat(currentRentalRecord.balance);

            // Validation similar to cash payment
            ui.amountError.classList.add('hidden');
            if (isNaN(amountToPay) || amountToPay <= 0) {
                ui.amountError.textContent = "Please enter a valid positive amount for online payment.";
                ui.amountError.classList.remove('hidden');
                return;
            }
            if (amountToPay > balanceDue) {
                ui.amountError.textContent = `Online payment cannot exceed the balance of AED ${balanceDue.toFixed(2)}.`;
                ui.amountError.classList.remove('hidden');
                return;
            }

            // Show loading indicator
            setSubmitButtonState(true);
            ui.stripePaymentBtn.disabled = true;
            ui.stripePaymentBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const customerEmail = currentRentalRecord.customers?.email || '';

                const response = await fetch('/api/create-checkout-session', { // CORRECTED LINE: Changed from http://localhost:4242 to /api/
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: amountToPay, // Send as AED, backend converts to cents
                        rentHistoryId: rentHistoryId,
                        customerEmail: customerEmail,
                        successUrl: window.location.origin + '/success.html?session_id={CHECKOUT_SESSION_ID}&rentHistoryId=' + rentHistoryId,
                        cancelUrl: window.location.origin + '/cancel.html?rentHistoryId=' + rentHistoryId
                    }),
                });
                const session = await response.json();

                if (session.error) {
                    throw new Error(session.error);
                }

                // Redirect to Stripe Checkout page
                const { error } = await stripe.redirectToCheckout({
                    sessionId: session.id,
                });

                if (error) {
                    throw error;
                }
            } catch (error) {
                console.error("Error initiating Stripe Checkout:", error);
                showCustomMessageBox("Stripe Checkout Error", `Failed to initiate online payment: ${error.message}`);
                setSubmitButtonState(false); // Re-enable main submit button
                ui.stripePaymentBtn.disabled = false;
                ui.stripePaymentBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            // Note: setSubmitButtonState(false) and re-enabling stripePaymentBtn
            // are handled *after* redirection or if an error occurs *before* redirection.
            // If redirection is successful, the page will unload.
        });

        // --- Invoice Printing Logic ---
        ui.printInvoiceBtn.addEventListener('click', () => {
            if (!currentRentalRecord) {
                showCustomMessageBox("Error", "Cannot print invoice, rental data is not loaded.");
                return;
            }
            printInvoice();
        });

        function printInvoice() {
            const customer = currentRentalRecord.customers || {};
            const customerName = `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'N/A';
            
            // Calculate rental days and base rental amount
            const startDate = new Date(currentRentalRecord.from_date);
            const endDate = new Date(currentRentalRecord.end_date);
            const timeDiff = endDate.getTime() - startDate.getTime();
            // Ensure at least 1 day for rental, round up to full days
            const rentalDays = Math.max(1, Math.ceil(timeDiff / (1000 * 60 * 60 * 24))); 
            const dailyRate = parseFloat(currentRentalRecord.rental_price_per_day || 0);
            const baseRentalAmount = dailyRate * rentalDays;

            // Traffic Fines details
            let trafficFinesHtml = '';
            let totalFinesAmount = 0;
            if (trafficFinesForCar.length > 0) {
                trafficFinesForCar.forEach(fine => {
                    const fineTotal = parseFloat(fine.total_amount || 0);
                    totalFinesAmount += fineTotal;
                    trafficFinesHtml += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">${fine.fine_number || 'N/A'}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${formatDate(fine.fine_date)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${fine.plate_number || 'N/A'}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">AED ${fineTotal.toFixed(2)}</td>
                        </tr>
                    `;
                });
            } else {
                trafficFinesHtml = '<tr><td colspan="4" style="padding: 8px; border: 1px solid #ddd; text-align: center;">No traffic fines recorded for this vehicle.</td></tr>';
            }

            // Get repair cost from currentRentalRecord.car_repair
            const repairCost = parseFloat(currentRentalRecord.car_repair || 0);


            // Payment History details
            let paymentHistoryHtml = '';
            if (paymentHistory.length > 0) {
                paymentHistory.forEach(p => {
                    paymentHistoryHtml += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">${formatDate(p.payment_date)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${p.payment_method}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">AED ${parseFloat(p.amount).toFixed(2)}</td>
                        </tr>
                    `;
                });
            } else {
                paymentHistoryHtml = '<tr><td colspan="3" style="padding: 8px; border: 1px solid #ddd; text-align: center;">No payments found.</td></tr>';
            }

            const invoiceContent = `
                <html>
                <head>
                    <title>Invoice - ${currentRentalRecord.agreement_number}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; color: #333; margin: 0; padding: 0; }
                        .invoice-container { max-width: 800px; margin: 20px auto; padding: 20px; border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
                        .header { text-align: center; border-bottom: 2px solid #5680E9; padding-bottom: 10px; margin-bottom: 20px; }
                        .header h1 { margin: 0; color: #5680E9; font-size: 2.5em; }
                        .header p { margin: 2px 0; }
                        .details-section { display: flex; justify-content: space-between; margin-bottom: 20px; }
                        .details-section div { width: 48%; }
                        h2, h3 { color: #5680E9; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 20px; margin-bottom: 10px;}
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .summary-table td:first-child { font-weight: bold; }
                        .summary-table td:last-child { text-align: right; font-weight: bold; }
                        .total-due { font-size: 1.5em; color: #d9534f; }
                        .footer { text-align: center; margin-top: 30px; font-size: 0.9em; color: #777; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                            .invoice-container { box-shadow: none; border: none; margin: 0; padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <div class="header">
                            <h1>Fox Car Rental</h1>
                            <p>123 Desert Drive, Dubai, UAE</p>
                            <p>Phone: +971 4 123 4567 | Email: contact@foxrental.ae</p>
                        </div>
                        
                        <h2>Invoice</h2>

                        <div class="details-section">
                            <div>
                                <strong>Billed To:</strong><br>
                                ${customerName}<br>
                                Agreement No: ${currentRentalRecord.agreement_number || 'N/A'}
                            </div>
                            <div>
                                <strong>Date Issued:</strong><br>
                                ${formatDate(new Date().toISOString())}
                            </div>
                        </div>

                        <h3>Rental Details</h3>
                        <table class="summary-table">
                            <tr><td>Daily Rental Rate</td><td>AED ${dailyRate.toFixed(2)}</td></tr>
                            <tr><td>Rental Period</td><td>${rentalDays} Days (From ${formatDate(startDate.toISOString())} to ${formatDate(endDate.toISOString())})</td></tr>
                            <tr><td>Base Rental Amount (${dailyRate.toFixed(2)} x ${rentalDays} Days)</td><td>AED ${baseRentalAmount.toFixed(2)}</td></tr>
                            <tr><td>Vehicle Plate Number</td><td>${currentRentalRecord.cars ? currentRentalRecord.cars.plate_number : 'N/A'}</td></tr>
                            <tr><td>Total Rental Price (as per agreement)</td><td>AED ${parseFloat(currentRentalRecord.total_price || 0).toFixed(2)}</td></tr>
                        </table>

                        <h3>Traffic Fines</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Fine #</th>
                                    <th>Date</th>
                                    <th>Plate #</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${trafficFinesHtml}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" style="text-align: right;">Total Fines:</th>
                                    <th style="text-align: right;">AED ${totalFinesAmount.toFixed(2)}</th>
                                </tr>
                            </tfoot>
                        </table>

                        <h3>Repair Costs</h3>
                        <table class="summary-table">
                            <tr><td>Total Repair Costs for this Vehicle</td><td>AED ${repairCost.toFixed(2)}</td></tr>
                        </table>

                        <h3>Payment History</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Method</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${paymentHistoryHtml}
                            </tbody>
                        </table>

                        <h3>Overall Summary</h3>
                        <table class="summary-table">
                            <tr><td>Total Rental Price</td><td>AED ${parseFloat(currentRentalRecord.total_price || 0).toFixed(2)}</td></tr>
                            <tr><td>Total Fines</td><td>AED ${totalFinesAmount.toFixed(2)}</td></tr>
                            <tr><td>Total Repair Costs</td><td>AED ${repairCost.toFixed(2)}</td></tr>
                            <tr><td>Grand Total (Rental + Fines + Repairs)</td><td>AED ${(parseFloat(currentRentalRecord.total_price || 0) + totalFinesAmount + repairCost).toFixed(2)}</td></tr>
                            <tr><td>Total Amount Paid</td><td>AED ${parseFloat(currentRentalRecord.paid_amount || 0).toFixed(2)}</td></tr>
                            <tr><td class="total-due">Balance Due</td><td class="to