<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent History - Fox Car Rental Admin</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Custom scrollbar for the sidebar */
        .sidebar-scroll {
            scrollbar-width: thin;
            scrollbar-color: #5AB9EA #F3F4F6;
        }
        .sidebar-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: #F3F4F6;
            border-radius: 10px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background-color: #5AB9EA;
            border-radius: 10px;
            border: 2px solid #F3F4F6;
        }

        /* Custom styles for the background gradient */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #5680E9, #84CEEB, #5AB9EA, #C1C8E4, #8860D0);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Define custom colors from the image */
        .bg-custom-blue-dark { background-color: #5680E9; }
        .bg-custom-blue-light { background-color: #84CEEB; }
        .bg-custom-cyan { background-color: #5AB9EA; }
        .bg-custom-light-purple { background-color: #C1C8E4; }
        .bg-custom-purple { background-color: #8860D0; }

        .text-custom-blue-dark { color: #5680E9; }
        .text-custom-blue-light { color: #84CEEB; }
        .text-custom-cyan { color: #5AB9EA; }
        .text-custom-light-purple { color: #C1C8E4; }
        .text-custom-purple { color: #8860D0; }

        .border-custom-blue-dark { border-color: #5680E9; }
        .border-custom-blue-light { border-color: #84CEEB; }
        .border-custom-cyan { border-color: #5AB9EA; }
        .border-custom-light-purple { border-color: #C1C8E4; }
        .border-custom-purple { border-color: #8860D0; }
    </style>
</head>
<body class="flex flex-col lg:flex-row min-h-screen text-gray-800">

    <!-- Sidebar for Desktop -->
    <aside class="hidden lg:flex flex-col w-64 bg-white shadow-lg rounded-r-xl p-4 overflow-y-auto sidebar-scroll">
        <div class="flex items-center justify-center p-4 mb-6">
            <img src="https://placehold.co/40x40/5680E9/ffffff?text=F" alt="Fox Car Rental Logo" class="w-10 h-10 rounded-full mr-3">
            <h1 class="text-xl font-bold text-gray-800">Fox Car Rental Admin</h1>
        </div>
        <nav class="flex-grow">
            <ul>
                <li class="mb-2">
                    <a href="dashboard.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                        <i class="fas fa-tachometer-alt mr-3"></i>
                        Dashboard
                    </a>
                </li>
                <li class="mb-2">
                    <a href="vehicle-inventory.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                        <i class="fas fa-car mr-3"></i>
                        Vehicle Inventory
                    </a>
                </li>
                <li class="mb-2">
                    <a href="customer-list.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                        <i class="fas fa-users mr-3"></i>
                        Customer List
                    </a>
                </li>
                <li class="mb-2">
                    <a href="rent-history.html" class="flex items-center p-3 rounded-lg bg-custom-blue-light text-white shadow-md transition-all duration-200 hover:bg-custom-blue-dark">
                        <i class="fas fa-history mr-3"></i>
                        Rent History
                    </a>
                </li>
                <li class="mb-2">
                    <a href="reports.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                        <i class="fas fa-chart-bar mr-3"></i>
                        Reports
                    </a>
                </li>
                <li class="mb-2">
                    <a href="financial-dashboard.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                        <i class="fas fa-dollar-sign mr-3"></i>
                        Financial Dashboard
                    </a>
                </li>
                <li class="mb-2">
                    <a href="vehicle-maintenance.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                        <i class="fas fa-wrench mr-3"></i>
                        Vehicle Maintenance
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col p-4 sm:p-6 lg:p-8">
        <!-- Top Nav for Mobile & Desktop -->
        <header class="bg-white shadow-md rounded-xl p-4 mb-6 flex items-center justify-between lg:hidden">
            <div class="flex items-center">
                <img src="https://placehold.co/30x30/5680E9/ffffff?text=F" alt="Fox Car Rental Logo" class="w-8 h-8 rounded-full mr-2">
                <h1 class="text-lg font-bold text-gray-800">Fox Car Rental Admin</h1>
            </div>
            <button id="mobile-menu-button" class="text-gray-600 focus:outline-none focus:text-gray-900">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </header>

        <!-- Mobile Sidebar Overlay -->
        <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>
        <aside id="mobile-sidebar" class="fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-50 transform -translate-x-full transition-transform duration-300 ease-in-out lg:hidden overflow-y-auto sidebar-scroll">
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <div class="flex items-center">
                    <img src="https://placehold.co/40x40/5680E9/ffffff?text=F" alt="Fox Car Rental Logo" class="w-10 h-10 rounded-full mr-3">
                    <h1 class="text-xl font-bold text-gray-800">Fox Car Rental Admin</h1>
                </div>
                <button id="close-mobile-menu-button" class="text-gray-600 focus:outline-none focus:text-gray-900">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <nav class="p-4">
                <ul>
                    <li class="mb-2">
                        <a href="dashboard.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                            <i class="fas fa-tachometer-alt mr-3"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="vehicle-inventory.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                            <i class="fas fa-car mr-3"></i>
                            Vehicle Inventory
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="customer-list.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                            <i class="fas fa-users mr-3"></i>
                            Customer List
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="rent-history.html" class="flex items-center p-3 rounded-lg bg-custom-blue-light text-white shadow-md transition-all duration-200 hover:bg-custom-blue-dark">
                            <i class="fas fa-history mr-3"></i>
                            Rent History
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="reports.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                            <i class="fas fa-chart-bar mr-3"></i>
                            Reports
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="financial-dashboard.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                            <i class="fas fa-dollar-sign mr-3"></i>
                            Financial Dashboard
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="vehicle-maintenance.html" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                            <i class="fas fa-wrench mr-3"></i>
                            Vehicle Maintenance
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Rent History Header -->
        <div class="bg-white shadow-md rounded-xl p-4 mb-6 flex items-center justify-between">
            <h2 class="text-2xl font-semibold text-gray-800">Rent History</h2>
            <div class="flex items-center space-x-4">
                <!-- Add Rent Record button (optional, based on image) -->
                <!-- <button id="add-rent-button" class="bg-custom-blue-dark text-white px-4 py-2 rounded-lg shadow-md hover:bg-custom-blue-light transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i>Add Rent Record
                </button> -->
            </div>
        </div>

        <!-- Error Message Display -->
        <div id="app-error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mb-4 hidden" role="alert">
            <strong class="font-bold">Error!</strong>
            <span id="error-text" class="block sm:inline">Something went wrong.</span>
        </div>

        <!-- Filters Section -->
        <div class="bg-white shadow-md rounded-xl p-4 mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="relative">
                <select id="status-filter" class="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-custom-blue-light">
                    <option value="All">All Status</option>
                    <option value="Active">Active</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
                <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
            </div>
            <div class="relative">
                <select id="payment-status-filter" class="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-custom-blue-light">
                    <option value="All">All Payment Status</option>
                    <option value="Paid">Paid</option>
                    <option value="Partially Paid">Partially Paid</option>
                    <option value="Unpaid">Unpaid</option>
                </select>
                <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
            </div>
            <div>
                <input type="text" id="car-plate-filter" placeholder="Filter by Car Plate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-blue-light">
            </div>
            <div>
                <input type="text" id="customer-filter" placeholder="Filter by Customer Name/Phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-blue-light">
            </div>
        </div>

        <!-- Rent History List -->
        <div id="rent-history-list" class="space-y-4">
            <!-- Rent history items will be dynamically loaded here -->
            <div id="loading-message" class="col-span-full text-center text-gray-600">
                Loading rent history...
            </div>
            <p id="no-records-message" class="col-span-full text-center text-gray-600 hidden">
                <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-2"></i><br>
                No rent history records found.
            </p>
        </div>
    </div>

    <!-- Edit Rent Record Modal -->
    <div id="rent-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 w-11/12 max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-2xl font-semibold text-gray-800 mb-4">Edit Rent Record</h3>
            <form id="rent-form" class="space-y-4">
                <div>
                    <label for="car_search_input" class="block text-sm font-medium text-gray-700">Search Vehicle</label>
                    <input type="text" id="car_search_input" placeholder="Search by plate number, make, or model" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light">
                </div>
                <div>
                    <label for="car_id" class="block text-sm font-medium text-gray-700">Vehicle</label>
                    <select id="car_id" name="car_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light" required>
                        <option value="">Loading vehicles...</option>
                    </select>
                    <p id="car-select-error" class="text-red-500 text-sm mt-1 hidden">Failed to load vehicles. Please check your Supabase setup.</p>
                </div>

                <div>
                    <label for="customer_search_input" class="block text-sm font-medium text-gray-700">Search Customer</label>
                    <input type="text" id="customer_search_input" placeholder="Search by name or phone number" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light">
                </div>
                <div>
                    <label for="customer_id" class="block text-sm font-medium text-gray-700">Customer</label>
                    <select id="customer_id" name="customer_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light" required>
                        <option value="">Loading customers...</option>
                    </select>
                    <p id="customer-select-error" class="text-red-500 text-sm mt-1 hidden">Failed to load customers. Please check your Supabase setup.</p>
                </div>

                <div>
                    <label for="from_date" class="block text-sm font-medium text-gray-700">From Date</label>
                    <input type="date" id="from_date" name="from_date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light" required>
                </div>
                <div>
                    <label for="end_date" class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" id="end_date" name="end_date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light" required>
                </div>
                <div>
                    <label for="actual_return_date" class="block text-sm font-medium text-gray-700">Actual Return Date (Optional)</label>
                    <input type="date" id="actual_return_date" name="actual_return_date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light">
                </div>
                <div>
                    <label for="rented_days" class="block text-sm font-medium text-gray-700">Rented Days</label>
                    <input type="number" id="rented_days" name="rented_days" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light" readonly>
                </div>
                <div>
                    <label for="initial_odometer_km" class="block text-sm font-medium text-gray-700">Initial Odometer (KM)</label>
                    <input type="number" id="initial_odometer_km" name="initial_odometer_km" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light">
                </div>
                <div>
                    <label for="final_odometer_km" class="block text-sm font-medium text-gray-700">Final Odometer (KM) (Optional)</label>
                    <input type="number" id="final_odometer_km" name="final_odometer_km" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light">
                </div>
                <div>
                    <label for="rental_price_per_day" class="block text-sm font-medium text-gray-700">Rental Price Per Day (AED)</label>
                    <input type="number" id="rental_price_per_day" name="rental_price_per_day" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light">
                </div>
                <div>
                    <label for="total_price" class="block text-sm font-medium text-gray-700">Total Price (AED)</label>
                    <input type="number" id="total_price" name="total_price" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light" readonly>
                </div>
                <div>
                    <label for="paid_amount" class="block text-sm font-medium text-gray-700">Paid Amount (AED)</label>
                    <input type="number" id="paid_amount" name="paid_amount" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light">
                </div>
                <div>
                    <label for="balance" class="block text-sm font-medium text-gray-700">Balance (AED)</label>
                    <input type="number" id="balance" name="balance" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light" readonly>
                </div>
                <div>
                    <label for="payment_status" class="block text-sm font-medium text-gray-700">Payment Status</label>
                    <select id="payment_status" name="payment_status" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light">
                        <option value="Paid">Paid</option>
                        <option value="Partially Paid">Partially Paid</option>
                        <option value="Unpaid">Unpaid</option>
                    </select>
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">Rental Status</label>
                    <select id="status" name="status" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light">
                        <option value="Active">Active</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <div>
                    <label for="traffic_fines" class="block text-sm font-medium text-gray-700">Traffic Fines (AED)</label>
                    <input type="number" id="traffic_fines" name="traffic_fines" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light">
                </div>
                <div>
                    <label for="car_repair" class="block text-sm font-medium text-gray-700">Car Repair Cost (AED)</label>
                    <input type="number" id="car_repair" name="car_repair" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light">
                </div>
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                    <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-custom-blue-light focus:border-custom-blue-light"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-rent-button" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors duration-200">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-custom-blue-dark text-white hover:bg-custom-blue-light transition-colors duration-200">Save Record</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal (for future use, e.g., deleting records) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 w-11/12 max-w-sm">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirm Action</h3>
            <p id="confirmation-message" class="text-gray-700 mb-6">Are you sure you want to proceed with this action?</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-confirm-button" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors duration-200">Cancel</button>
                <button type="button" id="confirm-action-button" class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors duration-200">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Supabase Configuration
        const SUPABASE_URL = 'https://yzwfldypkwqndxjchgit.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6d2ZsZHlwa3dxbmR4amNoZ2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzMjA0OTUsImV4cCI6MjA2NDg5NjQ5NX0.i3HOii7L9mJ-cBZ2us3TRmS0-GI9bylHuLe9INAu4zY';

        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Redirect if not logged in
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                window.location.href = 'login.html'; // Redirect to login page
            }
        });

        // --- Internationalization (i18n) Mock-up ---
        // This is a simplified translation object. In a real app, you'd load translations dynamically.
        const translations = {
            en: {
                // General
                n_a: 'N/A',
                daysPrint: 'Days',
                phoneLabelPrint: 'Phone',
                cityLabel: 'City',

                // Agreement Header
                carRentalAgreementPrint: 'CAR RENTAL AGREEMENT',

                // Vehicle Details Section
                vehicleDetailsPrint: 'VEHICLE DETAILS',
                vehRegNoPrint: 'Vehicle Reg. No.',
                vehicleTypePrint: 'Vehicle Type',
                yearMadePrint: 'Year Made',
                colourPrint: 'Colour',
                foxCarsRentalPrint: 'FOX CARS RENTAL',

                // Hirer Details Section
                hirerDetailsPrint: 'HIRER DETAILS',
                hirerNamePrint: 'Hirer Name',
                nationalityPrint: 'Nationality',
                idNumPrint: 'ID No.',
                contactNoPrint: 'Contact No.',
                addressPrint: 'Address',
                licenceNoPrint: 'Licence No.',
                licExpiryDatePrint: 'Lic. Expiry Date',
                licIssuedByPrint: 'Lic. Issued By',

                // Rental Charge Section
                rentalChargePrint: 'RENTAL CHARGE',
                summerDatePrint: 'Date',
                timePrint: 'Time',
                kiloMeterPrint: 'Kilometer',
                conditionVehPrint: 'Condition of Vehicle',
                vehOutPrint: 'Vehicle Out',
                vehInPrint: 'Vehicle In',
                rentalPricePerDayLabel: 'Rental Price Per Day',
                rentPeriodPrint: 'Rent Period',
                totalPriceLabel: 'Total Price',
                paidAmountLabel: 'Paid Amount',
                balanceDueLabel: 'Balance Due',
                trafficFinesLabel: 'Traffic Fines',
                carRepairLabel: 'Car Repair',

                // Disclaimer Section
                disclaimerTitle: 'DISCLAIMER',
                disclaimer1: 'The company is not responsible for any traffic fines or accidents.',
                disclaimer2: 'The hirer is responsible for all damages to the vehicle during the rental period.',
                disclaimer3: 'Any delay in returning the vehicle will result in additional charges.',
                disclaimer4: 'The vehicle must be returned with the same fuel level as received.',

                // Main Conditions Section
                mainConditionsTitle: 'MAIN CONDITIONS',
                mainCondition1: 'The hirer must be over 21 years old and hold a valid driving license.',
                mainCondition2: 'The vehicle is provided for personal use only and cannot be used for commercial purposes.',
                mainCondition3: 'Smoking is strictly prohibited inside the vehicle.',
                mainCondition4: 'Any unauthorized modifications to the vehicle are strictly forbidden.',
                mainCondition5: 'The hirer is responsible for all parking fees and tolls.',
                mainCondition6: 'In case of breakdown, contact the company immediately.',
                mainCondition7: 'The vehicle is insured, but an excess fee may apply in case of an accident.',
                mainCondition8: 'The company reserves the right to terminate the agreement at any time.',

                // Rental Terms Section
                rentalTermsTitle: 'RENTAL TERMS & CONDITIONS',
                rentalTerm1: 'Vehicle Delivery and Return: The vehicle will be delivered to the hirer at the agreed location and time. The hirer must return the vehicle to the agreed location and time, in the same condition as received, normal wear and tear excepted.',
                rentalTerm2: 'Rental Period: The rental period is specified in the agreement. Any extension must be approved by the company in advance and may incur additional charges.',
                rentalTerm3: 'Rental Charges: The hirer agrees to pay the rental charges, including daily rates, mileage charges (if applicable), and any additional services or fees as specified in the agreement.',
                rentalTerm4: 'Fuel Policy: The vehicle is provided with a certain level of fuel. The hirer is responsible for returning the vehicle with the same fuel level. Otherwise, a refueling charge will apply, in addition to the cost of the missing fuel.',
                rentalTerm4a: 'Full to Full: Return with a full tank, or pay for refueling service plus fuel cost.',
                rentalTerm4b: 'Same to Same: Return with the same fuel level as received, or pay for missing fuel plus service fee.',
                rentalTerm4c: 'Pre-purchase Fuel: Option to buy a full tank at pickup and return empty.',
                rentalTerm4d: 'Empty to Empty: Return empty, no refunds for unused fuel.',
                rentalTerm4e: 'Electric Vehicles: Return with a specified charge level, or incur charging fees.',
                rentalTerm4f: 'Hybrid Vehicles: Follow specific fuel/charge guidelines.',
                rentalTerm4g: 'Fuel Type: Use only the specified fuel type for the vehicle.',
                rentalTerm5: 'Maintenance and Condition: The hirer agrees to maintain the vehicle in good condition and to perform routine checks (e.g., tire pressure, oil level). Any mechanical issues must be reported to the company immediately.',
                rentalTerm5a: 'Regular Checks: Hirer responsible for checking fluid levels, tire pressure, and lights.',
                rentalTerm5b: 'Reporting Issues: Any mechanical issues or warning lights must be reported immediately.',
                rentalTerm5c: 'Cleaning: Vehicle should be returned in a reasonably clean condition. Excessive dirtiness may incur cleaning fees.',
                rentalTerm6: 'Traffic Violations and Fines: The hirer is solely responsible for all traffic violations, fines, and penalties incurred during the rental period. The company reserves the right to charge the hirer for any such fines plus an administrative fee.',
                rentalTerm6a: 'Direct Responsibility: Hirer is responsible for all fines, tolls, and parking tickets.',
                rentalTerm7: 'Accidents and Damages: In the event of an accident or damage to the vehicle, the hirer must immediately notify the company and the police. The hirer is responsible for the deductible amount as per the insurance policy.',
                rentalTerm7a: 'Immediate Notification: Report accidents to company and police immediately.',
                rentalTerm7b: 'Insurance Deductible: Hirer responsible for insurance excess/deductible.',
                rentalTerm7c: 'Third-Party Claims: Hirer must cooperate with insurance investigations.',
                rentalTerm8: 'Insurance Coverage: The vehicle is insured as per local laws. Additional insurance coverage may be available at an extra cost.',
                rentalTerm9: 'Prohibited Uses: The vehicle shall not be used for racing, towing, illegal activities, or transporting hazardous materials. It shall not be driven by unauthorized drivers.',
                rentalTerm10: 'Geographical Restrictions: The vehicle may only be driven within the specified geographical area (e.g., within UAE). Driving outside this area may void the insurance and incur penalties.',
                rentalTerm11: 'Early Return/Late Return: Early returns do not guarantee a refund for unused rental days. Late returns without prior approval will incur additional daily charges.',
                rentalTerm12: 'Cancellation Policy: Cancellation terms and fees are specified at the time of booking. Refer to your booking confirmation for details.',
                rentalTerm13: 'Security Deposit: A security deposit is required at the time of rental to cover potential damages, fines, or additional charges. The deposit will be refunded after the vehicle is returned and inspected, typically within a few business days.',
                rentalTerm14: 'Personal Belongings: The company is not responsible for any personal belongings left in the vehicle after return.',
                rentalTerm15: 'Force Majeure: The company shall not be liable for any failure or delay in performance due to circumstances beyond its reasonable control, including but not limited to natural disasters, acts of government, or strikes.',
                rentalTerm16: 'Governing Law: This agreement shall be governed by and construed in accordance with the laws of the United Arab Emirates.',
                rentalTerm17: 'Dispute Resolution: Any disputes arising from this agreement shall be resolved through amicable negotiation. If a resolution cannot be reached, the dispute shall be submitted to the competent courts in Ajman, UAE.',
                rentalTerm18: 'Severability: If any provision of this agreement is found to be unenforceable or invalid, the remaining provisions shall remain in full force and effect.',
                rentalTerm19: 'Entire Agreement: This agreement constitutes the entire understanding between the parties and supersedes all prior agreements and understandings, whether written or oral.',
                rentalTerm20: 'Amendments: Any amendments to this agreement must be in writing and signed by both parties.',
                rentalTerm21: 'Indemnification: The hirer agrees to indemnify and hold harmless the company from any claims, damages, or liabilities arising from the hirer\'s use of the vehicle.',
                rentalTerm22: 'Vehicle Inspection: The hirer acknowledges that they have inspected the vehicle at the time of pickup and found it to be in good condition, as documented in the vehicle inspection report.',
                rentalTerm23: 'Mileage Limit: A daily or total mileage limit may apply. Exceeding this limit will incur additional charges as specified in the agreement.',
                rentalTerm24: 'Roadside Assistance: Basic roadside assistance is included. For specific services or extended coverage, refer to additional options.',
                rentalTerm25: 'Child Seats: Child seats are available upon request and may incur an additional fee. Proper installation is the hirer\'s responsibility.',
                rentalTerm26: 'GPS/Navigation: GPS devices are available for rent. The hirer is responsible for their care and return.',
                rentalTerm27: 'Additional Drivers: Additional drivers must be registered with the company and meet the same eligibility criteria as the primary hirer. An additional fee may apply.',
                rentalTerm28: 'Smoking Policy: Smoking is strictly prohibited in all vehicles. A cleaning fee will be charged for any evidence of smoking.',

                // Signatures
                hirerSignature: 'Hirer Signature',
                sponsorSignature: 'Sponsor Signature (if applicable)',
                officeInchargeSignature: 'Office Incharge Signature'
            }
        };

        const currentLang = 'en'; // Default language

        function getTranslation(key) {
            return translations[currentLang][key] || key; // Fallback to key if translation not found
        }

        // DOM Elements
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const closeMobileMenuButton = document.getElementById('close-mobile-menu-button');
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const mobileSidebarOverlay = document.getElementById('mobile-sidebar-overlay');
        const rentHistoryList = document.getElementById('rent-history-list');
        const loadingMessage = document.getElementById('loading-message');
        const noRecordsMessage = document.getElementById('no-records-message'); // New element for no records
        const statusFilter = document.getElementById('status-filter');
        const paymentStatusFilter = document.getElementById('payment-status-filter');
        const carPlateFilter = document.getElementById('car-plate-filter'); // New filter input
        const customerFilter = document.getElementById('customer-filter'); // New filter input

        const appErrorMessage = document.getElementById('app-error-message'); // New error message div
        const errorText = document.getElementById('error-text'); // Span for error text

        // Edit Rent Record Modal Elements
        const rentModal = document.getElementById('rent-modal');
        const rentForm = document.getElementById('rent-form');
        const cancelRentButton = document.getElementById('cancel-rent-button');
        const carSearchInput = document.getElementById('car_search_input');
        const carIdSelect = document.getElementById('car_id');
        const carSelectError = document.getElementById('car-select-error');
        const customerSearchInput = document.getElementById('customer_search_input');
        const customerIdSelect = document.getElementById('customer_id');
        const customerSelectError = document.getElementById('customer-select-error');

        // Form fields
        const fromDateInput = document.getElementById('from_date');
        const endDateInput = document.getElementById('end_date');
        const actualReturnDateInput = document.getElementById('actual_return_date');
        const rentedDaysInput = document.getElementById('rented_days');
        const initialOdometerInput = document.getElementById('initial_odometer_km');
        const finalOdometerInput = document.getElementById('final_odometer_km');
        const rentalPricePerDayInput = document.getElementById('rental_price_per_day');
        const totalPriceInput = document.getElementById('total_price');
        const paidAmountInput = document.getElementById('paid_amount');
        const balanceInput = document.getElementById('balance');
        const paymentStatusSelect = document.getElementById('payment_status');
        const rentalStatusSelect = document.getElementById('status'); // Renamed to avoid conflict with filter
        const trafficFinesInput = document.getElementById('traffic_fines');
        const carRepairInput = document.getElementById('car_repair');
        const notesInput = document.getElementById('notes');


        // Confirmation Modal Elements (generic for future use, e.g., deleting records)
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const cancelConfirmButton = document.getElementById('cancel-confirm-button');
        const confirmActionButton = document.getElementById('confirm-action-button');

        // Global variables
        let allRentHistoryData = [];
        let allCarsData = []; // To store all vehicles for dropdown
        let allCustomersData = []; // To store all customers for dropdown
        let currentEditRecordId = null; // To store the ID of the record being edited

        // --- Mobile Sidebar Logic ---
        mobileMenuButton.addEventListener('click', () => {
            mobileSidebar.classList.remove('-translate-x-full');
            mobileSidebarOverlay.classList.remove('hidden');
        });

        closeMobileMenuButton.addEventListener('click', () => {
            mobileSidebar.classList.add('-translate-x-full');
            mobileSidebarOverlay.classList.add('hidden');
        });

        mobileSidebarOverlay.addEventListener('click', () => {
            mobileSidebar.classList.add('-translate-x-full');
            mobileSidebarOverlay.classList.add('hidden');
        });

        // --- Helper Functions ---

        // Function to format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            // Handle both date-only strings and full ISO strings
            const date = new Date(dateString.includes('T') ? dateString : dateString + 'T00:00:00Z');
            // Check for invalid date
            if (isNaN(date.getTime())) return 'N/A';
            return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });
        }

        // Function to get status badge color
        function getStatusBadgeColor(status) {
            switch (status) {
                case 'Active': return 'bg-blue-500';
                case 'Completed': return 'bg-green-500';
                case 'Cancelled': return 'bg-red-500';
                default: return 'bg-gray-500';
            }
        }

        // Function to get payment status badge color
        function getPaymentStatusBadgeColor(paymentStatus) {
            switch (paymentStatus) {
                case 'Paid': return 'bg-green-500';
                case 'Partially Paid': return 'bg-yellow-500';
                case 'Unpaid': return 'bg-red-500';
                default: return 'bg-gray-500';
            }
        }

        // Helper to populate select dropdowns
        function populateSelect(selectElement, data, textKey, valueKey, selectedValue = null) {
            selectElement.innerHTML = '<option value="">Select...</option>'; // Clear existing options
            if (selectElement === carIdSelect) carSelectError.classList.add('hidden');
            if (selectElement === customerIdSelect) customerSelectError.classList.add('hidden');

            if (!data || data.length === 0) {
                const noOption = document.createElement('option');
                noOption.value = "";
                noOption.textContent = `No ${textKey.replace('_', ' ')}s found`;
                noOption.disabled = true;
                selectElement.appendChild(noOption);
                return;
            }
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                if (selectedValue !== null && String(item[valueKey]) === String(selectedValue)) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        // --- Fetching Data for Dropdowns ---
        async function fetchAllCarsForDropdown() {
            try {
                const { data, error } = await supabaseClient
                    .from('cars')
                    .select('id, plate_number, veh_make (make), veh_model (model)');
                if (error) throw error;
                allCarsData = data.map(car => ({
                    id: car.id,
                    text: `${car.veh_make?.make || 'N/A'} ${car.veh_model?.model || 'N/A'} (${car.plate_number || 'N/A'})`,
                    plate_number: car.plate_number,
                    make: car.veh_make?.make,
                    model: car.veh_model?.model
                }));
                populateSelect(carIdSelect, allCarsData, 'text', 'id');
            } catch (error) {
                console.error("Error fetching cars for dropdown:", error.message);
                carSelectError.textContent = `Error loading vehicles: ${error.message}`;
                carSelectError.classList.remove('hidden');
                carIdSelect.innerHTML = '<option value="">Error loading vehicles</option>';
            }
        }

        async function fetchAllCustomersForDropdown() {
            try {
                const { data, error } = await supabaseClient
                    .from('customers')
                    .select('id, first_name, last_name, phone_number');
                if (error) throw error;
                allCustomersData = data.map(customer => ({
                    id: customer.id,
                    text: `${customer.first_name || ''} ${customer.last_name || ''} (${customer.phone_number || 'N/A'})`.trim(),
                    first_name: customer.first_name,
                    last_name: customer.last_name,
                    phone_number: customer.phone_number
                }));
                populateSelect(customerIdSelect, allCustomersData, 'text', 'id');
            } catch (error) {
                console.error("Error fetching customers for dropdown:", error.message);
                customerSelectError.textContent = `Error loading customers: ${error.message}`;
                customerSelectError.classList.remove('hidden');
                customerIdSelect.innerHTML = '<option value="">Error loading customers</option>';
            }
        }

        // Filter dropdowns based on search input
        carSearchInput.addEventListener('input', () => {
            const searchTerm = carSearchInput.value.toLowerCase();
            const filtered = allCarsData.filter(car =>
                car.text.toLowerCase().includes(searchTerm) ||
                (car.plate_number && car.plate_number.toLowerCase().includes(searchTerm)) ||
                (car.make && car.make.toLowerCase().includes(searchTerm)) ||
                (car.model && car.model.toLowerCase().includes(searchTerm))
            );
            populateSelect(carIdSelect, filtered, 'text', 'id', carIdSelect.value); // Keep selected value if it's in filtered list
        });

        customerSearchInput.addEventListener('input', () => {
            const searchTerm = customerSearchInput.value.toLowerCase();
            const filtered = allCustomersData.filter(customer =>
                customer.text.toLowerCase().includes(searchTerm) ||
                (customer.first_name && customer.first_name.toLowerCase().includes(searchTerm)) ||
                (customer.last_name && customer.last_name.toLowerCase().includes(searchTerm)) ||
                (customer.phone_number && customer.phone_number.toLowerCase().includes(searchTerm))
            );
            populateSelect(customerIdSelect, filtered, 'text', 'id', customerIdSelect.value); // Keep selected value if it's in filtered list
        });


        // --- Calculation Logic for Rented Days, Total Price, Balance ---
        function calculateRentedDays() {
            const fromDateStr = fromDateInput.value;
            const endDateStr = endDateInput.value;
            const actualReturnDateStr = actualReturnDateInput.value;
            let rentedDays = 0;

            if (fromDateStr) {
                const start = new Date(fromDateStr);
                let effectiveEnd = null;

                // Prioritize actual_return_date if provided and valid
                if (actualReturnDateStr) {
                    effectiveEnd = new Date(actualReturnDateStr);
                } else if (endDateStr) {
                    effectiveEnd = new Date(endDateStr);
                }

                if (effectiveEnd) {
                    // Calculate difference in milliseconds, ensuring it's always positive
                    const diffTime = Math.abs(effectiveEnd.getTime() - start.getTime());

                    // If the dates are identical (0 milliseconds difference), it's 1 day
                    if (diffTime === 0) {
                        rentedDays = 1;
                    } else {
                        // For any other difference, calculate days and round up.
                        rentedDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    }
                }
            }
            rentedDaysInput.value = rentedDays;
            calculateTotalPriceAndBalance(); // Recalculate total price and balance
        }

        function calculateTotalPriceAndBalance() {
            const rentedDays = parseFloat(rentedDaysInput.value) || 0;
            const rentalPricePerDay = parseFloat(rentalPricePerDayInput.value) || 0;
            const paidAmount = parseFloat(paidAmountInput.value) || 0;
            const trafficFines = parseFloat(trafficFinesInput.value) || 0;
            const carRepair = parseFloat(carRepairInput.value) || 0;

            const calculatedTotalPrice = (rentedDays * rentalPricePerDay) + trafficFines + carRepair;
            totalPriceInput.value = calculatedTotalPrice.toFixed(2);

            const calculatedBalance = calculatedTotalPrice - paidAmount;
            balanceInput.value = calculatedBalance.toFixed(2);

            // Update payment status based on balance
            if (calculatedBalance <= 0) {
                paymentStatusSelect.value = 'Paid';
            } else if (paidAmount > 0 && calculatedBalance > 0) {
                paymentStatusSelect.value = 'Partially Paid';
            } else {
                paymentStatusSelect.value = 'Unpaid';
            }
        }

        // Add event listeners for calculations
        fromDateInput.addEventListener('change', calculateRentedDays);
        endDateInput.addEventListener('change', calculateRentedDays);
        actualReturnDateInput.addEventListener('change', calculateRentedDays); // New listener
        rentalPricePerDayInput.addEventListener('input', calculateTotalPriceAndBalance);
        paidAmountInput.addEventListener('input', calculateTotalPriceAndBalance);
        trafficFinesInput.addEventListener('input', calculateTotalPriceAndBalance);
        carRepairInput.addEventListener('input', calculateTotalPriceAndBalance);


        // --- Rendering Function ---
        function renderRentHistory(rentals) {
            rentHistoryList.innerHTML = ''; // Clear existing items
            appErrorMessage.classList.add('hidden'); // Hide any previous app errors

            if (rentals.length === 0) {
                noRecordsMessage.classList.remove('hidden'); // Show no records message
                return;
            } else {
                noRecordsMessage.classList.add('hidden'); // Hide no records message
            }

            rentals.forEach(rental => {
                const carInfo = rental.cars || {}; // Joined car data
                const customerInfo = rental.customers || {}; // Joined customer data
                const makeInfo = carInfo.veh_make || {}; // Joined make data
                const modelInfo = carInfo.veh_model || {}; // Joined model data

                // Use the actual make and model names for display
                const carDisplay = `${makeInfo.make || 'N/A'} ${modelInfo.model || 'N/A'} (${carInfo.plate_number || 'N/A'})`;
                // Use the correct column names from the 'customers' table for display
                const customerDisplay = `${customerInfo.first_name || ''} ${customerInfo.last_name || ''}`.trim() || 'N/A';
                const customerPhone = customerInfo.phone_number || 'N/A';

                const fromDate = formatDate(rental.from_date);
                const endDate = formatDate(rental.end_date);
                const actualReturnDate = rental.actual_return_date ? ` (Returned: ${formatDate(rental.actual_return_date)})` : '';

                const trafficFines = parseFloat(rental.traffic_fines || 0);
                const carRepair = parseFloat(rental.car_repair || 0);

                const item = document.createElement('div');
                item.className = `bg-white rounded-xl shadow-md p-5 flex flex-col md:flex-row items-start md:items-center justify-between space-y-4 md:space-y-0 md:space-x-4 border-l-4 ${getStatusBadgeColor(rental.status).replace('bg', 'border')}`;
                item.innerHTML = `
                    <div class="flex-1 space-y-2 w-full md:w-auto">
                        <div class="flex items-center text-lg font-semibold text-gray-900">
                            <i class="fas fa-car mr-2 text-custom-blue-dark"></i>
                            ${carDisplay}
                        </div>
                        <div class="flex items-center text-gray-700 text-sm">
                            <i class="fas fa-user mr-2 text-custom-blue-dark"></i>
                            ${customerDisplay} (<a href="tel:${customerPhone}" class="text-custom-blue-dark hover:underline">${customerPhone}</a>)
                        </div>
                        <div class="flex items-center text-gray-700 text-sm">
                            <i class="fas fa-calendar-alt mr-2 text-custom-blue-dark"></i>
                            ${fromDate} - ${endDate}${actualReturnDate}
                        </div>
                    </div>

                    <div class="flex-1 grid grid-cols-2 gap-2 text-sm w-full md:w-auto">
                        <div>
                            <p class="text-gray-600">Days</p>
                            <p class="font-semibold text-gray-900">${rental.rented_days || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Total Price</p>
                            <p class="font-semibold text-gray-900">AED ${parseFloat(rental.total_price || 0).toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Paid Amount</p>
                            <p class="font-semibold text-green-600">AED ${parseFloat(rental.paid_amount || 0).toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Balance</p>
                            <p class="font-semibold text-red-600">AED ${parseFloat(rental.balance || 0).toFixed(2)}</p>
                        </div>
                        ${trafficFines > 0 || carRepair > 0 ? `
                            <div class="col-span-2 text-xs text-gray-500 mt-2">
                                ${trafficFines > 0 ? `<p>Traffic Fines: AED ${trafficFines.toFixed(2)}</p>` : ''}
                                ${carRepair > 0 ? `<p>Car Repair: AED ${carRepair.toFixed(2)}</p>` : ''}
                            </div>
                        ` : ''}
                    </div>

                    <div class="flex flex-col items-end space-y-2 w-full md:w-auto">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold text-white ${getStatusBadgeColor(rental.status)}">
                            ${rental.status || 'N/A'}
                        </span>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold text-white ${getPaymentStatusBadgeColor(rental.payment_status)}">
                            ${rental.payment_status || 'N/A'}
                        </span>
                        <button data-id="${rental.id}" class="edit-record-btn text-custom-blue-dark hover:text-custom-blue-dark/80 transition-colors duration-200 px-3 py-1 rounded-lg border border-custom-blue-dark">
                            Edit Record
                        </button>
                        <button data-id="${rental.id}" class="print-agreement-btn bg-custom-purple text-white hover:bg-custom-purple/80 transition-colors duration-200 px-3 py-1 rounded-lg">
                            <i class="fas fa-print mr-1"></i> Print Agreement
                        </button>
                    </div>
                `;
                rentHistoryList.appendChild(item);
            });

            // Add event listeners for edit buttons
            document.querySelectorAll('.edit-record-btn').forEach(button => {
                button.addEventListener('click', (e) => openEditRentModal(e.currentTarget.dataset.id));
            });

            // Add event listeners for print buttons
            document.querySelectorAll('.print-agreement-btn').forEach(button => {
                button.addEventListener('click', (e) => printRentalAgreement(e.currentTarget.dataset.id));
            });
        }

        // Fetch rent history from Supabase with joins
        async function fetchRentHistory() {
            loadingMessage.classList.remove('hidden');
            rentHistoryList.innerHTML = ''; // Clear existing items
            appErrorMessage.classList.add('hidden'); // Hide any previous errors
            noRecordsMessage.classList.add('hidden'); // Hide no records message initially

            console.log("Attempting to fetch rent history...");
            try {
                const { data, error } = await supabaseClient
                    .from('rent_history')
                    .select(`
                        *,
                        cars (
                            plate_number, year, color, odometer_km,
                            veh_make (make),
                            veh_model (model)
                        ),
                        customers (id, first_name, last_name, email, phone_number, address, city, driver_license_number, driver_license_expiry_date, date_of_birth, id_number, nationality, license_issued_by)
                    `);

                loadingMessage.classList.add('hidden'); // Always hide loading message when fetch is done

                if (error) {
                    console.error("Error fetching rent history:", error);
                    errorText.textContent = `Failed to load rent history: ${error.message}. Please check your Supabase configuration and network connection.`;
                    appErrorMessage.classList.remove('hidden');
                    return;
                }

                console.log("Rent history fetched successfully:", data);
                allRentHistoryData = data; // Update the master list
                applyFilters(allRentHistoryData); // Apply filters after fetching
            } catch (error) {
                console.error("An unexpected error occurred during fetchRentHistory:", error);
                loadingMessage.classList.add('hidden');
                errorText.textContent = `An unexpected error occurred: ${error.message}`;
                appErrorMessage.classList.remove('hidden');
            }
        }

        // Function to apply filters
        function applyFilters(rentalsData) {
            let filteredRentals = [...rentalsData]; // Create a mutable copy

            const selectedStatus = statusFilter.value;
            const selectedPaymentStatus = paymentStatusFilter.value;
            const carPlateSearchTerm = carPlateFilter.value.toLowerCase(); // New filter value
            const customerSearchTerm = customerFilter.value.toLowerCase(); // New filter value

            if (selectedStatus !== 'All') {
                filteredRentals = filteredRentals.filter(rental => rental.status === selectedStatus);
            }

            if (selectedPaymentStatus !== 'All') {
                filteredRentals = filteredRentals.filter(rental => rental.payment_status === selectedPaymentStatus);
            }

            // Apply car plate filter
            if (carPlateSearchTerm) {
                filteredRentals = filteredRentals.filter(rental =>
                    rental.cars && rental.cars.plate_number && rental.cars.plate_number.toLowerCase().includes(carPlateSearchTerm)
                );
            }

            // Apply customer filter (by first name, last name, or phone number)
            if (customerSearchTerm) {
                filteredRentals = filteredRentals.filter(rental =>
                    rental.customers && (
                        (rental.customers.first_name && rental.customers.first_name.toLowerCase().includes(customerSearchTerm)) ||
                        (rental.customers.last_name && rental.customers.last_name.toLowerCase().includes(customerSearchTerm)) ||
                        (rental.customers.phone_number && rental.customers.phone_number.toLowerCase().includes(customerSearchTerm))
                    )
                );
            }

            renderRentHistory(filteredRentals);
        }

        // Event listeners for filters
        statusFilter.addEventListener('change', () => applyFilters(allRentHistoryData));
        paymentStatusFilter.addEventListener('change', () => applyFilters(allRentHistoryData));
        carPlateFilter.addEventListener('input', () => applyFilters(allRentHistoryData)); // New listener
        customerFilter.addEventListener('input', () => applyFilters(allRentHistoryData)); // New listener

        // Initial fetch when the page loads
        fetchRentHistory();

        // --- Edit Rent Modal Logic ---

        // Open modal for editing rent record
        async function openEditRentModal(id) {
            currentEditRecordId = id;
            rentForm.reset(); // Clear form

            // Fetch the specific record
            const { data: record, error } = await supabaseClient
                .from('rent_history')
                .select('*')
                .eq('id', id)
                .single();

            if (error) {
                console.error("Error fetching rent record for edit:", error);
                // Using a custom message box instead of alert
                showCustomMessageBox("Error", "Error fetching rent record details: " + error.message);
                return;
            }

            if (record) {
                // Populate dropdowns first
                await Promise.all([fetchAllCarsForDropdown(), fetchAllCustomersForDropdown()]);

                // Populate form fields
                carIdSelect.value = record.car_id || '';
                customerIdSelect.value = record.customer_id || '';
                fromDateInput.value = record.from_date ? record.from_date.split('T')[0] : '';
                endDateInput.value = record.end_date ? record.end_date.split('T')[0] : '';
                actualReturnDateInput.value = record.actual_return_date ? record.actual_return_date.split('T')[0] : '';
                rentedDaysInput.value = record.rented_days || '';
                initialOdometerInput.value = record.initial_odometer_km || '';
                finalOdometerInput.value = record.final_odometer_km || '';
                rentalPricePerDayInput.value = record.rental_price_per_day || '';
                paidAmountInput.value = record.paid_amount || '';
                paymentStatusSelect.value = record.payment_status || 'Unpaid';
                rentalStatusSelect.value = record.status || 'Active';
                trafficFinesInput.value = record.traffic_fines || 0;
                carRepairInput.value = record.car_repair || 0;
                notesInput.value = record.notes || '';

                // Recalculate derived fields after populating inputs
                calculateRentedDays(); // This will also call calculateTotalPriceAndBalance

                rentModal.classList.remove('hidden');
            } else {
                console.error("No rent record found with ID:", id);
                showCustomMessageBox("Error", "No rent record found with the provided ID.");
            }
        }

        cancelRentButton.addEventListener('click', () => {
            rentModal.classList.add('hidden');
        });

        rentModal.addEventListener('click', (e) => {
            if (e.target === rentModal) { // Close when clicking outside the modal content
                rentModal.classList.add('hidden');
            }
        });

        // Handle form submission (Update)
        rentForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(rentForm);
            const oldCarId = allRentHistoryData.find(r => r.id === currentEditRecordId)?.car_id; // Get old car_id for status revert
            const oldStatus = allRentHistoryData.find(r => r.id === currentEditRecordId)?.status; // Get old status

            const rentData = {
                car_id: parseInt(formData.get('car_id')),
                customer_id: formData.get('customer_id'),
                from_date: formData.get('from_date') || null,
                end_date: formData.get('end_date') || null,
                actual_return_date: formData.get('actual_return_date') || null,
                rented_days: parseInt(formData.get('rented_days')) || 0,
                initial_odometer_km: parseFloat(formData.get('initial_odometer_km')) || null,
                final_odometer_km: parseFloat(formData.get('final_odometer_km')) || null,
                rental_price_per_day: parseFloat(formData.get('rental_price_per_day')) || 0,
                total_price: parseFloat(formData.get('total_price')) || 0,
                paid_amount: parseFloat(formData.get('paid_amount')) || 0,
                balance: parseFloat(formData.get('balance')) || 0,
                payment_status: formData.get('payment_status'),
                status: formData.get('status'), // This is the rental status
                traffic_fines: parseFloat(formData.get('traffic_fines')) || 0,
                car_repair: parseFloat(formData.get('car_repair')) || 0,
                updated_at: new Date().toISOString()
            };

            console.log("Submitting rent record data:", rentData);

            try {
                const { data, error } = await supabaseClient
                    .from('rent_history')
                    .update(rentData)
                    .eq('id', currentEditRecordId);

                if (error) throw error;
                console.log("Rent record updated:", data);
                showCustomMessageBox("Success", "Rent record updated successfully!");

                // --- Logic to update car status in 'cars' table ---
                const newStatus = rentData.status;
                const carId = rentData.car_id;

                let carStatusToUpdate = null;

                if (newStatus === 'Active') {
                    carStatusToUpdate = 'Rented';
                } else if (newStatus === 'Completed' || newStatus === 'Cancelled') {
                    carStatusToUpdate = 'Available';
                }

                // If the car ID changed, or the status changed, update the car table
                if (carStatusToUpdate && (carId !== oldCarId || newStatus !== oldStatus)) {
                    console.log(`Updating car status for car_id: ${carId} to '${carStatusToUpdate}'`);
                    const { error: carUpdateError } = await supabaseClient
                        .from('cars')
                        .update({ status: carStatusToUpdate })
                        .eq('id', carId);

                    if (carUpdateError) {
                        console.error("Error updating car status in 'cars' table:", carUpdateError.message, carUpdateError);
                        showCustomMessageBox("Warning", "Could not update car's status in inventory. Please check RLS for 'cars' table.");
                    } else {
                        console.log(`Car status for ${carId} updated to '${carStatusToUpdate}' in 'cars' table.`);
                    }
                }

                // If the car ID changed, and the old car was 'Rented', set its status back to 'Available'
                if (oldCarId && oldCarId !== carId && oldStatus === 'Active') {
                     console.log(`Reverting old car status for car_id: ${oldCarId} to 'Available'`);
                     const { error: oldCarRevertError } = await supabaseClient
                         .from('cars')
                         .update({ status: 'Available' })
                         .eq('id', oldCarId);

                     if (oldCarRevertError) {
                         console.error("Error reverting old car status in 'cars' table:", oldCarRevertError.message, oldCarRevertError);
                     }
                }

                rentModal.classList.add('hidden');
                fetchRentHistory(); // Re-fetch all records to update the list
            } catch (error) {
                console.error("Error saving rent record:", error.message);
                showCustomMessageBox("Error", "Error saving rent record: " + error.message);
            }
        });

        // --- Custom Message Box (replaces alert) ---
        function showCustomMessageBox(title, message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]'; // Higher z-index
            messageBox.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6 w-11/12 max-w-sm text-center">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">${title}</h3>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <button id="close-message-box" class="px-4 py-2 rounded-lg bg-custom-blue-dark text-white hover:bg-custom-blue-light transition-colors duration-200">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('close-message-box').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }


        // --- Confirmation Modal Logic (Generic) ---
        cancelConfirmButton.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
        });

        confirmActionButton.addEventListener('click', () => {
            // This button's action would be determined by the context that opens the modal
            // For now, it just closes the modal.
            confirmationModal.classList.add('hidden');
        });

        // --- Print Rental Agreement Function ---
        async function printRentalAgreement(rentalId) {
            // Fetch full rental details
            const { data: rental, error } = await supabaseClient
                .from('rent_history')
                .select(`
                    *,
                    cars (plate_number, year, color, odometer_km, veh_make (make), veh_model (model)),
                    customers (first_name, last_name, email, phone_number, address, city, driver_license_number, driver_license_expiry_date, date_of_birth, id_number, nationality, license_issued_by)
                `)
                .eq('id', rentalId)
                .single();

            if (error) {
                console.error('Error fetching rental details for print:', error.message, error); // Log the full error object
                showCustomMessageBox("Print Error", `Error fetching rental details for print: ${error.message}`);
                return;
            }

            if (!rental) {
                console.error('Rental record not found for printing.');
                showCustomMessageBox("Print Error", "Rental record not found for printing.");
                return;
            }

            // Prepare data for the agreement
            const vehicle = rental.cars || {};
            const customer = rental.customers || {};
            const make = vehicle.veh_make ? vehicle.veh_make.make : getTranslation('n_a');
            const model = vehicle.veh_model ? vehicle.veh_model.model : getTranslation('n_a');

            const createdAtDate = rental.created_at ? new Date(rental.created_at).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }) : '';

            const printContent = `
                <!DOCTYPE html>
                <html lang="${currentLang}" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${getTranslation('carRentalAgreementPrint')}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        body {
                            font-family: 'Poppins', sans-serif;
                            margin: 0;
                            padding: 20px;
                            color: #333;
                            font-size: 12px;
                        }
                        .agreement-container {
                            width: 210mm; /* A4 width */
                            min-height: 297mm; /* A4 height */
                            margin: 0 auto;
                            border: 1px solid #ccc;
                            padding: 20px;
                            box-sizing: border-box;
                            background: white;
                        }
                        .print-header-image {
                            width: 100%;
                            height: auto;
                            display: block;
                            margin-bottom: 20px; /* Space below the image */
                        }
                        .header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 20px;
                            border-bottom: 2px solid #eee;
                            padding-bottom: 10px;
                        }
                        .header-left, .header-right {
                            flex: 1;
                            text-align: left; /* Aligned to left */
                        }
                        html[dir="rtl"] .header-left, html[dir="rtl"] .header-right {
                            text-align: right; /* Aligned to right for RTL */
                        }
                        .header-center {
                            flex: 2;
                            text-align: center;
                        }
                        .header h1 {
                            font-size: 18px;
                            margin: 0;
                            color: #4361ee;
                        }
                        .header .logo-text {
                            font-size: 24px;
                            font-weight: bold;
                            color: #e74c3c; /* Reddish color from image */
                            display: inline-block;
                            margin-right: 10px;
                        }
                        .header .logo-subtext {
                            font-size: 16px;
                            color: #555;
                        }
                        .details-section {
                            display: flex; /* Use flexbox for side-by-side tables */
                            justify-content: space-between;
                            gap: 20px; /* Space between tables */
                            margin-bottom: 20px;
                        }
                        .details-section > div {
                            flex: 1; /* Each table takes equal width */
                        }
                        .agreement-table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        .agreement-table th, .agreement-table td {
                            border: 1px solid #ccc;
                            padding: 8px;
                            text-align: left;
                            vertical-align: top;
                        }
                        html[dir="rtl"] .agreement-table th, html[dir="rtl"] .agreement-table td {
                            text-align: right;
                        }
                        .agreement-table th {
                            background-color: #f2f2f2;
                            font-weight: bold;
                            width: 40%; /* Adjust column width for labels */
                        }
                        .agreement-table td {
                            width: 60%; /* Adjust column width for values */
                        }
                        .agreement-table.full-width {
                            width: 100%; /* Ensure the rental charge table spans full width */
                        }
                        .section-title {
                            font-weight: bold;
                            background-color: #e0e0e0;
                            text-align: center;
                        }
                        .disclaimer-section, .main-conditions-section, .rental-terms-section {
                            margin-top: 30px;
                            border-top: 1px solid #eee;
                            padding-top: 20px;
                        }
                        .disclaimer-section h3, .main-conditions-section h3, .rental-terms-section h3 {
                            font-size: 14px;
                            margin-bottom: 10px;
                            color: #4361ee;
                        }
                        /* Custom numbering for ordered lists */
                        .disclaimer-section ol, .main-conditions-section ol, .rental-terms-section ol {
                            list-style-type: none; /* Remove default numbering */
                            padding-left: 0;
                            counter-reset: item; /* Initialize counter */
                        }
                        .disclaimer-section ol li, .main-conditions-section ol li, .rental-terms-section ol li {
                            margin-bottom: 8px;
                            line-height: 1.4;
                            position: relative;
                            padding-left: 20px; /* Space for custom numbering */
                        }
                        html[dir="rtl"] .disclaimer-section ol li, html[dir="rtl"] .main-conditions-section ol li, html[dir="rtl"] .rental-terms-section ol li {
                            padding-right: 20px;
                            padding-left: 0;
                        }
                        .disclaimer-section ol li::before, .main-conditions-section ol li::before, .rental-terms-section ol li::before {
                            content: counter(item) ". "; /* Add counter before each list item */
                            counter-increment: item; /* Increment counter */
                            position: absolute;
                            left: 0;
                            font-weight: bold; /* Make numbers bold */
                            color: black; /* Make numbers black */
                        }
                        html[dir="rtl"] .disclaimer-section ol li::before, html[dir="rtl"] .main-conditions-section ol li::before, html[dir="rtl"] .rental-terms-section ol li::before {
                            left: unset;
                            right: 0;
                        }

                        /* Styling for nested ordered lists (a, b, c...) */
                        .rental-terms-section ol ol {
                            list-style-type: none;
                            padding-left: 20px; /* Indent nested list */
                            counter-reset: sub-item; /* Initialize sub-counter */
                        }

                        .rental-terms-section ol ol li {
                            padding-left: 20px; /* Space for sub-numbering */
                        }

                        html[dir="rtl"] .rental-terms-section ol ol li {
                            padding-right: 20px;
                            padding-left: 0;
                        }

                        .rental-terms-section ol ol li::before {
                            content: counter(sub-item, lower-alpha) ". "; /* Use lower-alpha for sub-numbering */
                            counter-increment: sub-item;
                            position: absolute;
                            left: 0;
                            font-weight: bold; /* Make sub-numbers bold */
                            color: black; /* Make sub-numbers black */
                        }
                        html[dir="rtl"] .rental-terms-section ol ol li::before {
                            left: unset;
                            right: 0;
                        }

                        .signature-section {
                            display: flex;
                            justify-content: space-around;
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px dashed #ccc;
                            font-size: 14px;
                            text-align: center;
                        }
                        .signature-block {
                            flex: 1;
                            padding: 0 10px;
                        }
                        .signature-line {
                            border-bottom: 1px solid #000;
                            margin-top: 40px; /* Space for signature */
                            margin-bottom: 5px;
                        }
                        .logo-img {
                            max-width: 150px; /* Adjust as needed */
                            height: auto;
                            display: block;
                            margin: 0 auto 10px auto; /* Center the image */
                        }


                        @media print {
                            body {
                                padding: 0;
                                margin: 0;
                            }
                            .agreement-container {
                                border: none;
                                box-shadow: none;
                            }
                            /* Reduced spacing for print */
                            .disclaimer-section,
                            .main-conditions-section,
                            .rental-terms-section {
                                margin-top: 0 !important; /* Force no margin */
                                padding-top: 0 !important; /* Force no padding */
                                border-top: none !important; /* Remove border for cleaner flow */
                                }
                            .disclaimer-section h3,
                            .main-conditions-section h3,
                            .rental-terms-section h3 {
                                margin-bottom: 3px !important; /* Reduce heading margin */
                            }
                            .rental-terms-section h3 {
                                margin-bottom: 0px !important; /* Specifically target this title to remove gap */
                            }
                            .disclaimer-section ol li,
                            .main-conditions-section ol li,
                            .rental-terms-section ol li {
                                margin-bottom: 2px !important; /* Reduce list item margin */
                            }
                            /* Try to keep lists from breaking */
                            .disclaimer-section ol,
                            .main-conditions-section ol,
                            .rental-terms-section ol {
                            }
                            /* Ensure the last item of main conditions doesn't get separated from the next section title */
                            .main-conditions-section {
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="agreement-container">
                        <img src="https://i.imgur.com/Tveneh5.png" alt="Print Header" class="print-header-image">

                        <div style="display: flex; justify-content: space-between; align-items: baseline; text-align: center; margin-bottom: 20px;">
                            <div style="flex: 1; text-align: left;"></div>
                            <h1 style="flex: 1; font-size: 16px; color: #4361ee; margin: 0;">
                                ${getTranslation('carRentalAgreementPrint')}
                            </h1>
                            <div style="flex: 1; text-align: right; font-size: 12px;">${createdAtDate}</div>
                        </div>

                        <div class="details-section">
                            <div>
                                <table class="agreement-table">
                                    <thead>
                                        <tr>
                                            <th colspan="2" class="section-title">${getTranslation('vehicleDetailsPrint')}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <th>${getTranslation('vehRegNoPrint')}:</th>
                                            <td>${vehicle.plate_number || getTranslation('n_a')}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('vehicleTypePrint')}:</th>
                                            <td>${make} ${model}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('yearMadePrint')}:</th>
                                            <td>${vehicle.year || getTranslation('n_a')}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('colourPrint')}:</th>
                                            <td>${vehicle.color || getTranslation('n_a')}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('foxCarsRentalPrint')}:</th>
                                            <td>AJMAN RASHIDIYA 2</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('phoneLabelPrint')}:</th>
                                            <td>${getTranslation('n_a')}</td> <!-- Assuming a general contact for FOX CARS RENTAL -->
                                        </tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <table class="agreement-table">
                                <thead>
                                    <tr>
                                        <th colspan="2" class="section-title">${getTranslation('hirerDetailsPrint')}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <th>${getTranslation('hirerNamePrint')}:</th>
                                            <td>${customer.first_name || ''} ${customer.last_name || getTranslation('n_a')}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('nationalityPrint')}:</th>
                                            <td>${customer.nationality || getTranslation('n_a')}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('idNumPrint')}:</th>
                                            <td>${customer.id_number || getTranslation('n_a')}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('contactNoPrint')}:</th>
                                            <td>${customer.phone_number || getTranslation('n_a')}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('addressPrint')}:</th>
                                            <td>${customer.address || getTranslation('n_a')}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('cityLabel')}:</th>
                                            <td>${customer.city || getTranslation('n_a')}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('licenceNoPrint')}:</th>
                                            <td>${customer.driver_license_number || getTranslation('n_a')}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('licExpiryDatePrint')}:</th>
                                            <td>${customer.driver_license_expiry_date || getTranslation('n_a')}</td>
                                        </tr>
                                        <tr>
                                            <th>${getTranslation('licIssuedByPrint')}:</th>
                                            <td>${customer.license_issued_by || getTranslation('n_a')}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <table class="agreement-table full-width">
                            <thead>
                                <tr>
                                    <th colspan="4" class="section-title">${getTranslation('rentalChargePrint')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th>${getTranslation('summerDatePrint')}</th>
                                    <th>${getTranslation('timePrint')}</th>
                                    <th>${getTranslation('kiloMeterPrint')}</th>
                                    <th>${getTranslation('conditionVehPrint')}</th>
                                </tr>
                                <tr>
                                    <td>${rental.from_date ? new Date(rental.from_date).toLocaleDateString() : getTranslation('n_a')}</td>
                                    <td>${getTranslation('n_a')}</td> <!-- Time not available in data -->
                                    <td>${vehicle.odometer_km || getTranslation('n_a')}</td>
                                    <td>${getTranslation('n_a')}</td> <!-- Condition not available in data -->
                                </tr>
                                <tr>
                                    <th>${getTranslation('vehOutPrint')}</th>
                                    <td colspan="3">${rental.from_date ? new Date(rental.from_date).toLocaleDateString() : getTranslation('n_a')}</td>
                                </tr>
                                <tr>
                                    <th>${getTranslation('vehInPrint')}</th>
                                    <td colspan="3">${rental.actual_return_date ? new Date(rental.actual_return_date).toLocaleDateString() : getTranslation('n_a')}</td>
                                </tr>
                                <tr>
                                    <th>${getTranslation('rentalPricePerDayLabel')}:</th>
                                    <td>AED ${rental.rental_price_per_day !== null ? rental.rental_price_per_day.toFixed(2) : '0.00'}</td>
                                    <th>${getTranslation('rentPeriodPrint')}:</th>
                                    <td>${rental.rented_days !== null ? rental.rented_days : getTranslation('n_a')} ${getTranslation('daysPrint')}</td>
                                </tr>
                                <tr>
                                    <th>${getTranslation('totalPriceLabel')}:</th>
                                    <td colspan="3">AED ${rental.total_price !== null ? rental.total_price.toFixed(2) : '0.00'}</td>
                                </tr>
                                <tr>
                                    <th>${getTranslation('paidAmountLabel')}:</th>
                                    <td colspan="3">AED ${rental.paid_amount !== null ? rental.paid_amount.toFixed(2) : '0.00'}</td>
                                </tr>
                                <tr>
                                    <th>${getTranslation('balanceDueLabel')}:</th>
                                    <td colspan="3">AED ${rental.balance !== null ? rental.balance.toFixed(2) : '0.00'}</td>
                                </tr>
                                <tr>
                                    <th>${getTranslation('trafficFinesLabel')}:</th>
                                    <td colspan="3">AED ${rental.traffic_fines !== null ? rental.traffic_fines.toFixed(2) : '0.00'}</td>
                                </tr>
                                <tr>
                                    <th>${getTranslation('carRepairLabel')}:</th>
                                    <td colspan="3">AED ${rental.car_repair !== null ? rental.car_repair.toFixed(2) : '0.00'}</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="disclaimer-section">
                            <h3>${getTranslation('disclaimerTitle')}</h3>
                            <ol>
                                <li><span style="color: red;">${getTranslation('disclaimer1')}</span></li>
                                <li><span style="color: red;">${getTranslation('disclaimer2')}</span></li>
                                <li><span style="color: red;">${getTranslation('disclaimer3')}</span></li>
                                <li><span style="color: red;">${getTranslation('disclaimer4')}</span></li>
                            </ol>
                        </div>

                        <div class="main-conditions-section">
                            <h3>${getTranslation('mainConditionsTitle')}</h3>
                            <ol>
                                <li>${getTranslation('mainCondition1')}</li>
                                <li>${getTranslation('mainCondition2')}</li>
                                <li>${getTranslation('mainCondition3')}</li>
                                <li><span style="color: red;">${getTranslation('mainCondition4')}</span></li>
                                <li>${getTranslation('mainCondition5')}</li>
                                <li>${getTranslation('mainCondition6')}</li>
                                <li>${getTranslation('mainCondition7')}</li>
                                <li>${getTranslation('mainCondition8')}</li>
                            </ol>
                        </div>

                        <div class="rental-terms-section">
                            <h3>${getTranslation('rentalTermsTitle')}</h3>
                            <ol>
                                <li>${getTranslation('rentalTerm1')}</li>
                                <li>${getTranslation('rentalTerm2')}</li>
                                <li>${getTranslation('rentalTerm3')}</li>
                                <li>${getTranslation('rentalTerm4')}
                                    <ol>
                                        <li>${getTranslation('rentalTerm4a')}</li>
                                        <li>${getTranslation('rentalTerm4b')}</li>
                                        <li>${getTranslation('rentalTerm4c')}</li>
                                        <li>${getTranslation('rentalTerm4d')}</li>
                                        <li>${getTranslation('rentalTerm4e')}</li>
                                        <li>${getTranslation('rentalTerm4f')}</li>
                                        <li>${getTranslation('rentalTerm4g')}</li>
                                    </ol>
                                </li>
                                <li>${getTranslation('rentalTerm5')}
                                    <ol>
                                        <li>${getTranslation('rentalTerm5a')}</li>
                                        <li>${getTranslation('rentalTerm5b')}</li>
                                        <li>${getTranslation('rentalTerm5c')}</li>
                                    </ol>
                                </li>
                                <li>${getTranslation('rentalTerm6')}
                                    <ol>
                                        <li>${getTranslation('rentalTerm6a')}</li>
                                    </ol>
                                </li>
                                <li>${getTranslation('rentalTerm7')}
                                    <ol>
                                        <li>${getTranslation('rentalTerm7a')}</li>
                                        <li>${getTranslation('rentalTerm7b')}</li>
                                        <li>${getTranslation('rentalTerm7c')}</li>
                                    </ol>
                                </li>
                                <li>${getTranslation('rentalTerm8')}</li>
                                <li>${getTranslation('rentalTerm9')}</li>
                                <li><span style="color: red;">${getTranslation('rentalTerm10')}</span></li>
                                <li>${getTranslation('rentalTerm11')}</li>
                                <li>${getTranslation('rentalTerm12')}</li>
                                <li>${getTranslation('rentalTerm13')}</li>
                                <li>${getTranslation('rentalTerm14')}</li>
                                <li>${getTranslation('rentalTerm15')}</li>
                                <li>${getTranslation('rentalTerm16')}</li>
                                <li>${getTranslation('rentalTerm17')}</li>
                                <li>${getTranslation('rentalTerm18')}</li>
                                <li>${getTranslation('rentalTerm19')}</li>
                                <li>${getTranslation('rentalTerm20')}</li>
                                <li>${getTranslation('rentalTerm21')}</li>
                                <li>${getTranslation('rentalTerm22')}</li>
                                <li>${getTranslation('rentalTerm23')}</li>
                                <li>${getTranslation('rentalTerm24')}</li>
                                <li>${getTranslation('rentalTerm25')}</li>
                                <li>${getTranslation('rentalTerm26')}</li>
                                <li>${getTranslation('rentalTerm27')}</li>
                                <li>${getTranslation('rentalTerm28')}</li>
                            </ol>
                        </div>

                        <div class="signature-section">
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <p data-i18n-key="hirerSignature">${getTranslation('hirerSignature')}</p>
                            </div>
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <p data-i18n-key="sponsorSignature">${getTranslation('sponsorSignature')}</p>
                            </div>
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <p data-i18n-key="officeInchargeSignature">${getTranslation('officeInchargeSignature')}</p>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }
    </script>
</body>
</html>
