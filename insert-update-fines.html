<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Traffic Fines PDF - Fox Car Rental Admin</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- PDF.js CDN -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.mjs" type="module"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Custom styles for the background gradient */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #5680E9, #84CEEB, #5AB9EA, #C1C8E4, #8860D0);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            background-attachment: fixed;
            min-height: 100vh; /* Ensure body takes full height for gradient */
            margin: 0; /* Remove default body margin */
            padding: 0; /* Remove default body padding */
            color: #333; /* Default text color */
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Define custom colors from the image */
        .bg-custom-blue-dark { background-color: #5680E9; }
        .bg-custom-blue-light { background-color: #84CEEB; }
        .bg-custom-cyan { background-color: #5AB9EA; }
        .bg-custom-light-purple { background-color: #C1C8E4; }
        .bg-custom-purple { background-color: #8860D0; }

        .text-custom-blue-dark { color: #5680E9; }
        .text-custom-blue-light { color: #84CEEB; }
        .text-custom-cyan { color: #5AB9EA; }
        .text-custom-light-purple { color: #C1C8E4; }
        .text-custom-purple { color: #8860D0; }

        .border-custom-blue-dark { border-color: #5680E9; }
        .border-custom-blue-light { border-color: #84CEEB; }
        .border-custom-cyan { border-color: #5AB9EA; }
        .border-custom-light-purple { border-color: #C1C8E4; }
        .border-custom-purple { border-color: #8860D0; }

        /* Main content area - adjusted for no sidebar */
        #main-content {
            padding: 1rem; /* Adjust padding as needed for overall layout */
            margin-left: 0; /* No margin from sidebar */
            padding-top: 1rem; /* Reset padding-top as header is not fixed anymore within this document */
        }

        /* Top Header - adjusted for no sidebar */
        #main-header {
            position: static; /* No longer fixed within this document */
            background-color: transparent; /* Make header background transparent */
            box-shadow: none; /* Remove any shadows */
            padding: 1rem; /* Retain padding for spacing */
            margin-bottom: 1.5rem; /* Ensure spacing below header */
        }

        /* File Upload specific styles */
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            background-color: #e9ecef;
            border-color: #8860D0;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8860D0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex min-h-screen text-gray-800">

    <!-- Main Content Area -->
    <div id="main-content" class="flex-1 flex flex-col p-4 sm:p-6 lg:p-8 overflow-y-auto">
        <!-- Top Nav for Desktop -->
        <header id="main-header" class="p-4 flex items-center justify-between transition-all duration-300 ease-in-out">
             <div class="flex items-center">
                <h2 class="text-2xl font-bold text-gray-800">Traffic Fines Uploader</h2>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-500">Last updated: <span id="last-updated">...</span></span>
                 <div class="flex items-center space-x-2">
                     <i class="fas fa-user-circle text-2xl text-gray-500"></i>
                     <span id="user-email" class="text-sm">admin@foxcarrental.com</span>
                 </div>
                 <span id="user-id-display" class="text-sm text-gray-500 hidden"></span>
            </div>
        </header>

        <!-- Traffic Fine Uploader Content -->
        <div class="w-full max-w-7xl bg-white p-8 rounded-xl shadow-lg mt-6">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Traffic Fine Uploader</h1>
                <p class="text-gray-500 mt-2">Upload a PDF of traffic fines.</p>
            </div>

            <!-- File Upload Form -->
            <form id="upload-form">
                <div id="drop-zone" class="drop-zone">
                    <i class="fas fa-cloud-upload-alt text-4xl text-red-600 mb-3"></i> <!-- Changed icon color to red-600 -->
                    <p class="text-gray-600">Drag & drop your PDF here, or click to select a file.</p>
                    <input type="file" id="pdf-file" class="hidden" accept="application/pdf">
                </div>
                <div id="file-name-display" class="mt-4 text-center text-gray-700 font-medium"></div>
                <button type="submit" id="submit-button" class="w-full bg-purple-600 text-white py-3 rounded-lg mt-6 font-semibold hover:bg-purple-700 transition-colors duration-300 flex items-center justify-center" disabled>
                    <i class="fas fa-database mr-2"></i>
                    <span>Upload and Save to Supabase</span>
                </button>
            </form>

            <!-- Progress and Results -->
            <div id="progress-container" class="mt-6 text-center hidden">
                <div class="loader inline-block"></div>
                <p id="progress-text" class="mt-2 text-gray-600 font-medium">Processing...</p>
            </div>

            <!-- Results Table -->
            <div id="results-container" class="mt-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Extracted Fines</h3>
                <div class="max-h-96 overflow-y-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fine #</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plate #</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Amount</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Discount</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount After Discount</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Late Fees</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for notifications -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center">
            <h3 id="notification-title" class="text-xl font-bold mb-4">Notification</h3>
            <p id="notification-message" class="text-gray-700 mb-6"></p>
            <button id="notification-close-button" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">Close</button>
        </div>
    </div>

    <script type="module">
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://yzwfldypkwqndxjchgit.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6d2ZsZHlwa3dxbmR4amNoZ2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzMjA0OTUsImV4cCI6MjA2NDg5NjQ5NX0.i3HOii7L9mJ-cBZ2us3TRmS0-GI9bylHuLe9INAu4zY';
        
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- PDF.js Worker ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://mozilla.github.io/pdf.js/build/pdf.worker.mjs`;

        // --- DOM Elements ---
        const ui = {
            mainContent: document.getElementById('main-content'),
            mainHeader: document.getElementById('main-header'),
            userEmail: document.getElementById('user-email'),
            userIdDisplay: document.getElementById('user-id-display'),
            lastUpdated: document.getElementById('last-updated'),
            
            // Traffic Fine Uploader specific elements
            form: document.getElementById('upload-form'),
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('pdf-file'),
            fileNameDisplay: document.getElementById('file-name-display'),
            submitButton: document.getElementById('submit-button'),
            progressContainer: document.getElementById('progress-container'),
            progressText: document.getElementById('progress-text'),
            resultsContainer: document.getElementById('results-container'),
            resultsTableBody: document.getElementById('results-table-body'),
            notificationModal: document.getElementById('notification-modal'),
            notificationTitle: document.getElementById('notification-title'),
            notificationMessage: document.getElementById('notification-message'),
            notificationCloseButton: document.getElementById('notification-close-button'),
        };

        let selectedFile = null;

        // --- Modal Logic ---
        function showMessage(message, title = "Notification") {
            ui.notificationTitle.textContent = title;
            ui.notificationMessage.textContent = message;
            ui.notificationModal.classList.remove('hidden');
        }
        ui.notificationCloseButton.addEventListener('click', () => ui.notificationModal.classList.add('hidden'));

        // --- Drag and Drop Logic ---
        ui.dropZone.addEventListener('click', () => ui.fileInput.click());
        ui.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); ui.dropZone.classList.add('dragover'); });
        ui.dropZone.addEventListener('dragleave', () => ui.dropZone.classList.remove('dragover'));
        ui.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            ui.dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handleFileSelect(files[0]);
            }
        });
        ui.fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            selectedFile = file;
            ui.fileNameDisplay.textContent = `Selected file: ${file.name}`;
            ui.submitButton.disabled = false;
        }

        // --- Main Form Submission Logic ---
        ui.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedFile) {
                showMessage("Please select a PDF file first.", "Error");
                return;
            }

            ui.submitButton.disabled = true;
            ui.progressContainer.classList.remove('hidden');
            ui.progressText.textContent = 'Reading PDF file...';
            ui.resultsContainer.classList.add('hidden');
            ui.resultsTableBody.innerHTML = '';

            try {
                const fileReader = new FileReader();
                fileReader.onload = async function() {
                    const typedarray = new Uint8Array(this.result);
                    
                    ui.progressText.textContent = 'Parsing PDF content...';
                    const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                    let rawText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        rawText += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    const fullText = rawText.replace(/\s+/g, ' ').trim();
                    
                    console.log("Full text extracted from PDF:", fullText);

                    ui.progressText.textContent = 'Extracting fine records...';
                    const finesFromPdf = parseFinesFromText(fullText);

                    // Display message about fines found in PDF
                    if (finesFromPdf.length > 0) {
                        showMessage(`Successfully extracted ${finesFromPdf.length} fine(s) from the PDF.`, "Extraction Complete");
                    } else {
                        showMessage("No valid fine records could be extracted from the PDF. All existing fines not found in this PDF will be marked as paid.", "Extraction Warning");
                    }
                    
                    displayExtractedFines(finesFromPdf); // Display extracted fines regardless of DB status

                    ui.progressText.textContent = `Processing ${finesFromPdf.length} fines and updating database...`;
                    
                    // 1. Fetch all existing fines from the database
                    const { data: existingFines, error: fetchError } = await supabaseClient
                        .from('traffic_fines')
                        .select('fine_number, fine_status');

                    if (fetchError) throw fetchError;

                    const finesInPdfNumbers = new Set(finesFromPdf.map(f => f.fine_number));
                    const existingFineNumbers = new Set(existingFines.map(f => f.fine_number));

                    // 2. Process fines extracted from PDF (Insert or Update to unpaid)
                    let newFinesCount = 0;
                    let updatedFinesCount = 0;
                    let paidByPdfCount = 0; // Fines in DB that are NOT in PDF, marked paid

                    for (const fine of finesFromPdf) {
                        const { data, error } = await supabaseClient
                            .from('traffic_fines')
                            .upsert({
                                fine_number: fine.fine_number,
                                fine_date: fine.fine_date,
                                plate_number: fine.plate_number,
                                location: fine.location,
                                total_amount: fine.total_amount,
                                discount_percent: fine.discount_percent,
                                amount_after_discount: fine.amount_after_discount,
                                late_fees: fine.late_fees,
                                fine_status: false // Explicitly set to unpaid if found in PDF
                            }, {
                                onConflict: 'fine_number', // Conflict on fine_number to update existing
                                ignoreDuplicates: false // Ensure update happens if conflict
                            });

                        if (error) {
                            console.error(`Error upserting fine ${fine.fine_number}:`, error.message);
                            // Log error but continue processing other fines
                        } else {
                            if (existingFineNumbers.has(fine.fine_number)) {
                                updatedFinesCount++;
                            } else {
                                newFinesCount++;
                            }
                        }
                    }

                    // 3. Mark existing fines as paid if they are NOT in the current PDF
                    for (const existingFine of existingFines) {
                        if (!finesInPdfNumbers.has(existingFine.fine_number) && existingFine.fine_status === false) {
                            // Only update if it's currently unpaid and not in the new PDF
                            const { data, error } = await supabaseClient
                                .from('traffic_fines')
                                .update({ fine_status: true })
                                .eq('fine_number', existingFine.fine_number);

                            if (error) {
                                console.error(`Error marking fine ${existingFine.fine_number} as paid:`, error.message);
                            } else {
                                paidByPdfCount++;
                            }
                        }
                    }

                    let summaryMessage = `Upload and database update complete.`;
                    if (newFinesCount > 0) summaryMessage += ` ${newFinesCount} new fine(s) added.`;
                    if (updatedFinesCount > 0) summaryMessage += ` ${updatedFinesCount} existing fine(s) updated to unpaid.`;
                    if (paidByPdfCount > 0) summaryMessage += ` ${paidByPdfCount} fine(s) marked as paid (not found in current PDF).`;
                    if (newFinesCount === 0 && updatedFinesCount === 0 && paidByPdfCount === 0) {
                        summaryMessage = "No changes detected or no new fines found in the PDF to process.";
                    }

                    showMessage(summaryMessage, "Process Complete");
                    resetUI();
                };
                fileReader.readAsArrayBuffer(selectedFile);
            } catch (error) {
                console.error("An error occurred:", error);
                showMessage(`An error occurred during processing: ${error.message}`, "Error");
                resetUI();
            }
        });

        function resetUI() {
            ui.progressContainer.classList.add('hidden');
            ui.submitButton.disabled = false;
            if (!selectedFile) ui.submitButton.disabled = true;
        }
        
        function displayExtractedFines(fines) {
            ui.resultsContainer.classList.remove('hidden');
            ui.resultsTableBody.innerHTML = '';
            if (fines.length === 0) {
                ui.resultsTableBody.innerHTML = `<tr><td colspan="9" class="px-4 py-2 text-center text-gray-500">No fines extracted from this PDF.</td></tr>`;
                return;
            }
            fines.forEach(fine => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${fine.fine_number}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${fine.fine_date}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${fine.plate_number}</td>
                    <td class="px-4 py-2 whitespace-normal text-sm text-gray-700">${fine.location}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${fine.total_amount}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${fine.discount_percent}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${fine.amount_after_discount}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${fine.late_fees}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                            Unpaid (New/Found in PDF)
                        </span>
                    </td>
                `;
                ui.resultsTableBody.appendChild(row);
            });
        }

        /**
         * Parses the extracted text from the PDF to find fine records.
         * This function is tailored to the structure observed in the sample PDF.
         * It now processes the full text as a single, normalized string.
         * @param {string} text - The full text extracted from the PDF.
         * @returns {Array<Object>} An array of fine objects.
         */
        function parseFinesFromText(text) {
            const fines = [];

            // Updated regex:
            // - Fine No. is now (\\d+) to capture any length of digits.
            // - Location and Plate No. are combined into a single (.*?) group (Group 3).
            // - The parsing for Location and Plate No. is done in a second step within the loop.
            const fineRegex = new RegExp(
                `(\\d+)\\s+` + // Group 1: Fine No. (any digits)
                `(\\d{2}-\\d{2}-\\d{4})\\s+` + // Group 2: Date
                `(.*?)\\s+` + // Group 3: Combined Location and Plate No. (non-greedy, matches until next pattern)
                `(\\d+)\\s+` + // Group 4: Total Amount
                `(\\d+\\s*%)` + // Group 5: Discount (%)
                `\\s+` +
                `(\\d+)\\s+` + // Group 6: Amount after Discount
                `(\\d+\\s*AED)`, // Group 7: Late Fees
                'g'
            );

            const skipPatterns = [
                "TRAFFIC PROFILE FINES",
                "Traffic Code Number",
                "You have \\d+ fine\\(s\\)",
                "Fine No.", "Date", "Fine Place", "Plate No.", "Total Amount", "Discount \\(%\\)", "Amount after Discount", "Late Charges",
                "Tickets can't be paid from the web.",
                "AED \\s*AED \\(Discount\\) Total Amount",
                "Selected for e-payment",
                "Fee"
            ];

            let match;
            while ((match = fineRegex.exec(text)) !== null) {
                try {
                    // Check if the full matched string contains any skip patterns
                    let isHeaderOrFooter = false;
                    for (const pattern of skipPatterns) {
                        if (new RegExp(pattern).test(match[0])) {
                            isHeaderOrooter = true;
                            break;
                        }
                    }
                    if (isHeaderOrFooter) {
                        console.log("Skipping header/footer match:", match[0]);
                        continue;
                    }

                    const fine_number_raw = match[1].trim();
                    const date_raw = match[2].trim();
                    const total_amount_raw = match[4].trim();
                    const discount_percent_raw = match[5].trim();
                    const amount_after_discount_raw = match[6].trim();
                    const late_fees_raw = match[7].trim();

                    const dateParts = date_raw.split('-');
                    let formattedDate = null;
                    if (dateParts.length === 3) {
                        formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                    } else {
                        console.warn(`Could not parse date: "${date_raw}". Keeping original format.`);
                        formattedDate = date_raw;
                    }

                    // --- New logic for parsing Location and Plate Number ---
                    let combinedLocPlate = match[3].trim();
                    let plate_number = 'N/A';
                    let location = combinedLocPlate;

                    // Attempt to extract plate number (4-6 digits) from the end of the combined string
                    const plateNumberInCombinedRegex = /(\d{4,6})(?:\s*)$/; // Matches 4-6 digits at the end
                    const plateMatch = combinedLocPlate.match(plateNumberInCombinedRegex);

                    if (plateMatch) {
                        plate_number = plateMatch[1];
                        // Remove the extracted plate number from the location string
                        location = combinedLocPlate.replace(plateNumberInCombinedRegex, '').trim();
                    }
                    
                    // If location is empty after removing plate, or was initially empty, set to 'N/A'
                    if (location === '') {
                        location = 'N/A';
                    }
                    // --- End new logic ---

                    const fine = {
                        fine_number: fine_number_raw,
                        fine_date: formattedDate,
                        plate_number: plate_number, // Use the newly parsed plate_number
                        location: location,         // Use the newly parsed location
                        total_amount: parseFloat(total_amount_raw) || 0,
                        discount_percent: discount_percent_raw,
                        amount_after_discount: parseFloat(amount_after_discount_raw) || 0,
                        late_fees: late_fees_raw
                    };
                    fines.push(fine);
                } catch (e) {
                    console.warn("Error parsing a matched fine record. Skipping:", match[0], e);
                }
            }
            console.log(`Found ${fines.length} potential fines.`, fines);
            return fines;
        }

        // --- Initial Load ---
        window.addEventListener('DOMContentLoaded', () => {
            // Update last updated time
            ui.lastUpdated.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        });
    </script>
</body>
</html>
